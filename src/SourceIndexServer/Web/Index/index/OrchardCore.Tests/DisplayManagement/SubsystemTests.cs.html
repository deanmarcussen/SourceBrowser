<!DOCTYPE html>
<html><head><title>SubsystemTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(121);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Tests/DisplayManagement/SubsystemTests.cs" target="_top">DisplayManagement\SubsystemTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Tests" target="_top">test\OrchardCore.Tests\OrchardCore.Tests.csproj</a> (OrchardCore.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">//using Microsoft.AspNetCore.Html;</span>
<span class="c">//using Microsoft.AspNetCore.Http;</span>
<span class="c">//using Microsoft.AspNetCore.Mvc.Rendering;</span>
<span class="c">//using Microsoft.Extensions.Caching.Memory;</span>
<span class="c">//using Microsoft.Extensions.DependencyInjection;</span>
<span class="c">//using Microsoft.Extensions.Logging;</span>
<span class="c">//using OrchardCore.DisplayManagement;</span>
<span class="c">//using OrchardCore.DisplayManagement.Descriptors;</span>
<span class="c">//using OrchardCore.DisplayManagement.Descriptors.ShapeAttributeStrategy;</span>
<span class="c">//using OrchardCore.DisplayManagement.Implementation;</span>
<span class="c">//using OrchardCore.DisplayManagement.Shapes;</span>
<span class="c">//using OrchardCore.DisplayManagement.Theming;</span>
<span class="c">//using OrchardCore.Environment.Extensions;</span>
<span class="c">//using OrchardCore.Environment.Extensions.Features;</span>
<span class="c">//using OrchardCore.Tests.Stubs;</span>
<span class="c">//using System;</span>
<span class="c">//using System.Collections.Generic;</span>
<span class="c">//using System.IO;</span>
<span class="c">//using System.Linq.Expressions;</span>
<span class="c">//using System.Text.Encodings.Web;</span>
<span class="c">//using System.Threading.Tasks;</span>
<span class="c">//using Xunit;</span>
 
<span class="c">//namespace OrchardCore.Tests.DisplayManagement</span>
<span class="c">//{</span>
<span class="c">//    public class SubsystemTests</span>
<span class="c">//    {</span>
<span class="c">//        IServiceProvider _serviceProvider;</span>
 
<span class="c">//        public SubsystemTests()</span>
<span class="c">//        {</span>
<span class="c">//            IServiceCollection serviceCollection = new ServiceCollection();</span>
 
<span class="c">//            var testFeature = new Feature</span>
<span class="c">//            {</span>
<span class="c">//                Descriptor = new FeatureDescriptor</span>
<span class="c">//                {</span>
<span class="c">//                    Id = &quot;Testing&quot;,</span>
<span class="c">//                    Extension = new ExtensionDescriptor</span>
<span class="c">//                    {</span>
<span class="c">//                        Id = &quot;Testing&quot;,</span>
<span class="c">//                        ExtensionType = DefaultExtensionTypes.Module,</span>
<span class="c">//                    }</span>
<span class="c">//                }</span>
<span class="c">//            };</span>
 
<span class="c">//            serviceCollection.AddScoped&lt;IShapeTableProvider, ShapeAttributeBindingStrategy&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;ILogger&lt;DefaultShapeTableManager&gt;, NullLogger&lt;DefaultShapeTableManager&gt;&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;ILogger&lt;DefaultIHtmlDisplay&gt;, NullLogger&lt;DefaultIHtmlDisplay&gt;&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IFeatureManager, StubFeatureManager&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IHtmlDisplay, DefaultIHtmlDisplay&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IShapeFactory, DefaultShapeFactory&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IDisplayHelperFactory, DisplayHelperFactory&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IShapeTableManager, DefaultShapeTableManager&gt;();</span>
 
<span class="c">//            serviceCollection.AddScoped&lt;IHttpContextAccessor, StubHttpContextAccessor&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;IExtensionManager, StubExtensionManager&gt;();</span>
<span class="c">//            serviceCollection.AddSingleton&lt;ITypeFeatureProvider, TypeFeatureProvider&gt;();</span>
<span class="c">//            serviceCollection.AddSingleton&lt;IThemeManager&gt;(x =&gt;</span>
<span class="c">//                new MockThemeManager(testFeature.Descriptor.Extension)</span>
 
<span class="c">//            );</span>
 
<span class="c">//            serviceCollection.AddSingleton&lt;IMemoryCache&gt;(x =&gt; new MemoryCache(new MemoryCacheOptions()));</span>
 
<span class="c">//            serviceCollection.AddSingleton(new SimpleShapes());</span>
 
<span class="c">//            _serviceProvider = serviceCollection.BuildServiceProvider();</span>
<span class="c">//        }</span>
 
<span class="c">//        public class SimpleShapes</span>
<span class="c">//        {</span>
<span class="c">//            [Shape]</span>
<span class="c">//            public IHtmlContent Something()</span>
<span class="c">//            {</span>
<span class="c">//                return new HtmlString(&quot;&lt;br/&gt;&quot;);</span>
<span class="c">//            }</span>
 
<span class="c">//            [Shape]</span>
<span class="c">//            public IHtmlContent Pager()</span>
<span class="c">//            {</span>
<span class="c">//                return new HtmlString(&quot;&lt;div&gt;hello&lt;/div&gt;&quot;);</span>
<span class="c">//            }</span>
<span class="c">//        }</span>
 
<span class="c">//        [Fact(Skip = &quot;This test (or the underlying code) must be reworked.&quot;)]</span>
<span class="c">//        public async Task RenderingSomething()</span>
<span class="c">//        {</span>
<span class="c">//            dynamic displayHelperFactory = _serviceProvider.GetService&lt;IDisplayHelperFactory&gt;().CreateHelper(new ViewContext());</span>
<span class="c">//            dynamic shapeHelperFactory = _serviceProvider.GetService&lt;IShapeFactory&gt;();</span>
 
<span class="c">//            var result1 = displayHelperFactory.Something();</span>
<span class="c">//            var result2 = await ((DisplayHelper)displayHelperFactory).ShapeExecuteAsync(shapeHelperFactory.Pager());</span>
<span class="c">//            var result3 = await ((DisplayHelper)displayHelperFactory).ShapeExecuteAsync((Shape)shapeHelperFactory.Pager());</span>
 
<span class="c">//            displayHelperFactory(shapeHelperFactory.Pager());</span>
 
<span class="c">//            Assert.Equal(&quot;&lt;br/&gt;&quot;, HtmlContentUtilities.HtmlContentToString((IHtmlContent)result1));</span>
<span class="c">//            Assert.Equal(&quot;&lt;div&gt;hello&lt;/div&gt;&quot;, HtmlContentUtilities.HtmlContentToString((IHtmlContent)result2));</span>
<span class="c">//            Assert.Equal(&quot;&lt;div&gt;hello&lt;/div&gt;&quot;, HtmlContentUtilities.HtmlContentToString(result3));</span>
<span class="c">//        }</span>
<span class="c">//    }</span>
 
<span class="c">//    public class HtmlContentUtilities</span>
<span class="c">//    {</span>
<span class="c">//        public static string HtmlContentToString(IHtmlContent content, HtmlEncoder encoder = null)</span>
<span class="c">//        {</span>
<span class="c">//            if (encoder == null)</span>
<span class="c">//            {</span>
<span class="c">//                encoder = HtmlEncoder.Default;</span>
<span class="c">//            }</span>
 
<span class="c">//            using (var writer = new StringWriter())</span>
<span class="c">//            {</span>
<span class="c">//                content.WriteTo(writer, encoder);</span>
<span class="c">//                return writer.ToString();</span>
<span class="c">//            }</span>
<span class="c">//        }</span>
<span class="c">//    }</span>
<span class="c">//}</span>
</pre></td></tr></table></div></body></html>
