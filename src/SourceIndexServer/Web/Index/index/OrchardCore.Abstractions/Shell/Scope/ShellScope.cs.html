<!DOCTYPE html>
<html><head><title>ShellScope.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(526);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Abstractions/Shell/Scope/ShellScope.cs" target="_top">Shell\Scope\ShellScope.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Abstractions" target="_top">src\OrchardCore\OrchardCore.Abstractions\OrchardCore.Abstractions.csproj</a> (OrchardCore.Abstractions)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Logging</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Environment</span>.<span class="i n">Cache</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Environment</span>.<span class="i n">Shell</span>.<span class="i n">Builders</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Environment</span>.<span class="i n">Shell</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Modules</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Environment</span>.<span class="i n">Shell</span>.<span class="i n">Scope</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Custom &#39;IServiceScope&#39; managing the shell state and the execution flow.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="6bc229032c2ec619" href="../../R/6bc229032c2ec619.html" target="n" data-glyph="0,0" class="t t">ShellScope</a> : <span class="t t">IServiceScope</span>
    {
        <b>private static readonly</b> <span class="t t">AsyncLocal</span>&lt;<a href="#285d9be10993d302" class="t t">ShellScopeHolder</a>&gt; <a id="0139b4efe0877151" href="../../R/0139b4efe0877151.html" target="n" data-glyph="46,1" class="i field">_current</a> = <b>new</b> <span class="t constructor">AsyncLocal</span>&lt;<a href="#285d9be10993d302" class="t t">ShellScopeHolder</a>&gt;();
 
        <b>private readonly</b> <span class="t t">IServiceScope</span> <a id="c06ae96180039928" href="../../R/c06ae96180039928.html" target="n" data-glyph="46,1" class="i field">_serviceScope</a>;
        <b>private readonly</b> <span class="t t">Dictionary</span>&lt;<b>object</b>, <b>object</b>&gt; <a id="8871940da42b4ab7" href="../../R/8871940da42b4ab7.html" target="n" data-glyph="46,1" class="i field">_items</a> = <b>new</b> <span class="t constructor">Dictionary</span>&lt;<b>object</b>, <b>object</b>&gt;();
        <b>private readonly</b> <span class="t t">List</span>&lt;<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt; <a id="960255ab164a2c64" href="../../R/960255ab164a2c64.html" target="n" data-glyph="46,1" class="i field">_beforeDispose</a> = <b>new</b> <span class="t constructor">List</span>&lt;<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt;();
        <b>private readonly</b> <span class="t t">HashSet</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <a id="3f2d1210e5b800aa" href="../../R/3f2d1210e5b800aa.html" target="n" data-glyph="46,1" class="i field">_deferredSignals</a> = <b>new</b> <span class="t constructor">HashSet</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;();
        <b>private readonly</b> <span class="t t">List</span>&lt;<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt; <a id="0274d6ea379d6a32" href="../../R/0274d6ea379d6a32.html" target="n" data-glyph="46,1" class="i field">_deferredTasks</a> = <b>new</b> <span class="t constructor">List</span>&lt;<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt;();
        <b>private readonly</b> <span class="t t">List</span>&lt;<a href="@1@System.Runtime/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt; <a id="b265cbb7e79773a9" href="../../R/b265cbb7e79773a9.html" target="n" data-glyph="46,1" class="i field">_exceptionHandlers</a> = <b>new</b> <span class="t constructor">List</span>&lt;<a href="@1@System.Runtime/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt;&gt;();
 
        <b>private bool</b> <a id="6c1dc07580c9e532" href="../../R/6c1dc07580c9e532.html" target="n" data-glyph="46,1" class="i field">_serviceScopeOnly</a>;
        <b>private bool</b> <a id="920684b5864224a5" href="../../R/920684b5864224a5.html" target="n" data-glyph="46,1" class="i field">_shellTerminated</a>;
        <b>private bool</b> <a id="adb0a2602a6d8c40" href="../../R/adb0a2602a6d8c40.html" target="n" data-glyph="46,1" class="i field">_terminated</a>;
        <b>private bool</b> <a id="8e99716a5b0f5548" href="../../R/8e99716a5b0f5548.html" target="n" data-glyph="46,1" class="i field">_disposed</a>;
 
        <b>public</b> <a id="8b00c66b241e54bb" href="../../R/8b00c66b241e54bb.html" target="n" data-glyph="72,1" class="t constructor">ShellScope</a>(<a href="../Builders/ShellContext.cs.html#0220d010e7ac04ce" class="t t">ShellContext</a> <span id="r0 rd" class="r0 r">shellContext</span>)
        {
            <span class="c">// Prevent the context from being disposed until the end of the scope</span>
            <span class="t t">Interlocked</span>.<span class="i method">Increment</span>(<b>ref</b> <span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#4113c3000d657c1f" class="i field">_refCount</a>);
            <a href="#e31ecdd9861b326a" class="i property">ShellContext</a> = <span class="r0 r">shellContext</span>;
 
            <span class="c">// The service provider is null if we try to create</span>
            <span class="c">// a scope on a disabled shell or already disposed.</span>
            <b>if</b> (<span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#14806dab63c4713f" class="i property">ServiceProvider</a> == <b>null</b>)
            {
                <span class="c">// Keep the counter clean before failing.</span>
                <span class="t t">Interlocked</span>.<span class="i method">Decrement</span>(<b>ref</b> <span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#4113c3000d657c1f" class="i field">_refCount</a>);
 
                <b>throw</b> <b>new</b> <a href="@1@System.Runtime/A.html#b50c77b2acc23eca" class="t constructor">ArgumentNullException</a>(<b>nameof</b>(<span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#14806dab63c4713f" class="i property">ServiceProvider</a>),
                    <span class="s">$&quot;</span><span class="s">Can&#39;t resolve a scope on tenant: </span>{<span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>.<a href="../ShellSettings.cs.html#7248e6f40dfe7c7f" class="i property">Name</a>}<span class="s">&quot;</span>);
            }
 
            <a href="#c06ae96180039928" class="i field">_serviceScope</a> = <span class="r0 r">shellContext</span>.<a href="../Builders/ShellContext.cs.html#14806dab63c4713f" class="i property">ServiceProvider</a>.<span class="i method">CreateScope</span>();
            <a href="#55a88f718c8bf968" class="i property">ServiceProvider</a> = <a href="#c06ae96180039928" class="i field">_serviceScope</a>.<span class="i property">ServiceProvider</span>;
        }
 
        <b>public</b> <a href="../Builders/ShellContext.cs.html#0220d010e7ac04ce" class="t t">ShellContext</a> <a id="e31ecdd9861b326a" href="../../R/e31ecdd9861b326a.html" target="n" data-glyph="102,1" class="i property">ShellContext</a> { <b>get</b>; }
        <b>public</b> <span class="t t">IServiceProvider</span> <a id="55a88f718c8bf968" href="../../R/55a88f718c8bf968.html" target="n" data-glyph="102,1" class="i property">ServiceProvider</a> { <b>get</b>; }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieve the &#39;ShellContext&#39; of the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <a href="../Builders/ShellContext.cs.html#0220d010e7ac04ce" class="t t">ShellContext</a> <a id="37dee1e883ce38c6" href="../../R/37dee1e883ce38c6.html" target="n" data-glyph="102,1" class="i property">Context</a> =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieve the &#39;IServiceProvider&#39; of the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="t t">IServiceProvider</span> <a id="996415403af48612" href="../../R/996415403af48612.html" target="n" data-glyph="102,1" class="i property">Services</a> =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#55a88f718c8bf968" class="i property">ServiceProvider</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Retrieve the current shell scope from the async flow.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <a href="#6bc229032c2ec619" class="t t">ShellScope</a> <a id="09229755528dc5b0" href="../../R/09229755528dc5b0.html" target="n" data-glyph="102,1" class="i property">Current</a> =&gt; <a href="#0139b4efe0877151" class="i field">_current</a>.<span class="i property">Value</span>?.<a href="#80d144dff5604a13" class="i field">Scope</a>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets a shared item to the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="62d3bc6dad5bb8bd" href="../../R/62d3bc6dad5bb8bd.html" target="n" data-glyph="72,1" class="i method">Set</a>(<b>object</b> <span id="r1 rd" class="r1 r">key</span>, <b>object</b> <span id="r2 rd" class="r2 r">value</span>)
        {
            <b>if</b> (<a href="#09229755528dc5b0" class="i property">Current</a> != <b>null</b>)
            {
                <a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>[<span class="r1 r">key</span>] = <span class="r2 r">value</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a shared item from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static object</b> <a id="3006343eb6d669bd" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Get</a>(<b>object</b> <span id="r3 rd" class="r3 r">key</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a> == <b>null</b> ? <b>null</b> : <a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>.<span class="i method">TryGetValue</span>(<span class="r3 r">key</span>, <b>out</b> <a href="@1@System.Runtime/A.html#d9262ceecc1719ab" class="k">var</a> <span id="r4 rd" class="r4 r">value</span>) ? <span class="r4 r">value</span> : <b>null</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a shared item of a given type from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r5 r t">T</span> <a id="d3738dfc1c0528cf" href="../../R/d3738dfc1c0528cf.html" target="n" data-glyph="72,1" class="i method">Get</a>&lt;<span id="r5 rd t" class="r5 r t">T</span>&gt;(<b>object</b> <span id="r6 rd" class="r6 r">key</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a> == <b>null</b> ? <b>default</b> : <a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>.<span class="i method">TryGetValue</span>(<span class="r6 r">key</span>, <b>out</b> <a href="@1@System.Runtime/A.html#d9262ceecc1719ab" class="k">var</a> <span id="r7 rd" class="r7 r">value</span>) ? <span class="r7 r">value</span> <b>is</b> <span class="r5 r t">T</span> <span id="r8 rd" class="r8 r">item</span> ? <span class="r8 r">item</span> : <b>default</b> : <b>default</b>;
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets (or creates) a shared item of a given type from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r9 r t">T</span> <a id="95c8703f82ba957c" href="../../R/95c8703f82ba957c.html" target="n" data-glyph="72,1" class="i method">GetOrCreate</a>&lt;<span id="r9 rd t" class="r9 r t">T</span>&gt;(<b>object</b> <span id="r10 rd" class="r10 r">key</span>, <a href="@1@System.Runtime/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<span class="r9 r t">T</span>&gt; <span id="r11 rd" class="r11 r">factory</span>)
        {
            <b>if</b> (<a href="#09229755528dc5b0" class="i property">Current</a> == <b>null</b>)
            {
                <b>return</b> <span class="r11 r">factory</span>();
            }
 
            <b>if</b> (!<a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>.<span class="i method">TryGetValue</span>(<span class="r10 r">key</span>, <b>out</b> <a href="@1@System.Runtime/A.html#d9262ceecc1719ab" class="k">var</a> <span id="r12 rd" class="r12 r">value</span>) || !(<span class="r12 r">value</span> <b>is</b> <span class="r9 r t">T</span> <span id="r13 rd" class="r13 r">item</span>))
            {
                <a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>[<span class="r10 r">key</span>] = <span class="r13 r">item</span> = <span class="r11 r">factory</span>();
            }
 
            <b>return</b> <span class="r13 r">item</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets (or creates) a shared item of a given type from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r14 r t">T</span> <a id="ee34921383be3407" href="../../R/ee34921383be3407.html" target="n" data-glyph="72,1" class="i method">GetOrCreate</a>&lt;<span id="r14 rd t" class="r14 r t">T</span>&gt;(<b>object</b> <span id="r15 rd" class="r15 r">key</span>) <b>where</b> <span class="r14 r t">T</span> : <b>class</b>, <b>new</b>()
        {
            <b>if</b> (<a href="#09229755528dc5b0" class="i property">Current</a> == <b>null</b>)
            {
                <b>return</b> <b>new</b> <span class="t">T</span>();
            }
 
            <b>if</b> (!<a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>.<span class="i method">TryGetValue</span>(<span class="r15 r">key</span>, <b>out</b> <a href="@1@System.Runtime/A.html#d9262ceecc1719ab" class="k">var</a> <span id="r16 rd" class="r16 r">value</span>) || !(<span class="r16 r">value</span> <b>is</b> <span class="r14 r t">T</span> <span id="r17 rd" class="r17 r">item</span>))
            {
                <a href="#09229755528dc5b0" class="i property">Current</a>.<a href="#8871940da42b4ab7" class="i field">_items</a>[<span class="r15 r">key</span>] = <span class="r17 r">item</span> = <b>new</b> <span class="t">T</span>();
            }
 
            <b>return</b> <span class="r17 r">item</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Sets a shared feature to the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="1dca1733c033f125" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SetFeature</a>&lt;<span id="r18 rd t" class="r18 r t">T</span>&gt;(<span class="r18 r t">T</span> <span id="r19 rd" class="r19 r">value</span>) =&gt; <a href="#62d3bc6dad5bb8bd" class="i method">Set</a>(<b>typeof</b>(<span class="r18 r t">T</span>), <span class="r19 r">value</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets a shared feature from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r20 r t">T</span> <a id="48754b5563503e89" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetFeature</a>&lt;<span id="r20 rd t" class="r20 r t">T</span>&gt;() =&gt; <a href="#d3738dfc1c0528cf" class="i method">Get</a>&lt;<span class="r20 r t">T</span>&gt;(<b>typeof</b>(<span class="r20 r t">T</span>));
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets (or creates) a shared feature from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r21 r t">T</span> <a id="f0663481533a669c" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetOrCreateFeature</a>&lt;<span id="r21 rd t" class="r21 r t">T</span>&gt;(<a href="@1@System.Runtime/A.html#87d60abb7092d5a4" class="t t">Func</a>&lt;<span class="r21 r t">T</span>&gt; <span id="r22 rd" class="r22 r">factory</span>) =&gt; <a href="#95c8703f82ba957c" class="i method">GetOrCreate</a>(<b>typeof</b>(<span class="r21 r t">T</span>), <span class="r22 r">factory</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Gets (or creates) a shared feature from the current shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <span class="r23 r t">T</span> <a id="57218da953a9a13c" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetOrCreateFeature</a>&lt;<span id="r23 rd t" class="r23 r t">T</span>&gt;() <b>where</b> <span class="r23 r t">T</span> : <b>class</b>, <b>new</b>() =&gt; <a href="#ee34921383be3407" class="i method">GetOrCreate</a>&lt;<span class="r23 r t">T</span>&gt;(<b>typeof</b>(<span class="r23 r t">T</span>));
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a child scope from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>&gt; <a id="62205cc7d7704bfd" href="../../R/62205cc7d7704bfd.html" target="n" data-glyph="72,1" class="i method">CreateChildScopeAsync</a>()
        {
            <a href="../IShellHost.cs.html#ed51f9b119330ee5" class="k">var</a> <span id="r24 rd" class="r24 r">shellHost</span> = <a href="#996415403af48612" class="i property">Services</a>.<span class="i method">GetRequiredService</span>&lt;<a href="../IShellHost.cs.html#ed51f9b119330ee5" class="t t">IShellHost</a>&gt;();
            <b>return</b> <span class="r24 r">shellHost</span>.<a href="../IShellHost.cs.html#ba40af19c73a5806" class="i method">GetScopeAsync</a>(<a href="#37dee1e883ce38c6" class="i property">Context</a>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a child scope from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>&gt; <a id="0d8399443472f8d5" href="../../R/0d8399443472f8d5.html" target="n" data-glyph="72,1" class="i method">CreateChildScopeAsync</a>(<a href="../ShellSettings.cs.html#368947b748b893a0" class="t t">ShellSettings</a> <span id="r25 rd" class="r25 r">settings</span>)
        {
            <a href="../IShellHost.cs.html#ed51f9b119330ee5" class="k">var</a> <span id="r26 rd" class="r26 r">shellHost</span> = <a href="#996415403af48612" class="i property">Services</a>.<span class="i method">GetRequiredService</span>&lt;<a href="../IShellHost.cs.html#ed51f9b119330ee5" class="t t">IShellHost</a>&gt;();
            <b>return</b> <span class="r26 r">shellHost</span>.<a href="../IShellHost.cs.html#ba40af19c73a5806" class="i method">GetScopeAsync</a>(<span class="r25 r">settings</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a child scope from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>&gt; <a id="e2add3cb0d47a577" href="../../R/e2add3cb0d47a577.html" target="n" data-glyph="72,1" class="i method">CreateChildScopeAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r27 rd" class="r27 r">tenant</span>)
        {
            <a href="../IShellHost.cs.html#ed51f9b119330ee5" class="k">var</a> <span id="r28 rd" class="r28 r">shellHost</span> = <a href="#996415403af48612" class="i property">Services</a>.<span class="i method">GetRequiredService</span>&lt;<a href="../IShellHost.cs.html#ed51f9b119330ee5" class="t t">IShellHost</a>&gt;();
            <b>return</b> <span class="r28 r">shellHost</span>.<a href="../Extensions/ShellHostExtensions.cs.html#9f6a98c6a20514de" class="i method">GetScopeAsync</a>(<span class="r27 r">tenant</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Execute a delegate using a child scope created from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="92ae585de73f80a2" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UsingChildScopeAsync</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r29 rd" class="r29 r">execute</span>, <b>bool</b> <span id="r30 rd" class="r30 r">activateShell</span> = <b>true</b>)
        {
            <b>await</b> (<b>await</b> <a href="#62205cc7d7704bfd" class="i method">CreateChildScopeAsync</a>()).<a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<span class="r29 r">execute</span>, <span class="r30 r">activateShell</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Execute a delegate using a child scope created from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="a55db128014dd8c7" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UsingChildScopeAsync</a>(<a href="../ShellSettings.cs.html#368947b748b893a0" class="t t">ShellSettings</a> <span id="r31 rd" class="r31 r">settings</span>, <a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r32 rd" class="r32 r">execute</span>, <b>bool</b> <span id="r33 rd" class="r33 r">activateShell</span> = <b>true</b>)
        {
            <b>await</b> (<b>await</b> <a href="#0d8399443472f8d5" class="i method">CreateChildScopeAsync</a>(<span class="r31 r">settings</span>)).<a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<span class="r32 r">execute</span>, <span class="r33 r">activateShell</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Execute a delegate using a child scope created from the current one.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="dda328d148880834" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UsingChildScopeAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r34 rd" class="r34 r">tenant</span>, <a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r35 rd" class="r35 r">execute</span>, <b>bool</b> <span id="r36 rd" class="r36 r">activateShell</span> = <b>true</b>)
        {
            <b>await</b> (<b>await</b> <a href="#e2add3cb0d47a577" class="i method">CreateChildScopeAsync</a>(<span class="r34 r">tenant</span>)).<a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<span class="r35 r">execute</span>, <span class="r36 r">activateShell</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Start holding this shell scope along the async flow.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="4949ab4972af23bc" href="../../R/4949ab4972af23bc.html" target="n" data-glyph="72,1" class="i method">StartAsyncFlow</a>()
        <span class="c">// Use an object indirection to hold the current scope in the &#39;AsyncLocal&#39;,</span>
        <span class="c">// so that it can be cleared in all execution contexts when it is cleared.</span>
            =&gt; <a href="#0139b4efe0877151" class="i field">_current</a>.<span class="i property">Value</span> = <b>new</b> <a href="#285d9be10993d302" class="t constructor">ShellScopeHolder</a> { <a href="#80d144dff5604a13" class="i field">Scope</a> = <a href="#6bc229032c2ec619" class="k">this</a> };
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Executes a delegate using this shell scope in an isolated async flow,</span>
        <span class="c">///</span><span class="c"> but only as a service scope without managing the shell state and</span>
        <span class="c">///</span><span class="c"> without invoking any tenant event.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7e3812fad0125ed8" href="../../R/7e3812fad0125ed8.html" target="n" data-glyph="72,1" class="i method">UsingServiceScopeAsync</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r37 rd" class="r37 r">execute</span>)
        {
            <a href="#6c1dc07580c9e532" class="i field">_serviceScopeOnly</a> = <b>true</b>;
            <b>return</b> <a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<span class="r37 r">execute</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Executes a delegate using this shell scope in an isolated async flow,</span>
        <span class="c">///</span><span class="c"> while managing the shell state and invoking tenant events.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="ae74d3684cfadb54" href="../../R/ae74d3684cfadb54.html" target="n" data-glyph="72,1" class="i method">UsingAsync</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r38 rd" class="r38 r">execute</span>, <b>bool</b> <span id="r39 rd" class="r39 r">activateShell</span> = <b>true</b>)
        {
            <b>if</b> (<a href="#09229755528dc5b0" class="i property">Current</a> == <a href="#6bc229032c2ec619" class="k">this</a>)
            {
                <b>await</b> <span class="r38 r">execute</span>(<a href="#09229755528dc5b0" class="i property">Current</a>);
                <b>return</b>;
            }
 
            <b>using</b> (<a href="#6bc229032c2ec619" class="k">this</a>)
            {
                <a href="#4949ab4972af23bc" class="i method">StartAsyncFlow</a>();
                <b>try</b>
                {
                    <b>try</b>
                    {
                        <b>if</b> (<span class="r39 r">activateShell</span>)
                        {
                            <b>await</b> <a href="#7b47d99412680847" class="i method">ActivateShellInternalAsync</a>();
                        }
 
                        <b>await</b> <span class="r38 r">execute</span>(<a href="#6bc229032c2ec619" class="k">this</a>);
                    }
                    <b>finally</b>
                    {
                        <b>await</b> <a href="#9920bd0e9187ca22" class="i method">TerminateShellInternalAsync</a>();
                    }
                }
                <b>catch</b> (<a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r40 rd" class="r40 r">e</span>)
                {
                    <b>await</b> <a href="#d0bbc9a3c754f990" class="i method">HandleExceptionAsync</a>(<span class="r40 r">e</span>);
                    <b>throw</b>;
                }
                <b>finally</b>
                {
                    <b>await</b> <a href="#e923ada7e0264223" class="i method">BeforeDisposeAsync</a>();
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Terminates a shell using this shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="d88be643b53d3d91" href="../../R/d88be643b53d3d91.html" target="n" data-glyph="74,1" class="i method">TerminateShellAsync</a>()
        {
            <b>using</b> (<a href="#6bc229032c2ec619" class="k">this</a>)
            {
                <a href="#4949ab4972af23bc" class="i method">StartAsyncFlow</a>();
                <b>await</b> <a href="#9920bd0e9187ca22" class="i method">TerminateShellInternalAsync</a>();
                <b>await</b> <a href="#e923ada7e0264223" class="i method">BeforeDisposeAsync</a>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Activate the shell, if not yet done, by calling the related tenant event handlers.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="7b47d99412680847" href="../../R/7b47d99412680847.html" target="n" data-glyph="74,1" class="i method">ActivateShellInternalAsync</a>()
        {
            <b>if</b> (<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#ba619911827f29e7" class="i property">IsActivated</a>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#6c1dc07580c9e532" class="i field">_serviceScopeOnly</a>)
            {
                <b>return</b>;
            }
 
            <span class="c">// Try to acquire a lock before using a new scope, so that a next process gets the last committed data.</span>
            (<a href="../../Locking/ILocker.cs.html#4bdf65719aba2e7d" class="k">var</a> <span id="r41 rd" class="r41 r">locker</span>, <a href="@1@System.Runtime/A.html#f1b135ff6c380b37" class="k">var</a> <span id="r42 rd" class="r42 r">locked</span>) = <b>await</b> <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContextExtensions.cs.html#09a7cbb6ccf20e5a" class="i method">TryAcquireShellActivateLockAsync</a>();
            <b>if</b> (!<span class="r42 r">locked</span>)
            {
                <b>throw</b> <b>new</b> <a href="@1@System.Runtime/A.html#eedbd59d0faf42ed" class="t constructor">TimeoutException</a>(<span class="s">$&quot;</span><span class="s">Fails to acquire a lock before activating the tenant: </span>{<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>.<a href="../ShellSettings.cs.html#7248e6f40dfe7c7f" class="i property">Name</a>}<span class="s">&quot;</span>);
            }
 
            <b>await using</b> <a href="../../Locking/ILocker.cs.html#4bdf65719aba2e7d" class="k">var</a> <span id="r43 rd" class="r43 r">acquiredLock</span> = <span class="r41 r">locker</span>;
 
            <span class="c">// The tenant gets activated here.</span>
            <b>if</b> (!<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#ba619911827f29e7" class="i property">IsActivated</a>)
            {
                <b>await</b> <b>new</b> <a href="#8b00c66b241e54bb" class="t constructor">ShellScope</a>(<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>).<a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<b>async</b> <span id="r44 rd" class="r44 r">scope</span> =&gt;
                {
                    <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r45 rd" class="r45 r">tenantEvents</span> = <span class="r44 r">scope</span>.<a href="#55a88f718c8bf968" class="i property">ServiceProvider</a>.<span class="i method">GetServices</span>&lt;<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="t t">IModularTenantEvents</a>&gt;();
                    <b>foreach</b> (<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="k">var</a> <span id="r46 rd" class="r46 r">tenantEvent</span> <b>in</b> <span class="r45 r">tenantEvents</span>)
                    {
                        <b>await</b> <span class="r46 r">tenantEvent</span>.<a href="../../Modules/IModularTenantEvents.cs.html#e297848910aab5dc" class="i method">ActivatingAsync</a>();
                    }
 
                    <b>foreach</b> (<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="k">var</a> <span id="r47 rd" class="r47 r">tenantEvent</span> <b>in</b> <span class="r45 r">tenantEvents</span>.<span class="i method">Reverse</span>())
                    {
                        <b>await</b> <span class="r47 r">tenantEvent</span>.<a href="../../Modules/IModularTenantEvents.cs.html#7287f2d7d811c172" class="i method">ActivatedAsync</a>();
                    }
                }, <span class="r39 r">activateShell</span>: <b>false</b>);
 
                <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#ba619911827f29e7" class="i property">IsActivated</a> = <b>true</b>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Registers a delegate to be invoked when &#39;BeforeDisposeAsync()&#39; is called on this scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="8d78d2697c7e6ae3" href="../../R/8d78d2697c7e6ae3.html" target="n" data-glyph="74,1" class="i method">BeforeDispose</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r48 rd" class="r48 r">callback</span>) =&gt; <a href="#960255ab164a2c64" class="i field">_beforeDispose</a>.<span class="i method">Insert</span>(0, <span class="r48 r">callback</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds a Signal (if not already present) to be sent just after &#39;BeforeDisposeAsync()&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="5d86cbb0a450c1e4" href="../../R/5d86cbb0a450c1e4.html" target="n" data-glyph="74,1" class="i method">DeferredSignal</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r49 rd" class="r49 r">key</span>) =&gt; <a href="#3f2d1210e5b800aa" class="i field">_deferredSignals</a>.<span class="i method">Add</span>(<span class="r49 r">key</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds a Task to be executed in a new scope after &#39;BeforeDisposeAsync()&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="45e1c96c4764bc17" href="../../R/45e1c96c4764bc17.html" target="n" data-glyph="74,1" class="i method">DeferredTask</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r50 rd" class="r50 r">task</span>) =&gt; <a href="#0274d6ea379d6a32" class="i field">_deferredTasks</a>.<span class="i method">Add</span>(<span class="r50 r">task</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds an handler to be invoked if an exception is thrown while executing in this shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal void</b> <a id="e305e956a2800655" href="../../R/e305e956a2800655.html" target="n" data-glyph="74,1" class="i method">ExceptionHandler</a>(<a href="@1@System.Runtime/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r51 rd" class="r51 r">callback</span>) =&gt; <a href="#b265cbb7e79773a9" class="i field">_exceptionHandlers</a>.<span class="i method">Add</span>(<span class="r51 r">callback</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Registers a delegate to be invoked before the current shell scope will be disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="06edf1969286289f" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">RegisterBeforeDispose</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r52 rd" class="r52 r">callback</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#8d78d2697c7e6ae3" class="i method">BeforeDispose</a>(<span class="r52 r">callback</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds a Signal (if not already present) to be sent just before the current shell scope will be disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="14bc4305296112c0" href="../../R/14bc4305296112c0.html" target="n" data-glyph="72,1" class="i method">AddDeferredSignal</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r53 rd" class="r53 r">key</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#5d86cbb0a450c1e4" class="i method">DeferredSignal</a>(<span class="r53 r">key</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds a Task to be executed in a new scope once the current shell scope has been disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="b3b7e01f508ba5e5" href="../../R/b3b7e01f508ba5e5.html" target="n" data-glyph="72,1" class="i method">AddDeferredTask</a>(<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r54 rd" class="r54 r">task</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#45e1c96c4764bc17" class="i method">DeferredTask</a>(<span class="r54 r">task</span>);
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Adds an handler to be invoked if an exception is thrown while executing in this shell scope.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public static void</b> <a id="feffd860b9dce3a6" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">AddExceptionHandler</a>(<a href="@1@System.Runtime/A.html#8adbe0476ca899db" class="t t">Func</a>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>, <a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r55 rd" class="r55 r">handler</span>) =&gt; <a href="#09229755528dc5b0" class="i property">Current</a>?.<a href="#e305e956a2800655" class="i method">ExceptionHandler</a>(<span class="r55 r">handler</span>);
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="d0bbc9a3c754f990" href="../../R/d0bbc9a3c754f990.html" target="n" data-glyph="72,1" class="i method">HandleExceptionAsync</a>(<a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r56 rd" class="r56 r">e</span>)
        {
            <b>foreach</b> (<a href="@1@System.Runtime/A.html#8adbe0476ca899db" class="k">var</a> <span id="r57 rd" class="r57 r">callback</span> <b>in</b> <a href="#b265cbb7e79773a9" class="i field">_exceptionHandlers</a>)
            {
                <b>await</b> <span class="r57 r">callback</span>(<a href="#6bc229032c2ec619" class="k">this</a>, <span class="r56 r">e</span>);
            }
        }
 
        <b>internal async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="e923ada7e0264223" href="../../R/e923ada7e0264223.html" target="n" data-glyph="74,1" class="i method">BeforeDisposeAsync</a>()
        {
            <b>foreach</b> (<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="k">var</a> <span id="r58 rd" class="r58 r">callback</span> <b>in</b> <a href="#960255ab164a2c64" class="i field">_beforeDispose</a>)
            {
                <b>await</b> <span class="r58 r">callback</span>(<a href="#6bc229032c2ec619" class="k">this</a>);
            }
 
            <b>if</b> (<a href="#6c1dc07580c9e532" class="i field">_serviceScopeOnly</a>)
            {
                <b>return</b>;
            }
 
            <b>if</b> (<a href="#3f2d1210e5b800aa" class="i field">_deferredSignals</a>.<span class="i method">Any</span>())
            {
                <a href="../../Caching/ISignal.cs.html#d99cd404bc7ce41e" class="k">var</a> <span id="r59 rd" class="r59 r">signal</span> = <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#14806dab63c4713f" class="i property">ServiceProvider</a>.<span class="i method">GetRequiredService</span>&lt;<a href="../../Caching/ISignal.cs.html#d99cd404bc7ce41e" class="t t">ISignal</a>&gt;();
                <b>foreach</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r60 rd" class="r60 r">key</span> <b>in</b> <a href="#3f2d1210e5b800aa" class="i field">_deferredSignals</a>)
                {
                    <b>await</b> <span class="r59 r">signal</span>.<a href="../../Caching/ISignal.cs.html#5df53a21d60bb31c" class="i method">SignalTokenAsync</a>(<span class="r60 r">key</span>);
                }
            }
 
            <b>if</b> (<a href="#0274d6ea379d6a32" class="i field">_deferredTasks</a>.<span class="i method">Any</span>())
            {
                <a href="../IShellHost.cs.html#ed51f9b119330ee5" class="k">var</a> <span id="r61 rd" class="r61 r">shellHost</span> = <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#14806dab63c4713f" class="i property">ServiceProvider</a>.<span class="i method">GetRequiredService</span>&lt;<a href="../IShellHost.cs.html#ed51f9b119330ee5" class="t t">IShellHost</a>&gt;();
 
                <b>foreach</b> (<a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="k">var</a> <span id="r62 rd" class="r62 r">task</span> <b>in</b> <a href="#0274d6ea379d6a32" class="i field">_deferredTasks</a>)
                {
                    <span class="c">// Create a new scope (maybe based on a new shell) for each task.</span>
                    <a href="#6bc229032c2ec619" class="t t">ShellScope</a> <span id="r63 rd" class="r63 r">scope</span>;
                    <b>try</b>
                    {
                        <span class="c">// May fail if a shell was released before being disabled.</span>
                        <span class="r63 r">scope</span> = <b>await</b> <span class="r61 r">shellHost</span>.<a href="../IShellHost.cs.html#ba40af19c73a5806" class="i method">GetScopeAsync</a>(<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>);
                    }
                    <b>catch</b>
                    {
                        <span class="c">// Fallback to a scope based on the current shell that is not yet disposed.</span>
                        <span class="r63 r">scope</span> = <b>new</b> <a href="#8b00c66b241e54bb" class="t constructor">ShellScope</a>(<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>);
                    }
 
                    <span class="c">// Use &#39;UsingAsync&#39; in place of &#39;UsingServiceScopeAsync()&#39; to allow a deferred task to</span>
                    <span class="c">// trigger another one, but still prevent the shell to be activated in a deferred task.</span>
                    <b>await</b> <span class="r63 r">scope</span>.<a href="#ae74d3684cfadb54" class="i method">UsingAsync</a>(<b>async</b> <span id="r64 rd" class="r64 r">scope</span> =&gt;
                    {
                        <b>var</b> <span id="r65 rd" class="r65 r">logger</span> = <span class="r64 r">scope</span>.<a href="#55a88f718c8bf968" class="i property">ServiceProvider</a>.<span class="i method">GetService</span>&lt;<span class="t t">ILogger</span>&lt;<a href="#6bc229032c2ec619" class="t t">ShellScope</a>&gt;&gt;();
 
                        <b>try</b>
                        {
                            <b>await</b> <span class="r62 r">task</span>(<span class="r64 r">scope</span>);
                        }
                        <b>catch</b> (<a href="@1@System.Runtime/A.html#f092fb2b893a0162" class="t t">Exception</a> <span id="r66 rd" class="r66 r">e</span>)
                        {
                            <span class="r65 r">logger</span>?.<span class="i method">LogError</span>(<span class="r66 r">e</span>,
                                <span class="s">&quot;Error while processing deferred task &#39;{TaskName}&#39; on tenant &#39;{TenantName}&#39;.&quot;</span>,
                                <span class="r62 r">task</span>.<a href="@1@System.Runtime/A.html#4d73eb225aef8a61" class="i method">GetType</a>().<a href="@1@System.Runtime/A.html#976443bb39dc37cd" class="i property">FullName</a>, <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>.<a href="../ShellSettings.cs.html#7248e6f40dfe7c7f" class="i property">Name</a>);
 
                            <b>await</b> <span class="r64 r">scope</span>.<a href="#d0bbc9a3c754f990" class="i method">HandleExceptionAsync</a>(<span class="r66 r">e</span>);
                        }
                    },
                    <span class="r39 r">activateShell</span>: <b>false</b>);
                }
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Terminates the shell, if released and in its last scope, by calling the related event handlers,</span>
        <span class="c">///</span><span class="c"> and specifies if the shell context should be disposed consequently to this scope being disposed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>internal async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="9920bd0e9187ca22" href="../../R/9920bd0e9187ca22.html" target="n" data-glyph="74,1" class="i method">TerminateShellInternalAsync</a>()
        {
            <b>if</b> (<a href="#6c1dc07580c9e532" class="i field">_serviceScopeOnly</a>)
            {
                <b>return</b>;
            }
 
            <a href="#adb0a2602a6d8c40" class="i field">_terminated</a> = <b>true</b>;
 
            <span class="c">// If the shell context is released and in its last shell scope, according to the ref counter value,</span>
            <span class="c">// the terminate event handlers are called, and the shell will be disposed at the end of this scope.</span>
 
            <span class="c">// Check if the decremented value of the ref counter reached 0.</span>
            <b>if</b> (<span class="t t">Interlocked</span>.<span class="i method">Decrement</span>(<b>ref</b> <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#4113c3000d657c1f" class="i field">_refCount</a>) == 0)
            {
                <span class="c">// A disabled shell still in use is released by its last scope.</span>
                <b>if</b> (<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#9460b7caf2e38f54" class="i property">Settings</a>.<a href="../ShellSettings.cs.html#42a6610d7f01c165" class="i property">State</a> == <a href="../Models/TenantState.cs.html#386ecd81b926aa48" class="t t">TenantState</a>.<a href="../Models/TenantState.cs.html#2196b7a2790a7b9b" class="i field">Disabled</a>)
                {
                    <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#b4bd1d85c654e1df" class="i method">ReleaseFromLastScope</a>();
                }
 
                <b>if</b> (!<a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#0dff73440b3719c4" class="i field">_released</a>)
                {
                    <b>return</b>;
                }
 
                <span class="c">// If released after the counter reached 0, a new last scope may have been created.</span>
                <b>if</b> (<span class="t t">Interlocked</span>.<span class="i method">CompareExchange</span>(<b>ref</b> <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#4113c3000d657c1f" class="i field">_refCount</a>, 0, 0) != 0)
                {
                    <b>return</b>;
                }
 
                <span class="c">// If a new last scope reached this point, ensure that the shell is terminated once.</span>
                <b>if</b> (<span class="t t">Interlocked</span>.<span class="i method">Exchange</span>(<b>ref</b> <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#01afbfeb6e99b891" class="i field">_terminated</a>, 1) == 1)
                {
                    <b>return</b>;
                }
 
                <a href="#920684b5864224a5" class="i field">_shellTerminated</a> = <b>true</b>;
 
                <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r67 rd" class="r67 r">tenantEvents</span> = <a href="#c06ae96180039928" class="i field">_serviceScope</a>.<span class="i property">ServiceProvider</span>.<span class="i method">GetServices</span>&lt;<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="t t">IModularTenantEvents</a>&gt;();
                <b>foreach</b> (<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="k">var</a> <span id="r68 rd" class="r68 r">tenantEvent</span> <b>in</b> <span class="r67 r">tenantEvents</span>)
                {
                    <b>await</b> <span class="r68 r">tenantEvent</span>.<a href="../../Modules/IModularTenantEvents.cs.html#48f1506b0a361e4e" class="i method">TerminatingAsync</a>();
                }
 
                <b>foreach</b> (<a href="../../Modules/IModularTenantEvents.cs.html#21a0df4b29d222f2" class="k">var</a> <span id="r69 rd" class="r69 r">tenantEvent</span> <b>in</b> <span class="r67 r">tenantEvents</span>.<span class="i method">Reverse</span>())
                {
                    <b>await</b> <span class="r69 r">tenantEvent</span>.<a href="../../Modules/IModularTenantEvents.cs.html#228f4d37596e3053" class="i method">TerminatedAsync</a>();
                }
            }
        }
 
        <b>public void</b> <a id="6ccce38737205772" href="../../R/6ccce38737205772.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>if</b> (<a href="#8e99716a5b0f5548" class="i field">_disposed</a>)
            {
                <b>return</b>;
            }
 
            <a href="#8e99716a5b0f5548" class="i field">_disposed</a> = <b>true</b>;
            <a href="#c06ae96180039928" class="i field">_serviceScope</a>.<a href="@1@System.Runtime/A.html#4e23fed29bd598fa" class="i method">Dispose</a>();
 
            <span class="c">// Check if the shell has been terminated.</span>
            <b>if</b> (<a href="#920684b5864224a5" class="i field">_shellTerminated</a>)
            {
                <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#cfc101cbffaed525" class="i method">Dispose</a>();
            }
 
            <b>if</b> (!<a href="#adb0a2602a6d8c40" class="i field">_terminated</a>)
            {
                <span class="c">// Keep the counter clean if not yet decremented.</span>
                <span class="t t">Interlocked</span>.<span class="i method">Decrement</span>(<b>ref</b> <a href="#e31ecdd9861b326a" class="i property">ShellContext</a>.<a href="../Builders/ShellContext.cs.html#4113c3000d657c1f" class="i field">_refCount</a>);
            }
 
            <a href="#285d9be10993d302" class="k">var</a> <span id="r70 rd" class="r70 r">holder</span> = <a href="#0139b4efe0877151" class="i field">_current</a>.<span class="i property">Value</span>;
            <b>if</b> (<span class="r70 r">holder</span> != <b>null</b>)
            {
                <span class="c">// Clear the current scope that may be trapped in some execution contexts.</span>
                <span class="r70 r">holder</span>.<a href="#80d144dff5604a13" class="i field">Scope</a> = <b>null</b>;
            }
        }
 
        <b>private class</b> <a id="285d9be10993d302" href="../../R/285d9be10993d302.html" target="n" data-glyph="4,1" class="t t"><span id="b11fc4279142e6ba">ShellScopeHolder</span></a>
        {
            <b>public</b> <a href="#6bc229032c2ec619" class="t t">ShellScope</a> <a id="80d144dff5604a13" href="../../R/80d144dff5604a13.html" target="n" data-glyph="42,2" class="i field">Scope</a>;
        }
    }
}
</pre></td></tr></table></div></body></html>
