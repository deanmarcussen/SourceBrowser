<!DOCTYPE html>
<html><head><title>ServiceProviderExtensions.cs</title><link rel="stylesheet" href="../../../../styles.css"><script src="../../../../scripts.js"></script></head>
<body class="cB" onload="i(117);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore/Shell/Builders/Extensions/ServiceProviderExtensions.cs" target="_top">Shell\Builders\Extensions\ServiceProviderExtensions.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore" target="_top">src\OrchardCore\OrchardCore\OrchardCore.csproj</a> (OrchardCore)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Environment</span>.<span class="i n">Shell</span>.<span class="i n">Builders</span>
{
    <b>public static class</b> <a id="41f780276a62a945" href="../../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t">ServiceProviderExtensions</a>
    {
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Creates a child container.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r0 r">serviceProvider</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The service provider to create a child container for.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">param</span> <span class="c">name</span><span class="c">=</span><span class="c">&quot;</span><span class="r1 r">serviceCollection</span><span class="c">&quot;</span><span class="c">&gt;</span><span class="c">The services to clone.</span><span class="c">&lt;/</span><span class="c">param</span><span class="c">&gt;</span>
        <b>public static</b> <span class="t t">IServiceCollection</span> <a id="de1e41bef2f3cad7" href="../../../R/de1e41bef2f3cad7.html" target="n" data-glyph="220,1" class="i method">CreateChildContainer</a>(<b>this</b> <span class="t t">IServiceProvider</span> <span id="r0 rd" class="r0 r">serviceProvider</span>, <span class="t t">IServiceCollection</span> <span id="r1 rd" class="r1 r">serviceCollection</span>)
        {
            <span class="t t">IServiceCollection</span> <span id="r2 rd" class="r2 r">clonedCollection</span> = <b>new</b> <span class="t constructor">ServiceCollection</span>();
            <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r3 rd" class="r3 r">servicesByType</span> = <span class="r1 r">serviceCollection</span>.<span class="i method">GroupBy</span>(<span id="r4 rd" class="r4 r">s</span> =&gt; <span class="r4 r">s</span>.<span class="i property">ServiceType</span>);
 
            <b>foreach</b> (<b>var</b> <span id="r5 rd" class="r5 r">services</span> <b>in</b> <span class="r3 r">servicesByType</span>)
            {
                <span class="c">// Prevent hosting &#39;IStartupFilter&#39; to re-add middlewares to the tenant pipeline.</span>
                <b>if</b> (<span class="r5 r">services</span>.<span class="i property">Key</span> == <b>typeof</b>(<span class="t t">IStartupFilter</span>))
                {
                }
 
                <span class="c">// A generic type definition is rather used to create other constructed generic types.</span>
                <b>else</b> <b>if</b> (<span class="r5 r">services</span>.<span class="i property">Key</span>.<a href="@1@System.Runtime/A.html#6bdfd6df375a9403" class="i property">IsGenericTypeDefinition</a>)
                {
                    <span class="c">// So, we just need to pass the descriptor.</span>
                    <b>foreach</b> (<b>var</b> <span id="r6 rd" class="r6 r">service</span> <b>in</b> <span class="r5 r">services</span>)
                    {
                        <span class="r2 r">clonedCollection</span>.<a href="@1@System.Runtime/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r6 r">service</span>);
                    }
                }
 
                <span class="c">// If only one service of a given type.</span>
                <b>else</b> <b>if</b> (<span class="r5 r">services</span>.<span class="i method">Count</span>() == 1)
                {
                    <b>var</b> <span id="r7 rd" class="r7 r">service</span> = <span class="r5 r">services</span>.<span class="i method">First</span>();
 
                    <b>if</b> (<span class="r7 r">service</span>.<span class="i property">Lifetime</span> == <span class="t t">ServiceLifetime</span>.<span class="i field">Singleton</span>)
                    {
                        <span class="c">// An host singleton is shared across tenant containers but only registered instances are not disposed</span>
                        <span class="c">// by the DI, so we check if it is disposable or if it uses a factory which may return a different type.</span>
 
                        <b>if</b> (<b>typeof</b>(<a href="@1@System.Runtime/A.html#1f55292c3174123d" class="t t">IDisposable</a>).<a href="@1@System.Runtime/A.html#ba0cffea035fe210" class="i method">IsAssignableFrom</a>(<span class="r7 r">service</span>.<a href="/OrchardCore.Abstractions/A.html#bf42b35062ef4c7e" class="i method">GetImplementationType</a>()) || <span class="r7 r">service</span>.<span class="i property">ImplementationFactory</span> != <b>null</b>)
                        {
                            <span class="c">// If disposable, register an instance that we resolve immediately from the main container.</span>
                            <span class="r2 r">clonedCollection</span>.<a href="ServiceCollectionExtensions.cs.html#5364bbfc95a93065" class="i method">CloneSingleton</a>(<span class="r7 r">service</span>, <span class="r0 r">serviceProvider</span>.<span class="i method">GetService</span>(<span class="r7 r">service</span>.<span class="i property">ServiceType</span>));
                        }
                        <b>else</b>
                        {
                            <span class="c">// If not disposable, the singleton can be resolved through a factory when first requested.</span>
                            <span class="r2 r">clonedCollection</span>.<a href="ServiceCollectionExtensions.cs.html#93ea50b75c42f5c3" class="i method">CloneSingleton</a>(<span class="r7 r">service</span>, <span id="r8 rd" class="r8 r">sp</span> =&gt; <span class="r0 r">serviceProvider</span>.<span class="i method">GetService</span>(<span class="r7 r">service</span>.<span class="i property">ServiceType</span>));
 
                            <span class="c">// Note: Most of the time a singleton of a given type is unique and not disposable. So,</span>
                            <span class="c">// most of the time it will be resolved when first requested through a tenant container.</span>
                        }
                    }
                    <b>else</b>
                    {
                        <span class="r2 r">clonedCollection</span>.<a href="@1@System.Runtime/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r7 r">service</span>);
                    }
                }
 
                <span class="c">// If all services of the same type are not singletons.</span>
                <b>else</b> <b>if</b> (<span class="r5 r">services</span>.<span class="i method">All</span>(<span id="r9 rd" class="r9 r">s</span> =&gt; <span class="r9 r">s</span>.<span class="i property">Lifetime</span> != <span class="t t">ServiceLifetime</span>.<span class="i field">Singleton</span>))
                {
                    <span class="c">// We don&#39;t need to resolve them.</span>
                    <b>foreach</b> (<b>var</b> <span id="r10 rd" class="r10 r">service</span> <b>in</b> <span class="r5 r">services</span>)
                    {
                        <span class="r2 r">clonedCollection</span>.<a href="@1@System.Runtime/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r10 r">service</span>);
                    }
                }
 
                <span class="c">// If all services of the same type are singletons.</span>
                <b>else</b> <b>if</b> (<span class="r5 r">services</span>.<span class="i method">All</span>(<span id="r11 rd" class="r11 r">s</span> =&gt; <span class="r11 r">s</span>.<span class="i property">Lifetime</span> == <span class="t t">ServiceLifetime</span>.<span class="i field">Singleton</span>))
                {
                    <span class="c">// We can resolve them from the main container.</span>
                    <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r12 rd" class="r12 r">instances</span> = <span class="r0 r">serviceProvider</span>.<span class="i method">GetServices</span>(<span class="r5 r">services</span>.<span class="i property">Key</span>);
 
                    <b>for</b> (<a href="@1@System.Runtime/A.html#225942ed7b7a3252" class="k">var</a> <span id="r13 rd" class="r13 r">i</span> = 0; <span class="r13 r">i</span> &lt; <span class="r5 r">services</span>.<span class="i method">Count</span>(); <span class="r13 r">i</span>++)
                    {
                        <span class="r2 r">clonedCollection</span>.<a href="ServiceCollectionExtensions.cs.html#5364bbfc95a93065" class="i method">CloneSingleton</a>(<span class="r5 r">services</span>.<span class="i method">ElementAt</span>(<span class="r13 r">i</span>), <span class="r12 r">instances</span>.<span class="i method">ElementAt</span>(<span class="r13 r">i</span>));
                    }
                }
 
                <span class="c">// If singletons and scoped services are mixed.</span>
                <b>else</b>
                {
                    <span class="c">// We need a service scope to resolve them.</span>
                    <b>using</b> (<b>var</b> <span id="r14 rd" class="r14 r">scope</span> = <span class="r0 r">serviceProvider</span>.<span class="i method">CreateScope</span>())
                    {
                        <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r15 rd" class="r15 r">instances</span> = <span class="r14 r">scope</span>.<span class="i property">ServiceProvider</span>.<span class="i method">GetServices</span>(<span class="r5 r">services</span>.<span class="i property">Key</span>);
 
                        <span class="c">// Then we only keep singleton instances.</span>
                        <b>for</b> (<a href="@1@System.Runtime/A.html#225942ed7b7a3252" class="k">var</a> <span id="r16 rd" class="r16 r">i</span> = 0; <span class="r16 r">i</span> &lt; <span class="r5 r">services</span>.<span class="i method">Count</span>(); <span class="r16 r">i</span>++)
                        {
                            <b>if</b> (<span class="r5 r">services</span>.<span class="i method">ElementAt</span>(<span class="r16 r">i</span>).<span class="i property">Lifetime</span> == <span class="t t">ServiceLifetime</span>.<span class="i field">Singleton</span>)
                            {
                                <span class="r2 r">clonedCollection</span>.<a href="ServiceCollectionExtensions.cs.html#5364bbfc95a93065" class="i method">CloneSingleton</a>(<span class="r5 r">services</span>.<span class="i method">ElementAt</span>(<span class="r16 r">i</span>), <span class="r15 r">instances</span>.<span class="i method">ElementAt</span>(<span class="r16 r">i</span>));
                            }
                            <b>else</b>
                            {
                                <span class="r2 r">clonedCollection</span>.<a href="@1@System.Runtime/A.html#a9319db8c62ae453" class="i method">Add</a>(<span class="r5 r">services</span>.<span class="i method">ElementAt</span>(<span class="r16 r">i</span>));
                            }
                        }
                    }
                }
            }
 
            <b>return</b> <span class="r2 r">clonedCollection</span>;
        }
    }
}
</pre></td></tr></table></div></body></html>
