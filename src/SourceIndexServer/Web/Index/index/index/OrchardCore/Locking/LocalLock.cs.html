<!DOCTYPE html>
<html><head><title>LocalLock.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(177);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore/Locking/LocalLock.cs" target="_top">Locking\LocalLock.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore" target="_top">src\OrchardCore\OrchardCore\OrchardCore.csproj</a> (OrchardCore)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Logging</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Locking</span>.<span class="i n">Distributed</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Locking</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> This component is a tenant singleton which allows to acquire named locks for a given tenant.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="8ea6fd13f00d874e" href="../R/8ea6fd13f00d874e.html" target="n" data-glyph="0,0" class="t t">LocalLock</a> : <a href="/OrchardCore.Abstractions/A.html#1b7f22cb91eb12e6" class="t t">IDistributedLock</a>, <a href="/OrchardCore.Abstractions/A.html#cfc5479cb3cf9fa9" class="t t">ILocalLock</a>, <a href="@1@System.Runtime/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>private readonly</b> <span class="t t">ILogger</span> <a id="984bd4da4e9dbeca" href="../R/984bd4da4e9dbeca.html" target="n" data-glyph="46,1" class="i field">_logger</a>;
 
        <b>private readonly</b> <span class="t t">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#5ea6fecb4c64180b" class="t t">Semaphore</a>&gt; <a id="de29fc3f8b6c67fa" href="../R/de29fc3f8b6c67fa.html" target="n" data-glyph="46,1" class="i field">_semaphores</a> = <b>new</b> <span class="t constructor">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#5ea6fecb4c64180b" class="t t">Semaphore</a>&gt;();
 
        <b>public</b> <a id="dc0582c18056174f" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">LocalLock</a>(<span class="t t">ILogger</span>&lt;<a href="#8ea6fd13f00d874e" class="t t">LocalLock</a>&gt; <span id="r0 rd" class="r0 r">logger</span>)
        {
            <a href="#984bd4da4e9dbeca" class="i field">_logger</a> = <span class="r0 r">logger</span>;
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Waits indefinitely until acquiring a named lock with a given expiration for the current tenant.</span>
        <span class="c">///</span><span class="c"> After &#39;expiration&#39; the lock is auto released, a null value is equivalent to &#39;TimeSpan.MaxValue&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<a href="/OrchardCore.Abstractions/A.html#4bdf65719aba2e7d" class="t t">ILocker</a>&gt; <a id="13fc1270b93b296f" href="../R/13fc1270b93b296f.html" target="n" data-glyph="72,1" class="i method">AcquireLockAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r1 rd" class="r1 r">key</span>, <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>? <span id="r2 rd" class="r2 r">expiration</span> = <b>null</b>)
        {
            <a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r3 rd" class="r3 r">semaphore</span> = <a href="#812f562fe2326db8" class="i method">GetOrCreateSemaphore</a>(<span class="r1 r">key</span>);
            <b>await</b> <span class="r3 r">semaphore</span>.<a href="#d2c665efba889ea3" class="i property">Value</a>.<span class="i method">WaitAsync</span>();
 
            <b>return</b> <b>new</b> <a href="#595d6fcb7acacd59" class="t constructor">Locker</a>(<a href="#8ea6fd13f00d874e" class="k">this</a>, <span class="r3 r">semaphore</span>, <span class="r2 r">expiration</span>);
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Tries to acquire a named lock in a given timeout with a given expiration for the current tenant.</span>
        <span class="c">///</span><span class="c"> After &#39;expiration&#39; the lock is auto released, a null value is equivalent to &#39;TimeSpan.MaxValue&#39;.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;(<a href="/OrchardCore.Abstractions/A.html#4bdf65719aba2e7d" class="t t">ILocker</a> <a id="237a1b1ef3342dc8" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">locker</a>, <b>bool</b> <a id="54726aa72a43b929" href="../R/../../0000000000.html" target="n" data-glyph="42,1" class="i field">locked</a>)&gt; <a id="9326d2569020e5c8" href="../R/9326d2569020e5c8.html" target="n" data-glyph="72,1" class="i method">TryAcquireLockAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r4 rd" class="r4 r">key</span>, <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a> <span id="r5 rd" class="r5 r">timeout</span>, <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>? <span id="r6 rd" class="r6 r">expiration</span> = <b>null</b>)
        {
            <a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r7 rd" class="r7 r">semaphore</span> = <a href="#812f562fe2326db8" class="i method">GetOrCreateSemaphore</a>(<span class="r4 r">key</span>);
 
            <b>if</b> (<b>await</b> <span class="r7 r">semaphore</span>.<a href="#d2c665efba889ea3" class="i property">Value</a>.<span class="i method">WaitAsync</span>(<span class="r5 r">timeout</span> != <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@System.Runtime/A.html#49db92dcef47a7a4" class="i field">MaxValue</a> ? <span class="r5 r">timeout</span> : <a href="@1@System.Runtime/A.html#6b53654d3452a8df" class="t t">Timeout</a>.<a href="@1@System.Runtime/A.html#c679290f50556e4e" class="i field">InfiniteTimeSpan</a>))
            {
                <b>return</b> (<b>new</b> <a href="#595d6fcb7acacd59" class="t constructor">Locker</a>(<a href="#8ea6fd13f00d874e" class="k">this</a>, <span class="r7 r">semaphore</span>, <span class="r6 r">expiration</span>), <b>true</b>);
            }
 
            <b>if</b> (<a href="#984bd4da4e9dbeca" class="i field">_logger</a>.<span class="i method">IsEnabled</span>(<span class="t t">LogLevel</span>.<span class="i field">Debug</span>))
            {
                <a href="#984bd4da4e9dbeca" class="i field">_logger</a>.<span class="i method">LogWarning</span>(<span class="s">&quot;Timeout elapsed before acquiring the named lock &#39;{LockName}&#39; after the given timeout of &#39;{Timeout}&#39;.&quot;</span>,
                    <span class="r4 r">key</span>, <span class="r5 r">timeout</span>.<a href="@1@System.Runtime/A.html#b8c8f6dc0f808233" class="i method">ToString</a>());
            }
 
            <b>return</b> (<b>null</b>, <b>false</b>);
        }
 
        <b>public</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>bool</b>&gt; <a id="8b6666fd3fd274b4" href="../R/8b6666fd3fd274b4.html" target="n" data-glyph="72,1" class="i method">IsLockAcquiredAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">key</span>)
        {
            <b>lock</b> (<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>)
            {
                <b>if</b> (<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>.<span class="i method">TryGetValue</span>(<span class="r8 r">key</span>, <b>out</b> <a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r9 rd" class="r9 r">semaphore</span>))
                {
                    <b>return</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@System.Runtime/A.html#11a386e7d7cae64a" class="i method">FromResult</a>(<span class="r9 r">semaphore</span>.<a href="#d2c665efba889ea3" class="i property">Value</a>.<span class="i property">CurrentCount</span> == 0);
                }
 
                <b>return</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>.<a href="@1@System.Runtime/A.html#11a386e7d7cae64a" class="i method">FromResult</a>(<b>false</b>);
            }
        }
 
        <b>private</b> <a href="#5ea6fecb4c64180b" class="t t">Semaphore</a> <a id="812f562fe2326db8" href="../R/812f562fe2326db8.html" target="n" data-glyph="76,1" class="i method">GetOrCreateSemaphore</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r10 rd" class="r10 r">key</span>)
        {
            <b>lock</b> (<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>)
            {
                <b>if</b> (<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>.<span class="i method">TryGetValue</span>(<span class="r10 r">key</span>, <b>out</b> <a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r11 rd" class="r11 r">semaphore</span>))
                {
                    <span class="r11 r">semaphore</span>.<a href="#a2e5ebeb65d72067" class="i property">RefCount</a>++;
                }
                <b>else</b>
                {
                    <span class="r11 r">semaphore</span> = <b>new</b> <a href="#61a68308578988da" class="t constructor">Semaphore</a>(<span class="r10 r">key</span>, <b>new</b> <span class="t constructor">SemaphoreSlim</span>(1));
                    <a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>[<span class="r10 r">key</span>] = <span class="r11 r">semaphore</span>;
                }
 
                <b>return</b> <span class="r11 r">semaphore</span>;
            }
        }
 
        <b>private class</b> <a id="5ea6fecb4c64180b" href="../R/5ea6fecb4c64180b.html" target="n" data-glyph="4,1" class="t t">Semaphore</a>
        {
            <b>public</b> <a id="61a68308578988da" href="../R/61a68308578988da.html" target="n" data-glyph="72,2" class="t constructor">Semaphore</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r12 rd" class="r12 r">key</span>, <span class="t t">SemaphoreSlim</span> <span id="r13 rd" class="r13 r">value</span>)
            {
                <a href="#241243c5e2f71808" class="i property">Key</a> = <span class="r12 r">key</span>;
                <a href="#d2c665efba889ea3" class="i property">Value</a> = <span class="r13 r">value</span>;
                <a href="#a2e5ebeb65d72067" class="i property">RefCount</a> = 1;
            }
 
            <b>internal string</b> <a id="241243c5e2f71808" href="../R/241243c5e2f71808.html" target="n" data-glyph="104,2" class="i property">Key</a> { <b>get</b>; }
            <b>internal</b> <span class="t t">SemaphoreSlim</span> <a id="d2c665efba889ea3" href="../R/d2c665efba889ea3.html" target="n" data-glyph="104,2" class="i property">Value</a> { <b>get</b>; }
            <b>internal int</b> <a id="a2e5ebeb65d72067" href="../R/a2e5ebeb65d72067.html" target="n" data-glyph="104,2" class="i property">RefCount</a> { <b>get</b>; <b>set</b>; }
        }
 
        <b>private class</b> <a id="8c179c8ecfd957fb" href="../R/8c179c8ecfd957fb.html" target="n" data-glyph="4,1" class="t t">Locker</a> : <a href="/OrchardCore.Abstractions/A.html#4bdf65719aba2e7d" class="t t">ILocker</a>
        {
            <b>private readonly</b> <a href="#8ea6fd13f00d874e" class="t t">LocalLock</a> <a id="6efd2e342f94722d" href="../R/6efd2e342f94722d.html" target="n" data-glyph="46,2" class="i field">_localLock</a>;
            <b>private readonly</b> <a href="#5ea6fecb4c64180b" class="t t">Semaphore</a> <a id="fcec062ba016cbab" href="../R/fcec062ba016cbab.html" target="n" data-glyph="46,2" class="i field">_semaphore</a>;
            <b>private readonly</b> <a href="@1@System.Runtime/A.html#130a9536ac96b392" class="t t">CancellationTokenSource</a> <a id="e587dc75394d1a66" href="../R/e587dc75394d1a66.html" target="n" data-glyph="46,2" class="i field">_cts</a>;
            <b>private volatile int</b> <a id="f8467a4d834f458a" href="../R/f8467a4d834f458a.html" target="n" data-glyph="46,2" class="i field">_released</a>;
            <b>private bool</b> <a id="c5abc8774e69dc50" href="../R/c5abc8774e69dc50.html" target="n" data-glyph="46,2" class="i field">_disposed</a>;
 
            <b>public</b> <a id="595d6fcb7acacd59" href="../R/595d6fcb7acacd59.html" target="n" data-glyph="72,2" class="t constructor">Locker</a>(<a href="#8ea6fd13f00d874e" class="t t">LocalLock</a> <span id="r14 rd" class="r14 r">localLock</span>, <a href="#5ea6fecb4c64180b" class="t t">Semaphore</a> <span id="r15 rd" class="r15 r">semaphore</span>, <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>? <span id="r16 rd" class="r16 r">expiration</span>)
            {
                <a href="#6efd2e342f94722d" class="i field">_localLock</a> = <span class="r14 r">localLock</span>;
                <a href="#fcec062ba016cbab" class="i field">_semaphore</a> = <span class="r15 r">semaphore</span>;
 
                <b>if</b> (<span class="r16 r">expiration</span>.<a href="@1@System.Runtime/A.html#7bbe60e33e857298" class="i property">HasValue</a> &amp;&amp; <span class="r16 r">expiration</span>.<a href="@1@System.Runtime/A.html#7b38d1fa76071c95" class="i property">Value</a> != <a href="@1@System.Runtime/A.html#865ef7b89f41b632" class="t t">TimeSpan</a>.<a href="@1@System.Runtime/A.html#49db92dcef47a7a4" class="i field">MaxValue</a>)
                {
                    <a href="#e587dc75394d1a66" class="i field">_cts</a> = <b>new</b> <a href="@1@System.Runtime/A.html#2f4ad148fd857d6f" class="t constructor">CancellationTokenSource</a>(<span class="r16 r">expiration</span>.<a href="@1@System.Runtime/A.html#7b38d1fa76071c95" class="i property">Value</a>);
                    <a href="#e587dc75394d1a66" class="i field">_cts</a>.<a href="@1@System.Runtime/A.html#9e22b9c8995bf195" class="i property">Token</a>.<a href="@1@System.Runtime/A.html#b4627f3ac7f722a5" class="i method">Register</a>(<a href="#e8c0120971b886f6" class="i method">Release</a>);
                }
            }
 
            <b>private void</b> <a id="e8c0120971b886f6" href="../R/e8c0120971b886f6.html" target="n" data-glyph="76,2" class="i method">Release</a>()
            {
                <b>if</b> (<span class="t t">Interlocked</span>.<span class="i method">Exchange</span>(<b>ref</b> <a href="#f8467a4d834f458a" class="i field">_released</a>, 1) == 0)
                {
                    <b>lock</b> (<a href="#6efd2e342f94722d" class="i field">_localLock</a>.<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>)
                    {
                        <b>if</b> (<a href="#6efd2e342f94722d" class="i field">_localLock</a>.<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>.<span class="i method">TryGetValue</span>(<a href="#fcec062ba016cbab" class="i field">_semaphore</a>.<a href="#241243c5e2f71808" class="i property">Key</a>, <b>out</b> <a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r17 rd" class="r17 r">semaphore</span>))
                        {
                            <span class="r17 r">semaphore</span>.<a href="#a2e5ebeb65d72067" class="i property">RefCount</a>--;
 
                            <b>if</b> (<span class="r17 r">semaphore</span>.<a href="#a2e5ebeb65d72067" class="i property">RefCount</a> == 0)
                            {
                                <a href="#6efd2e342f94722d" class="i field">_localLock</a>.<a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>.<span class="i method">Remove</span>(<a href="#fcec062ba016cbab" class="i field">_semaphore</a>.<a href="#241243c5e2f71808" class="i property">Key</a>);
                            }
                        }
                    }
 
                    <a href="#fcec062ba016cbab" class="i field">_semaphore</a>.<a href="#d2c665efba889ea3" class="i property">Value</a>.<span class="i method">Release</span>();
                }
            }
 
            <b>public</b> <a href="@1@System.Runtime/A.html#001d610aba2df461" class="t t">ValueTask</a> <a id="c1040981cb2e2dc4" href="../R/c1040981cb2e2dc4.html" target="n" data-glyph="72,2" class="i method">DisposeAsync</a>()
            {
                <a href="#e22de9ddbc3fc2f0" class="i method">Dispose</a>();
                <b>return</b> <b>default</b>;
            }
 
            <b>public void</b> <a id="e22de9ddbc3fc2f0" href="../R/e22de9ddbc3fc2f0.html" target="n" data-glyph="72,2" class="i method">Dispose</a>()
            {
                <b>if</b> (<a href="#c5abc8774e69dc50" class="i field">_disposed</a>)
                {
                    <b>return</b>;
                }
 
                <a href="#c5abc8774e69dc50" class="i field">_disposed</a> = <b>true</b>;
 
                <a href="#e587dc75394d1a66" class="i field">_cts</a>?.<a href="@1@System.Runtime/A.html#d6974e1b9b86299d" class="i method">Dispose</a>();
 
                <a href="#e8c0120971b886f6" class="i method">Release</a>();
            }
        }
 
        <b>public void</b> <a id="b59dfeacc2c4ee8a" href="../R/b59dfeacc2c4ee8a.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>var</b> <span id="r18 rd" class="r18 r">semaphores</span> = <a href="#de29fc3f8b6c67fa" class="i field">_semaphores</a>.<span class="i property">Values</span>.<span class="i method">ToArray</span>();
 
            <b>foreach</b> (<a href="#5ea6fecb4c64180b" class="k">var</a> <span id="r19 rd" class="r19 r">semaphore</span> <b>in</b> <span class="r18 r">semaphores</span>)
            {
                <span class="r19 r">semaphore</span>.<a href="#d2c665efba889ea3" class="i property">Value</a>.<span class="i method">Dispose</span>();
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
