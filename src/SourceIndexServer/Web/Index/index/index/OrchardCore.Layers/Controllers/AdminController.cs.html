<!DOCTYPE html>
<html><head><title>AdminController.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(347);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Layers/Controllers/AdminController.cs" target="_top">Controllers\AdminController.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Layers" target="_top">src\OrchardCore.Modules\OrchardCore.Layers\OrchardCore.Layers.csproj</a> (OrchardCore.Layers)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Authorization</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Localization</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Localization</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Display</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">DisplayManagement</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">DisplayManagement</span>.<span class="i n">ModelBinding</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">DisplayManagement</span>.<span class="i n">Notify</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Documents</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Entities</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Layers</span>.<span class="i n">Handlers</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Layers</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Layers</span>.<span class="i n">Services</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Layers</span>.<span class="i n">ViewModels</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Rules</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Settings</span>;
<b>using</b> <span class="i">YesSql</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Layers</span>.<span class="i n">Controllers</span>
{
    <b>public class</b> <a id="5d4c9977466e8620" href="../R/5d4c9977466e8620.html" target="n" data-glyph="0,0" class="t t">AdminController</a> : <span class="t t">Controller</span>
    {
        <b>private readonly</b> <a href="/OrchardCore.ContentManagement.Abstractions/A.html#6ca840219d8dc4cd" class="t t">IContentManager</a> <a id="bb56c596b93cbd85" href="../R/bb56c596b93cbd85.html" target="n" data-glyph="46,1" class="i field">_contentManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.ContentManagement.Display/A.html#ccb0f2621bf941ec" class="t t">IContentItemDisplayManager</a> <a id="f20e9ab9e55180e2" href="../R/f20e9ab9e55180e2.html" target="n" data-glyph="46,1" class="i field">_contentItemDisplayManager</a>;
        <b>private readonly</b> <span class="i">ISiteService</span> <a id="21446eed8fcda15d" href="../R/21446eed8fcda15d.html" target="n" data-glyph="46,1" class="i field">_siteService</a>;
        <b>private readonly</b> <a href="../Services/ILayerService.cs.html#bd6b049f28eda706" class="t t">ILayerService</a> <a id="9cc89d6c5aac14d0" href="../R/9cc89d6c5aac14d0.html" target="n" data-glyph="46,1" class="i field">_layerService</a>;
        <b>private readonly</b> <span class="t t">IAuthorizationService</span> <a id="ccfd0b523a0b5795" href="../R/ccfd0b523a0b5795.html" target="n" data-glyph="46,1" class="i field">_authorizationService</a>;
        <b>private readonly</b> <span class="i">ISession</span> <a id="08402ac229f13374" href="../R/08402ac229f13374.html" target="n" data-glyph="46,1" class="i field">_session</a>;
        <b>private readonly</b> <span class="i">IUpdateModelAccessor</span> <a id="963d4e035130e17e" href="../R/963d4e035130e17e.html" target="n" data-glyph="46,1" class="i field">_updateModelAccessor</a>;
        <b>private readonly</b> <span class="i">IVolatileDocumentManager</span>&lt;<a href="../Handlers/LayerMetadataHandler.cs.html#be09fec8e5f3ad20" class="t t">LayerState</a>&gt; <a id="e1aba274c4387d1b" href="../R/e1aba274c4387d1b.html" target="n" data-glyph="46,1" class="i field">_layerStateManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.DisplayManagement/A.html#3210eac404b61aa1" class="t t">IDisplayManager</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#b6dbd3e74203e032" class="t t">Condition</a>&gt; <a id="ef6cd35bd01718f9" href="../R/ef6cd35bd01718f9.html" target="n" data-glyph="46,1" class="i field">_conditionDisplayManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.DisplayManagement/A.html#3210eac404b61aa1" class="t t">IDisplayManager</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#96636e2f2bede914" class="t t">Rule</a>&gt; <a id="a6cd530231b1cb7a" href="../R/a6cd530231b1cb7a.html" target="n" data-glyph="46,1" class="i field">_ruleDisplayManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.Rules.Abstractions/A.html#ad0e2a0eb60359b6" class="t t">IConditionIdGenerator</a> <a id="3985c2cc4fc7cfae" href="../R/3985c2cc4fc7cfae.html" target="n" data-glyph="46,1" class="i field">_conditionIdGenerator</a>;
        <b>private readonly</b> <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#82411e52c6f97577" class="t t">IConditionFactory</a>&gt; <a id="2104659e72b463a4" href="../R/2104659e72b463a4.html" target="n" data-glyph="46,1" class="i field">_conditionFactories</a>;
        <b>private readonly</b> <span class="t t">IStringLocalizer</span> <a id="7ceb9a8ab05581ef" href="../R/7ceb9a8ab05581ef.html" target="n" data-glyph="46,1" class="i field">S</a>;
        <b>private readonly</b> <span class="t t">IHtmlLocalizer</span> <a id="6a87deb4b26d6634" href="../R/6a87deb4b26d6634.html" target="n" data-glyph="46,1" class="i field">H</a>;
        <b>private readonly</b> <a href="/OrchardCore.DisplayManagement/A.html#ec932247fd25e4dd" class="t t">INotifier</a> <a id="31fd7882c0faf7dd" href="../R/31fd7882c0faf7dd.html" target="n" data-glyph="46,1" class="i field">_notifier</a>;
 
        <b>public</b> <a id="87d6a0599411575d" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">AdminController</a>(
            <a href="/OrchardCore.ContentManagement.Abstractions/A.html#6ca840219d8dc4cd" class="t t">IContentManager</a> <span id="r0 rd" class="r0 r">contentManager</span>,
            <a href="/OrchardCore.ContentManagement.Display/A.html#ccb0f2621bf941ec" class="t t">IContentItemDisplayManager</a> <span id="r1 rd" class="r1 r">contentItemDisplayManager</span>,
            <span class="i">ISiteService</span> <span id="r2 rd" class="r2 r">siteService</span>,
            <a href="../Services/ILayerService.cs.html#bd6b049f28eda706" class="t t">ILayerService</a> <span id="r3 rd" class="r3 r">layerService</span>,
            <span class="t t">IAuthorizationService</span> <span id="r4 rd" class="r4 r">authorizationService</span>,
            <span class="i">ISession</span> <span id="r5 rd" class="r5 r">session</span>,
            <span class="i">IUpdateModelAccessor</span> <span id="r6 rd" class="r6 r">updateModelAccessor</span>,
            <span class="i">IVolatileDocumentManager</span>&lt;<a href="../Handlers/LayerMetadataHandler.cs.html#be09fec8e5f3ad20" class="t t">LayerState</a>&gt; <span id="r7 rd" class="r7 r">layerStateManager</span>,
            <a href="/OrchardCore.DisplayManagement/A.html#3210eac404b61aa1" class="t t">IDisplayManager</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#b6dbd3e74203e032" class="t t">Condition</a>&gt; <span id="r8 rd" class="r8 r">conditionDisplayManager</span>,
            <a href="/OrchardCore.DisplayManagement/A.html#3210eac404b61aa1" class="t t">IDisplayManager</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#96636e2f2bede914" class="t t">Rule</a>&gt; <span id="r9 rd" class="r9 r">ruleDisplayManager</span>,
            <a href="/OrchardCore.Rules.Abstractions/A.html#ad0e2a0eb60359b6" class="t t">IConditionIdGenerator</a> <span id="r10 rd" class="r10 r">conditionIdGenerator</span>,
            <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/OrchardCore.Rules.Abstractions/A.html#82411e52c6f97577" class="t t">IConditionFactory</a>&gt; <span id="r11 rd" class="r11 r">conditionFactories</span>,
            <span class="t t">IStringLocalizer</span>&lt;<a href="#5d4c9977466e8620" class="t t">AdminController</a>&gt; <span id="r12 rd" class="r12 r">stringLocalizer</span>,
            <span class="t t">IHtmlLocalizer</span>&lt;<a href="#5d4c9977466e8620" class="t t">AdminController</a>&gt; <span id="r13 rd" class="r13 r">htmlLocalizer</span>,
            <a href="/OrchardCore.DisplayManagement/A.html#ec932247fd25e4dd" class="t t">INotifier</a> <span id="r14 rd" class="r14 r">notifier</span>)
        {
            <a href="#bb56c596b93cbd85" class="i field">_contentManager</a> = <span class="r0 r">contentManager</span>;
            <a href="#f20e9ab9e55180e2" class="i field">_contentItemDisplayManager</a> = <span class="r1 r">contentItemDisplayManager</span>;
            <a href="#21446eed8fcda15d" class="i field">_siteService</a> = <span class="r2 r">siteService</span>;
            <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a> = <span class="r3 r">layerService</span>;
            <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a> = <span class="r4 r">authorizationService</span>;
            <a href="#08402ac229f13374" class="i field">_session</a> = <span class="r5 r">session</span>;
            <a href="#963d4e035130e17e" class="i field">_updateModelAccessor</a> = <span class="r6 r">updateModelAccessor</span>;
            <a href="#e1aba274c4387d1b" class="i field">_layerStateManager</a> = <span class="r7 r">layerStateManager</span>;
            <a href="#ef6cd35bd01718f9" class="i field">_conditionDisplayManager</a> = <span class="r8 r">conditionDisplayManager</span>;
            <a href="#a6cd530231b1cb7a" class="i field">_ruleDisplayManager</a> = <span class="r9 r">ruleDisplayManager</span>;
            <a href="#3985c2cc4fc7cfae" class="i field">_conditionIdGenerator</a> = <span class="r10 r">conditionIdGenerator</span>;
            <a href="#2104659e72b463a4" class="i field">_conditionFactories</a> = <span class="r11 r">conditionFactories</span>;
            <a href="#31fd7882c0faf7dd" class="i field">_notifier</a> = <span class="r14 r">notifier</span>;
            <a href="#7ceb9a8ab05581ef" class="i field">S</a> = <span class="r12 r">stringLocalizer</span>;
            <a href="#6a87deb4b26d6634" class="i field">H</a> = <span class="r13 r">htmlLocalizer</span>;
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="46eaaf381b9f5309" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Index</a>()
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="k">var</a> <span id="r15 rd" class="r15 r">layers</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#3d4b717e88b1e03f" class="i method">GetLayersAsync</a>();
            <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r16 rd" class="r16 r">widgets</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#eda4fa5789b7a92a" class="i method">GetLayerWidgetsMetadataAsync</a>(<span id="r17 rd" class="r17 r">c</span> =&gt; <span class="r17 r">c</span>.<a href="/OrchardCore.ContentManagement/A.html#448673b7f21e4a8c" class="i property">Latest</a> == <b>true</b>);
 
            <a href="../ViewModels/LayersIndexViewModel.cs.html#f5d211743526caa1" class="k">var</a> <span id="r18 rd" class="r18 r">model</span> = <b>new</b> <a href="../ViewModels/LayersIndexViewModel.cs.html#f5d211743526caa1" class="t constructor">LayersIndexViewModel</a> { <a href="../ViewModels/LayersIndexViewModel.cs.html#b05867f82ab5bf1b" class="i property">Layers</a> = <span class="r15 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">ToList</span>() };
 
            <b>var</b> <span id="r19 rd" class="r19 r">siteSettings</span> = <b>await</b> <a href="#21446eed8fcda15d" class="i field">_siteService</a>.<span class="i">GetSiteSettingsAsync</span>();
 
            <span class="r18 r">model</span>.<a href="../ViewModels/LayersIndexViewModel.cs.html#07d220e0f1cae6c1" class="i property">Zones</a> = <span class="r19 r">siteSettings</span>.<span class="i">As</span>&lt;<a href="../Models/LayerSettings.cs.html#78eaf9aca81d01f0" class="t t">LayerSettings</a>&gt;().<a href="../Models/LayerSettings.cs.html#ecd6dd0be3173769" class="i property">Zones</a> ?? <a href="@1@System.Runtime/A.html#156e066ecc4ccedf" class="t t">Array</a>.<a href="@1@System.Runtime/A.html#bc9fd1be0e4f4e70" class="i method">Empty</a>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;();
            <span class="r18 r">model</span>.<a href="../ViewModels/LayersIndexViewModel.cs.html#fdcb285d0315e265" class="i property">Widgets</a> = <b>new</b> <span class="t constructor">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <span class="t t">List</span>&lt;<b>dynamic</b>&gt;&gt;();
 
            <b>foreach</b> (<a href="../Models/LayerMetadata.cs.html#579bed763ac045dc" class="k">var</a> <span id="r20 rd" class="r20 r">widget</span> <b>in</b> <span class="r16 r">widgets</span>.<span class="i method">OrderBy</span>(<span id="r21 rd" class="r21 r">x</span> =&gt; <span class="r21 r">x</span>.<a href="../Models/LayerMetadata.cs.html#83f66c7200d3e0cc" class="i property">Position</a>))
            {
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r22 rd" class="r22 r">zone</span> = <span class="r20 r">widget</span>.<a href="../Models/LayerMetadata.cs.html#54798dda07003f4b" class="i property">Zone</a>;
                <span class="t t">List</span>&lt;<b>dynamic</b>&gt; <span id="r23 rd" class="r23 r">list</span>;
                <b>if</b> (!<span class="r18 r">model</span>.<a href="../ViewModels/LayersIndexViewModel.cs.html#fdcb285d0315e265" class="i property">Widgets</a>.<span class="i method">TryGetValue</span>(<span class="r22 r">zone</span>, <b>out</b> <span class="r23 r">list</span>))
                {
                    <span class="r18 r">model</span>.<a href="../ViewModels/LayersIndexViewModel.cs.html#fdcb285d0315e265" class="i property">Widgets</a>.<span class="i method">Add</span>(<span class="r22 r">zone</span>, <span class="r23 r">list</span> = <b>new</b> <span class="t constructor">List</span>&lt;<b>dynamic</b>&gt;());
                }
 
                <span class="r23 r">list</span>.<span class="i">Add</span>(<b>await</b> <a href="#f20e9ab9e55180e2" class="i field">_contentItemDisplayManager</a>.<span class="i">BuildDisplayAsync</span>(<span class="r20 r">widget</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#3eb4531412e2a732" class="i property">ContentItem</a>, <a href="#963d4e035130e17e" class="i field">_updateModelAccessor</a>.<span class="i">ModelUpdater</span>, <span class="s">&quot;SummaryAdmin&quot;</span>));
            }
 
            <b>return</b> <span class="i method">View</span>(<span class="r18 r">model</span>);
        }
 
        [<span class="t constructor">HttpPost</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="594a5c506d10604d" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Index</a>(<a href="../ViewModels/LayersIndexViewModel.cs.html#f5d211743526caa1" class="t t">LayersIndexViewModel</a> <span id="r24 rd" class="r24 r">model</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <b>return</b> <span class="i method">RedirectToAction</span>(<b>nameof</b>(<span class="i">Index</span>));
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="80e2d33c62dc0844" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Create</a>()
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <b>return</b> <span class="i method">View</span>();
        }
 
        [<span class="t constructor">HttpPost</span>, <span class="t constructor">ActionName</span>(<span class="s">&quot;Create&quot;</span>)]
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="698b531d7e467f86" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">CreatePost</a>(<a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t t">LayerEditViewModel</a> <span id="r25 rd" class="r25 r">model</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="k">var</a> <span id="r26 rd" class="r26 r">layers</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#efa2b7e5b660ffdb" class="i method">LoadLayersAsync</a>();
 
            <a href="#23e3e231218bf697" class="i method">ValidateViewModel</a>(<span class="r25 r">model</span>, <span class="r26 r">layers</span>, <span class="r27 r">isNew</span>: <b>true</b>);
 
            <b>if</b> (<span class="i property">ModelState</span>.<span class="i property">IsValid</span>)
            {
                <a href="../Models/Layer.cs.html#1c0d592a36c3a08b" class="k">var</a> <span id="r28 rd" class="r28 r">layer</span> = <b>new</b> <a href="../Models/Layer.cs.html#1c0d592a36c3a08b" class="t constructor">Layer</a>
                {
                    <a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a> = <span class="r25 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>,
                    <a href="../Models/Layer.cs.html#0946d0d73ccac2a3" class="i property">Description</a> = <span class="r25 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#c4f12ed52a08eb0a" class="i property">Description</a>
                };
                
                <span class="r28 r">layer</span>.<a href="../Models/Layer.cs.html#be32c18fb8f4026d" class="i property">LayerRule</a> = <b>new</b> <a href="/OrchardCore.Rules.Abstractions/A.html#96636e2f2bede914" class="t constructor">Rule</a>();
                <a href="#3985c2cc4fc7cfae" class="i field">_conditionIdGenerator</a>.<a href="/OrchardCore.Rules.Abstractions/A.html#9b0915c883e364aa" class="i method">GenerateUniqueId</a>(<span class="r28 r">layer</span>.<a href="../Models/Layer.cs.html#be32c18fb8f4026d" class="i property">LayerRule</a>);
 
                <span class="r26 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">Add</span>(<span class="r28 r">layer</span>);
 
                <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#2ba6b07ab60762e3" class="i method">UpdateAsync</a>(<span class="r26 r">layers</span>);
 
                <b>return</b> <span class="i method">RedirectToAction</span>(<b>nameof</b>(<span class="i">Index</span>));
            }
 
            <b>return</b> <span class="i method">View</span>(<span class="r25 r">model</span>);
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="33dfd4c5e9061f06" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Edit</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r29 rd" class="r29 r">name</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="k">var</a> <span id="r30 rd" class="r30 r">layers</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#3d4b717e88b1e03f" class="i method">GetLayersAsync</a>();
 
            <a href="../Models/Layer.cs.html#1c0d592a36c3a08b" class="k">var</a> <span id="r31 rd" class="r31 r">layer</span> = <span class="r30 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">FirstOrDefault</span>(<span id="r32 rd" class="r32 r">x</span> =&gt; <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#372d790ddae4cbb4" class="i method">Equals</a>(<span class="r32 r">x</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a>, <span class="r29 r">name</span>));
 
            <b>if</b> (<span class="r31 r">layer</span> == <b>null</b>)
            {
                <b>return</b> <span class="i method">NotFound</span>();
            }
 
            <b>dynamic</b> <span id="r33 rd" class="r33 r">rule</span> = <b>await</b> <a href="#a6cd530231b1cb7a" class="i field">_ruleDisplayManager</a>.<span class="i">BuildDisplayAsync</span>(<span class="r31 r">layer</span>.<a href="../Models/Layer.cs.html#be32c18fb8f4026d" class="i property">LayerRule</a>, <a href="#963d4e035130e17e" class="i field">_updateModelAccessor</a>.<span class="i">ModelUpdater</span>, <span class="s">&quot;Summary&quot;</span>);
            <span class="r33 r">rule</span>.<span class="i">ConditionId</span> = <span class="r31 r">layer</span>.<a href="../Models/Layer.cs.html#be32c18fb8f4026d" class="i property">LayerRule</a>.<a href="/OrchardCore.Rules.Abstractions/A.html#7ef41ecb0d1c8608" class="i property">ConditionId</a>;
 
            <b>var</b> <span id="r34 rd" class="r34 r">thumbnails</span> = <b>new</b> <span class="t constructor">Dictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <b>dynamic</b>&gt;();
            <b>foreach</b> (<a href="/OrchardCore.Rules.Abstractions/A.html#82411e52c6f97577" class="k">var</a> <span id="r35 rd" class="r35 r">factory</span> <b>in</b> <a href="#2104659e72b463a4" class="i field">_conditionFactories</a>)
            {
                <a href="/OrchardCore.Rules.Abstractions/A.html#b6dbd3e74203e032" class="k">var</a> <span id="r36 rd" class="r36 r">condition</span> = <span class="r35 r">factory</span>.<a href="/OrchardCore.Rules.Abstractions/A.html#a818d3706aa536d2" class="i method">Create</a>();
                <b>dynamic</b> <span id="r37 rd" class="r37 r">thumbnail</span> = <b>await</b> <a href="#ef6cd35bd01718f9" class="i field">_conditionDisplayManager</a>.<span class="i">BuildDisplayAsync</span>(<span class="r36 r">condition</span>, <a href="#963d4e035130e17e" class="i field">_updateModelAccessor</a>.<span class="i">ModelUpdater</span>, <span class="s">&quot;Thumbnail&quot;</span>);
                <span class="r37 r">thumbnail</span>.<span class="i">Condition</span> = <span class="r36 r">condition</span>;
                <span class="r34 r">thumbnails</span>.<span class="i method">Add</span>(<span class="r35 r">factory</span>.<a href="/OrchardCore.Rules.Abstractions/A.html#320e689fb5a8219d" class="i property">Name</a>, <span class="r37 r">thumbnail</span>);
            }
 
            <a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="k">var</a> <span id="r38 rd" class="r38 r">model</span> = <b>new</b> <a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t constructor">LayerEditViewModel</a>
            {
                <a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a> = <span class="r31 r">layer</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a>,
                <a href="../ViewModels/LayerEditViewModel.cs.html#c4f12ed52a08eb0a" class="i property">Description</a> = <span class="r31 r">layer</span>.<a href="../Models/Layer.cs.html#0946d0d73ccac2a3" class="i property">Description</a>,
                <a href="../ViewModels/LayerEditViewModel.cs.html#9b92b2c3652e969e" class="i property">LayerRule</a> = <span class="r33 r">rule</span>,
                <a href="../ViewModels/LayerEditViewModel.cs.html#22cd0d7e4061f2c7" class="i property">Thumbnails</a> = <span class="r34 r">thumbnails</span>,
            };
 
            <b>return</b> <span class="i method">View</span>(<span class="r38 r">model</span>);
        }
 
        [<span class="t constructor">HttpPost</span>, <span class="t constructor">ActionName</span>(<span class="s">&quot;Edit&quot;</span>)]
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="42c6c1cd7a90fa9b" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">EditPost</a>(<a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t t">LayerEditViewModel</a> <span id="r39 rd" class="r39 r">model</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="k">var</a> <span id="r40 rd" class="r40 r">layers</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#efa2b7e5b660ffdb" class="i method">LoadLayersAsync</a>();
 
            <a href="#23e3e231218bf697" class="i method">ValidateViewModel</a>(<span class="r39 r">model</span>, <span class="r40 r">layers</span>, <span class="r27 r">isNew</span>: <b>false</b>);
 
            <b>if</b> (<span class="i property">ModelState</span>.<span class="i property">IsValid</span>)
            {
                <a href="../Models/Layer.cs.html#1c0d592a36c3a08b" class="k">var</a> <span id="r41 rd" class="r41 r">layer</span> = <span class="r40 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">FirstOrDefault</span>(<span id="r42 rd" class="r42 r">x</span> =&gt; <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#372d790ddae4cbb4" class="i method">Equals</a>(<span class="r42 r">x</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a>, <span class="r39 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>));
 
                <b>if</b> (<span class="r41 r">layer</span> == <b>null</b>)
                {
                    <b>return</b> <span class="i method">NotFound</span>();
                }
 
                <span class="r41 r">layer</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a> = <span class="r39 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>;
                <span class="r41 r">layer</span>.<a href="../Models/Layer.cs.html#0946d0d73ccac2a3" class="i property">Description</a> = <span class="r39 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#c4f12ed52a08eb0a" class="i property">Description</a>;
 
                <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#2ba6b07ab60762e3" class="i method">UpdateAsync</a>(<span class="r40 r">layers</span>);
 
                <b>return</b> <span class="i method">RedirectToAction</span>(<b>nameof</b>(<span class="i">Index</span>));
            }
 
            <b>return</b> <span class="i method">View</span>(<span class="r39 r">model</span>);
        }
 
        [<span class="t constructor">HttpPost</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="dad24bad21e6ef16" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Delete</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r43 rd" class="r43 r">name</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">Forbid</span>();
            }
 
            <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="k">var</a> <span id="r44 rd" class="r44 r">layers</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#efa2b7e5b660ffdb" class="i method">LoadLayersAsync</a>();
 
            <a href="../Models/Layer.cs.html#1c0d592a36c3a08b" class="k">var</a> <span id="r45 rd" class="r45 r">layer</span> = <span class="r44 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">FirstOrDefault</span>(<span id="r46 rd" class="r46 r">x</span> =&gt; <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#372d790ddae4cbb4" class="i method">Equals</a>(<span class="r46 r">x</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a>, <span class="r43 r">name</span>));
 
            <b>if</b> (<span class="r45 r">layer</span> == <b>null</b>)
            {
                <b>return</b> <span class="i method">NotFound</span>();
            }
 
            <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="k">var</a> <span id="r47 rd" class="r47 r">widgets</span> = <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#eda4fa5789b7a92a" class="i method">GetLayerWidgetsMetadataAsync</a>(<span id="r48 rd" class="r48 r">c</span> =&gt; <span class="r48 r">c</span>.<a href="/OrchardCore.ContentManagement/A.html#448673b7f21e4a8c" class="i property">Latest</a> == <b>true</b>);
 
            <b>if</b> (!<span class="r47 r">widgets</span>.<span class="i method">Any</span>(<span id="r49 rd" class="r49 r">x</span> =&gt; <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#d47c1f57ad1e1e6e" class="i method">Equals</a>(<span class="r49 r">x</span>.<a href="../Models/LayerMetadata.cs.html#db91fa5ebc5ef808" class="i property">Layer</a>, <span class="r43 r">name</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>)))
            {
                <span class="r44 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">Remove</span>(<span class="r45 r">layer</span>);
                <b>await</b> <a href="#9cc89d6c5aac14d0" class="i field">_layerService</a>.<a href="../Services/ILayerService.cs.html#2ba6b07ab60762e3" class="i method">UpdateAsync</a>(<span class="r44 r">layers</span>);
                <a href="#31fd7882c0faf7dd" class="i field">_notifier</a>.<a href="/OrchardCore.DisplayManagement/A.html#e74a41f6547ee61c" class="i method">Success</a>(<a href="#6a87deb4b26d6634" class="i field">H</a>[<span class="s">&quot;Layer deleted successfully.&quot;</span>]);
            }
            <b>else</b>
            {
                <a href="#31fd7882c0faf7dd" class="i field">_notifier</a>.<a href="/OrchardCore.DisplayManagement/A.html#3c769e06a6afdcea" class="i method">Error</a>(<a href="#6a87deb4b26d6634" class="i field">H</a>[<span class="s">&quot;The layer couldn&#39;t be deleted: you must remove any associated widgets first.&quot;</span>]);
            }
 
            <b>return</b> <span class="i method">RedirectToAction</span>(<b>nameof</b>(<span class="i">Index</span>));
        }
 
        [<span class="t constructor">HttpPost</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="a82651e558c309d6" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdatePosition</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r50 rd" class="r50 r">contentItemId</span>, <b>double</b> <span id="r51 rd" class="r51 r">position</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r52 rd" class="r52 r">zone</span>)
        {
            <b>if</b> (!<b>await</b> <a href="#ccfd0b523a0b5795" class="i field">_authorizationService</a>.<span class="i">AuthorizeAsync</span>(<span class="i property">User</span>, <a href="../Permissions.cs.html#e82de0e7e161e6cb" class="t t">Permissions</a>.<a href="../Permissions.cs.html#ba164a79ccdaab8d" class="i field">ManageLayers</a>))
            {
                <b>return</b> <span class="i method">StatusCode</span>(401);
            }
 
            <span class="c">// Load the latest version first if any</span>
            <a href="/OrchardCore.ContentManagement.Abstractions/A.html#1099e5a609a8b2e4" class="k">var</a> <span id="r53 rd" class="r53 r">contentItem</span> = <b>await</b> <a href="#bb56c596b93cbd85" class="i field">_contentManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#978b2af9e7b3c1bd" class="i method">GetAsync</a>(<span class="r50 r">contentItemId</span>, <a href="/OrchardCore.ContentManagement.Abstractions/A.html#f6f7b8cf2eae75c0" class="t t">VersionOptions</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#b0f8d2537dc43ea6" class="i property">Latest</a>);
 
            <b>if</b> (<span class="r53 r">contentItem</span> == <b>null</b>)
            {
                <b>return</b> <span class="i method">StatusCode</span>(404);
            }
 
            <a href="../Models/LayerMetadata.cs.html#579bed763ac045dc" class="k">var</a> <span id="r54 rd" class="r54 r">layerMetadata</span> = <span class="r53 r">contentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#d72ffaa1afcfca20" class="i method">As</a>&lt;<a href="../Models/LayerMetadata.cs.html#579bed763ac045dc" class="t t">LayerMetadata</a>&gt;();
 
            <b>if</b> (<span class="r54 r">layerMetadata</span> == <b>null</b>)
            {
                <b>return</b> <span class="i method">StatusCode</span>(403);
            }
 
            <span class="r54 r">layerMetadata</span>.<a href="../Models/LayerMetadata.cs.html#83f66c7200d3e0cc" class="i property">Position</a> = <span class="r51 r">position</span>;
            <span class="r54 r">layerMetadata</span>.<a href="../Models/LayerMetadata.cs.html#54798dda07003f4b" class="i property">Zone</a> = <span class="r52 r">zone</span>;
 
            <span class="r53 r">contentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#ecb78fe59a3924fc" class="i method">Apply</a>(<span class="r54 r">layerMetadata</span>);
 
            <a href="#08402ac229f13374" class="i field">_session</a>.<span class="i">Save</span>(<span class="r53 r">contentItem</span>);
 
            <span class="c">// In case the moved contentItem is the draft for a published contentItem we update it&#39;s position too.</span>
            <span class="c">// We do that because we want the position of published and draft version to be the same.</span>
            <b>if</b> (<span class="r53 r">contentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#b8eb71eeee87e6ea" class="i method">IsPublished</a>() == <b>false</b>)
            {
                <a href="/OrchardCore.ContentManagement.Abstractions/A.html#1099e5a609a8b2e4" class="k">var</a> <span id="r55 rd" class="r55 r">publishedContentItem</span> = <b>await</b> <a href="#bb56c596b93cbd85" class="i field">_contentManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#978b2af9e7b3c1bd" class="i method">GetAsync</a>(<span class="r50 r">contentItemId</span>, <a href="/OrchardCore.ContentManagement.Abstractions/A.html#f6f7b8cf2eae75c0" class="t t">VersionOptions</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#4b49d9c14699611c" class="i property">Published</a>);
                <b>if</b> (<span class="r55 r">publishedContentItem</span> != <b>null</b>)
                {
                    <span class="r54 r">layerMetadata</span> = <span class="r53 r">contentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#d72ffaa1afcfca20" class="i method">As</a>&lt;<a href="../Models/LayerMetadata.cs.html#579bed763ac045dc" class="t t">LayerMetadata</a>&gt;();
 
                    <b>if</b> (<span class="r54 r">layerMetadata</span> == <b>null</b>)
                    {
                        <b>return</b> <span class="i method">StatusCode</span>(403);
                    }
 
                    <span class="r54 r">layerMetadata</span>.<a href="../Models/LayerMetadata.cs.html#83f66c7200d3e0cc" class="i property">Position</a> = <span class="r51 r">position</span>;
                    <span class="r54 r">layerMetadata</span>.<a href="../Models/LayerMetadata.cs.html#54798dda07003f4b" class="i property">Zone</a> = <span class="r52 r">zone</span>;
 
                    <span class="r55 r">publishedContentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#ecb78fe59a3924fc" class="i method">Apply</a>(<span class="r54 r">layerMetadata</span>);
 
                    <a href="#08402ac229f13374" class="i field">_session</a>.<span class="i">Save</span>(<span class="r55 r">publishedContentItem</span>);
                }
            }
 
            <span class="c">// The state will be updated once the ambient session is committed.</span>
            <b>await</b> <a href="#e1aba274c4387d1b" class="i field">_layerStateManager</a>.<span class="i">UpdateAsync</span>(<b>new</b> <a href="../Handlers/LayerMetadataHandler.cs.html#be09fec8e5f3ad20" class="t constructor">LayerState</a>());
 
            <b>if</b> (<span class="i property">Request</span>.<span class="i property">Headers</span> != <b>null</b> &amp;&amp; <span class="i property">Request</span>.<span class="i property">Headers</span>[<span class="s">&quot;X-Requested-With&quot;</span>] == <span class="s">&quot;XMLHttpRequest&quot;</span>)
            {
                <b>return</b> <span class="i method">StatusCode</span>(200);
            }
            <b>else</b>
            {
                <b>return</b> <span class="i method">RedirectToAction</span>(<b>nameof</b>(<span class="i">Index</span>));
            }
        }
 
        <b>private void</b> <a id="23e3e231218bf697" href="../R/23e3e231218bf697.html" target="n" data-glyph="76,1" class="i method">ValidateViewModel</a>(<a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t t">LayerEditViewModel</a> <span id="r56 rd" class="r56 r">model</span>, <a href="../Models/LayersDocument.cs.html#945f5e904ce8a1fd" class="t t">LayersDocument</a> <span id="r57 rd" class="r57 r">layers</span>, <b>bool</b> <span id="r27 rd" class="r27 r">isNew</span>)
        {
            <b>if</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#55e241b6143365ef" class="i method">IsNullOrWhiteSpace</a>(<span class="r56 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>))
            {
                <span class="i property">ModelState</span>.<span class="i method">AddModelError</span>(<b>nameof</b>(<a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t t">LayerEditViewModel</a>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>), <a href="#7ceb9a8ab05581ef" class="i field">S</a>[<span class="s">&quot;The layer name is required.&quot;</span>]);
            }
            <b>else</b> <b>if</b> (<span class="r27 r">isNew</span> &amp;&amp; <span class="r57 r">layers</span>.<a href="../Models/LayersDocument.cs.html#9fc90dd2504ea058" class="i property">Layers</a>.<span class="i method">Any</span>(<span id="r58 rd" class="r58 r">x</span> =&gt; <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#d47c1f57ad1e1e6e" class="i method">Equals</a>(<span class="r58 r">x</span>.<a href="../Models/Layer.cs.html#0acefff32be25500" class="i property">Name</a>, <span class="r56 r">model</span>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>)))
            {
                <span class="i property">ModelState</span>.<span class="i method">AddModelError</span>(<b>nameof</b>(<a href="../ViewModels/LayerEditViewModel.cs.html#8a7ee70700fcb019" class="t t">LayerEditViewModel</a>.<a href="../ViewModels/LayerEditViewModel.cs.html#956965fbd5ddf224" class="i property">Name</a>), <a href="#7ceb9a8ab05581ef" class="i field">S</a>[<span class="s">&quot;The layer name already exists.&quot;</span>]);
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
