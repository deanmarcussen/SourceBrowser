<!DOCTYPE html>
<html><head><title>SmtpSettingsConfiguration.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(59);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Email/Services/SmtpSettingsConfiguration.cs" target="_top">Services\SmtpSettingsConfiguration.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Email" target="_top">src\OrchardCore.Modules\OrchardCore.Email\OrchardCore.Email.csproj</a> (OrchardCore.Email)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">DataProtection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Logging</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Options</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Entities</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Settings</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Email</span>.<span class="i n">Services</span>
{
    <b>public class</b> <a id="39ed1cc32b666790" href="../R/39ed1cc32b666790.html" target="n" data-glyph="0,0" class="t t">SmtpSettingsConfiguration</a> : <span class="t t">IConfigureOptions</span>&lt;<a href="/OrchardCore.Email.Abstractions/A.html#ad488d80c6b5828a" class="t t">SmtpSettings</a>&gt;
    {
        <b>private readonly</b> <span class="i">ISiteService</span> <a id="d55d49c49f453862" href="../R/d55d49c49f453862.html" target="n" data-glyph="46,1" class="i field">_site</a>;
        <b>private readonly</b> <span class="t t">IDataProtectionProvider</span> <a id="9577cec175afb7da" href="../R/9577cec175afb7da.html" target="n" data-glyph="46,1" class="i field">_dataProtectionProvider</a>;
        <b>private readonly</b> <span class="t t">ILogger</span> <a id="d35f48f9b8e547ee" href="../R/d35f48f9b8e547ee.html" target="n" data-glyph="46,1" class="i field">_logger</a>;
 
        <b>public</b> <a id="d6c9ff2a059e8315" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">SmtpSettingsConfiguration</a>(
            <span class="i">ISiteService</span> <span id="r0 rd" class="r0 r">site</span>,
            <span class="t t">IDataProtectionProvider</span> <span id="r1 rd" class="r1 r">dataProtectionProvider</span>,
            <span class="t t">ILogger</span>&lt;<a href="#39ed1cc32b666790" class="t t">SmtpSettingsConfiguration</a>&gt; <span id="r2 rd" class="r2 r">logger</span>)
        {
            <a href="#d55d49c49f453862" class="i field">_site</a> = <span class="r0 r">site</span>;
            <a href="#9577cec175afb7da" class="i field">_dataProtectionProvider</a> = <span class="r1 r">dataProtectionProvider</span>;
            <a href="#d35f48f9b8e547ee" class="i field">_logger</a> = <span class="r2 r">logger</span>;
        }
 
        <b>public void</b> <a id="419dbe2294c61ee8" href="../R/419dbe2294c61ee8.html" target="n" data-glyph="72,1" class="i method">Configure</a>(<a href="/OrchardCore.Email.Abstractions/A.html#ad488d80c6b5828a" class="t t">SmtpSettings</a> <span id="r3 rd" class="r3 r">options</span>)
        {
            <b>var</b> <span id="r4 rd" class="r4 r">settings</span> = <a href="#d55d49c49f453862" class="i field">_site</a>.<span class="i">GetSiteSettingsAsync</span>()
                .<span class="i">GetAwaiter</span>().<span class="i">GetResult</span>()
                .<span class="i">As</span>&lt;<a href="/OrchardCore.Email.Abstractions/A.html#ad488d80c6b5828a" class="t t">SmtpSettings</a>&gt;();
 
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#3a9bd53e3bc48869" class="i property">DefaultSender</a> = <span class="r4 r">settings</span>.<span class="i">DefaultSender</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#84bf714d0b7f6324" class="i property">DeliveryMethod</a> = <span class="r4 r">settings</span>.<span class="i">DeliveryMethod</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#cdc288e9ec8c60df" class="i property">PickupDirectoryLocation</a> = <span class="r4 r">settings</span>.<span class="i">PickupDirectoryLocation</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#e4c26c8fce64ecec" class="i property">Host</a> = <span class="r4 r">settings</span>.<span class="i">Host</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#748f80fa428dd5c1" class="i property">Port</a> = <span class="r4 r">settings</span>.<span class="i">Port</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#74e2d124cfdb2dc1" class="i property">EncryptionMethod</a> = <span class="r4 r">settings</span>.<span class="i">EncryptionMethod</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#b7b6bd6e19c69090" class="i property">AutoSelectEncryption</a> = <span class="r4 r">settings</span>.<span class="i">AutoSelectEncryption</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#5d14af8297c89bed" class="i property">RequireCredentials</a> = <span class="r4 r">settings</span>.<span class="i">RequireCredentials</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#76bebf7eb4b7c09e" class="i property">UseDefaultCredentials</a> = <span class="r4 r">settings</span>.<span class="i">UseDefaultCredentials</span>;
            <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#9d93a3c75d07389c" class="i property">UserName</a> = <span class="r4 r">settings</span>.<span class="i">UserName</span>;
 
            <span class="c">// Decrypt the password</span>
            <b>if</b> (!<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<span class="i">IsNullOrWhiteSpace</span>(<span class="r4 r">settings</span>.<span class="i">Password</span>))
            {
                <b>try</b>
                {
                    <b>var</b> <span id="r5 rd" class="r5 r">protector</span> = <a href="#9577cec175afb7da" class="i field">_dataProtectionProvider</a>.<span class="i method">CreateProtector</span>(<b>nameof</b>(<a href="#39ed1cc32b666790" class="t t">SmtpSettingsConfiguration</a>));
                    <span class="r3 r">options</span>.<a href="/OrchardCore.Email.Abstractions/A.html#07a7595b4c453e85" class="i property">Password</a> = <span class="r5 r">protector</span>.<span class="i">Unprotect</span>(<span class="r4 r">settings</span>.<span class="i">Password</span>);
                }
                <b>catch</b>
                {
                    <a href="#d35f48f9b8e547ee" class="i field">_logger</a>.<span class="i method">LogError</span>(<span class="s">&quot;The Smtp password could not be decrypted. It may have been encrypted using a different key.&quot;</span>);
                }
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
