<!DOCTYPE html>
<html><head><title>LuceneQueryTests.cs</title><link rel="stylesheet" href="../../../styles.css"><script src="../../../scripts.js"></script></head>
<body class="cB" onload="i(164);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Tests/Apis/Lucene/LuceneQueryTests.cs" target="_top">Apis\Lucene\LuceneQueryTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Tests" target="_top">test\OrchardCore.Tests\OrchardCore.Tests.csproj</a> (OrchardCore.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>.<span class="i">Linq</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">ContentManagement</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Html</span>.<span class="i">Models</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Tests</span>.<span class="i n">Apis</span>.<span class="i n">Context</span>;
<b>using</b> <span class="i">Xunit</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Queries</span>;
<b>using</b> <span class="i">Newtonsoft</span>.<span class="i">Json</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Tests</span>.<span class="i n">Apis</span>.<span class="i n">Lucene</span>
{
    <b>public class</b> <a id="7769d2acf00202dd" href="../../R/../../0000000000.html" target="n" data-glyph="0,0" class="t t"><span id="74b68e35e7b78e30">LuceneQueryTests</span></a>
    {
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="5bfc4674dd055075" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BoostingTitleShouldHaveTitlesContainingOrchardAppearFirst</a>()
        {
            <b>using</b> (<a href="LuceneContext.cs.html#a4e2655fde6ad7f9" class="k">var</a> <span id="r0 rd" class="r0 r">context</span> = <b>new</b> <a href="LuceneContext.cs.html#304b2a85e742d914" class="t constructor">LuceneContext</a>())
            {
                <b>await</b> <span class="r0 r">context</span>.<a href="../Context/SiteContext.cs.html#b2d36471a22dff42" class="i method">InitializeAsync</a>();
 
                <span class="c">// Act</span>
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r1 rd" class="r1 r">index</span> = <span class="s">&quot;ArticleIndex&quot;</span>;
                <span class="c">// { &quot;from&quot;: 0, &quot;size&quot;: 2, &quot;query&quot;: { &quot;simple_query_string&quot;: { &quot;analyze_wildcard&quot;: true, &quot;fields&quot;: [&quot;Content.ContentItem.DisplayText.Normalized^2&quot;, &quot;HtmlBodyPart&quot;], &quot;query&quot;: &quot;orchard*&quot; } } }</span>
                <a href="#dfe3b8f435c41279" class="k">var</a> <span id="r2 rd" class="r2 r">dynamicQuery</span> = <b>new</b> {
                    <a href="#f7b51cc0dba79f0e" class="i property">from</a> = 0,
                    <a href="#91509040ea5c4a0f" class="i property">size</a> = 2,
                    <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <b>new</b> {
                        <a href="#afd1e602d25a202b" class="i property">simple_query_string</a> = <b>new</b>
                        {
                            <a href="#6488a75b72deaac5" class="i property">analyze_wildcard</a> = <b>true</b>,
                            <a href="#fbe97d08c64b2318" class="i property">fields</a> = <b>new</b> <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>[] { <span class="s">&quot;Content.ContentItem.DisplayText.Normalized^2&quot;</span>, <span class="s">&quot;HtmlBodyPart&quot;</span> },
                            <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <span class="s">&quot;orchard*&quot;</span>
                        }
                    }
                };
 
                <b>var</b> <span id="r3 rd" class="r3 r">query</span> = <span class="i">JsonConvert</span>.<span class="i">SerializeObject</span>(<span class="r2 r">dynamicQuery</span>);
 
                <b>var</b> <span id="r4 rd" class="r4 r">content</span> = <b>await</b> <span class="r0 r">context</span>.<a href="../Context/SiteContext.cs.html#f49a596e3567867c" class="i property">Client</a>.<span class="i method">GetAsync</span>(<span class="s">$&quot;</span><span class="s">api/lucene/content?indexName=</span>{<span class="r1 r">index</span>}<span class="s">&amp;query=</span>{<span class="r3 r">query</span>}<span class="s">&quot;</span>);
                <b>var</b> <span id="r5 rd" class="r5 r">queryResults</span> = <b>await</b> <span class="r4 r">content</span>.<span class="i property">Content</span>.<a href="../Context/Extensions/HttpContentExtensions.cs.html#233b0d84ea299825" class="i method">ReadAsAsync</a>&lt;<span class="i">LuceneQueryResults</span>&gt;();
 
                <span class="c">// Test</span>
                <span class="i">Assert</span>.<span class="i">Equal</span>(2, <span class="r5 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Count</span>());
                <b>var</b> <span id="r6 rd" class="r6 r">contentItems</span> = <span class="r5 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Select</span>(<span id="r7 rd" class="r7 r">x</span> =&gt; ((<span class="i">JObject</span>)<span class="r7 r">x</span>).<span class="i">ToObject</span>&lt;<span class="i">ContentItem</span>&gt;());
 
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r6 r">contentItems</span>.<span class="i">All</span>(<span id="r8 rd" class="r8 r">x</span> =&gt; <span class="r8 r">x</span>.<span class="i">DisplayText</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>)));
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="33177bf0fafab1c3" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BoostingBodyShouldHaveTitlesNotContainingOrchardAppearFirst</a>()
        {
            <b>using</b> (<a href="LuceneContext.cs.html#a4e2655fde6ad7f9" class="k">var</a> <span id="r9 rd" class="r9 r">context</span> = <b>new</b> <a href="LuceneContext.cs.html#304b2a85e742d914" class="t constructor">LuceneContext</a>())
            {
                <b>await</b> <span class="r9 r">context</span>.<a href="../Context/SiteContext.cs.html#b2d36471a22dff42" class="i method">InitializeAsync</a>();
 
                <span class="c">// Act</span>
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r10 rd" class="r10 r">index</span> = <span class="s">&quot;ArticleIndex&quot;</span>;
                <span class="c">// { &quot;from&quot;: 0, &quot;size&quot;: 2, &quot;query&quot;: { &quot;simple_query_string&quot;: { &quot;analyze_wildcard&quot;: true, &quot;fields&quot;: [&quot;Content.ContentItem.DisplayText.Normalized&quot;, &quot;HtmlBodyPart^2&quot;], &quot;query&quot;: &quot;orchard*&quot; } } }</span>
                <a href="#dfe3b8f435c41279" class="k">var</a> <span id="r11 rd" class="r11 r">dynamicQuery</span> = <b>new</b>
                {
                    <a href="#f7b51cc0dba79f0e" class="i property">from</a> = 0,
                    <a href="#91509040ea5c4a0f" class="i property">size</a> = 2,
                    <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <b>new</b>
                    {
                        <a href="#afd1e602d25a202b" class="i property">simple_query_string</a> = <b>new</b>
                        {
                            <a href="#6488a75b72deaac5" class="i property">analyze_wildcard</a> = <b>true</b>,
                            <a href="#fbe97d08c64b2318" class="i property">fields</a> = <b>new</b> <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>[] { <span class="s">&quot;Content.ContentItem.DisplayText.Normalized&quot;</span>, <span class="s">&quot;HtmlBodyPart^2&quot;</span> },
                            <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <span class="s">&quot;orchard*&quot;</span>
                        }
                    }
                };
 
                <b>var</b> <span id="r12 rd" class="r12 r">query</span> = <span class="i">JsonConvert</span>.<span class="i">SerializeObject</span>(<span class="r11 r">dynamicQuery</span>);
                <b>var</b> <span id="r13 rd" class="r13 r">content</span> = <b>await</b> <span class="r9 r">context</span>.<a href="../Context/SiteContext.cs.html#f49a596e3567867c" class="i property">Client</a>.<span class="i method">GetAsync</span>(<span class="s">$&quot;</span><span class="s">api/lucene/content?indexName=</span>{<span class="r10 r">index</span>}<span class="s">&amp;query=</span>{<span class="r12 r">query</span>}<span class="s">&quot;</span>);
                <b>var</b> <span id="r14 rd" class="r14 r">queryResults</span> = <b>await</b> <span class="r13 r">content</span>.<span class="i property">Content</span>.<a href="../Context/Extensions/HttpContentExtensions.cs.html#233b0d84ea299825" class="i method">ReadAsAsync</a>&lt;<span class="i">LuceneQueryResults</span>&gt;();
 
                <span class="c">// Test</span>
                <span class="i">Assert</span>.<span class="i">Equal</span>(2, <span class="r14 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Count</span>());
                <b>var</b> <span id="r15 rd" class="r15 r">contentItems</span> = <span class="r14 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Select</span>(<span id="r16 rd" class="r16 r">x</span> =&gt; ((<span class="i">JObject</span>)<span class="r16 r">x</span>).<span class="i">ToObject</span>&lt;<span class="i">ContentItem</span>&gt;());
 
                <span class="i">Assert</span>.<span class="i">False</span>(<span class="r15 r">contentItems</span>.<span class="i">All</span>(<span id="r17 rd" class="r17 r">x</span> =&gt; <span class="r17 r">x</span>.<span class="i">DisplayText</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>)));
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="825e98dd3f099756" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SimpleQueryWildcardHasResults</a>()
        {
            <b>using</b> (<a href="LuceneContext.cs.html#a4e2655fde6ad7f9" class="k">var</a> <span id="r18 rd" class="r18 r">context</span> = <b>new</b> <a href="LuceneContext.cs.html#304b2a85e742d914" class="t constructor">LuceneContext</a>())
            {
                <b>await</b> <span class="r18 r">context</span>.<a href="../Context/SiteContext.cs.html#b2d36471a22dff42" class="i method">InitializeAsync</a>();
                <span class="c">// Act</span>
                <span class="c">// Should find articles with &quot;Orchard&quot; in the title</span>
 
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r19 rd" class="r19 r">index</span> = <span class="s">&quot;ArticleIndex&quot;</span>;
 
                <span class="c">// { &quot;from&quot;: 0, &quot;size&quot;: 1, &quot;query&quot;: { &quot;simple_query_string&quot;: { &quot;analyze_wildcard&quot;: true, &quot;fields&quot;: [&quot;Content.ContentItem.DisplayText.Normalized&quot;], &quot;query&quot;: &quot;orch*&quot; } } }</span>
                <b>object</b> <span id="r20 rd" class="r20 r">dynamicQuery</span> = <b>new</b>
                {
                    <a href="#f7b51cc0dba79f0e" class="i property">from</a> = 0,
                    <a href="#91509040ea5c4a0f" class="i property">size</a> = 1,
                    <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <b>new</b>
                    {
                        <a href="#afd1e602d25a202b" class="i property">simple_query_string</a> = <b>new</b>
                        {
                            <a href="#6488a75b72deaac5" class="i property">analyze_wildcard</a> = <b>true</b>,
                            <a href="#fbe97d08c64b2318" class="i property">fields</a> = <b>new</b> <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>[] { <span class="s">&quot;Content.ContentItem.DisplayText.Normalized&quot;</span> },
                            <a href="#d07fa9d9c0eaa17c" class="i property">query</a> = <span class="s">&quot;orch*&quot;</span>
                        }
                    }
                };
 
                <b>var</b> <span id="r21 rd" class="r21 r">query</span> = <span class="i">JsonConvert</span>.<span class="i">SerializeObject</span>(<span class="r20 r">dynamicQuery</span>);
 
                <b>var</b> <span id="r22 rd" class="r22 r">content</span> = <b>await</b> <span class="r18 r">context</span>.<a href="../Context/SiteContext.cs.html#f49a596e3567867c" class="i property">Client</a>.<span class="i method">GetAsync</span>(<span class="s">$&quot;</span><span class="s">api/lucene/content?indexName=</span>{<span class="r19 r">index</span>}<span class="s">&amp;query=</span>{<span class="r21 r">query</span>}<span class="s">&quot;</span>);
                <b>var</b> <span id="r23 rd" class="r23 r">queryResults</span> = <b>await</b> <span class="r22 r">content</span>.<span class="i property">Content</span>.<a href="../Context/Extensions/HttpContentExtensions.cs.html#233b0d84ea299825" class="i method">ReadAsAsync</a>&lt;<span class="i">LuceneQueryResults</span>&gt;();
 
                <span class="c">// Test</span>
                <span class="i">Assert</span>.<span class="i">NotEmpty</span>(<span class="r23 r">queryResults</span>.<span class="i">Items</span>);
                <b>var</b> <span id="r24 rd" class="r24 r">contentItems</span> = <span class="r23 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Select</span>(<span id="r25 rd" class="r25 r">x</span> =&gt; ((<span class="i">JObject</span>)<span class="r25 r">x</span>).<span class="i">ToObject</span>&lt;<span class="i">ContentItem</span>&gt;());
 
                <span class="i">Assert</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <span class="r24 r">contentItems</span>.<span class="i">First</span>().<span class="i">DisplayText</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>);
            }
        }
 
        [<span class="i">Fact</span>]
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="a86bcbefc6a6ab48" href="../../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">TwoWildcardQueriesWithBoostHasResults</a>()
        {
            <b>using</b> (<a href="LuceneContext.cs.html#a4e2655fde6ad7f9" class="k">var</a> <span id="r26 rd" class="r26 r">context</span> = <b>new</b> <a href="LuceneContext.cs.html#304b2a85e742d914" class="t constructor">LuceneContext</a>())
            {
                <b>await</b> <span class="r26 r">context</span>.<a href="../Context/SiteContext.cs.html#b2d36471a22dff42" class="i method">InitializeAsync</a>();
 
                <span class="c">// Act</span>
                <span class="c">// Should find articles with &quot;Orchard&quot; in the title</span>
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r27 rd" class="r27 r">index</span> = <span class="s">&quot;ArticleIndex&quot;</span>;
 
                <span class="c">// { &quot;from&quot;: 0, &quot;size&quot;: 10, &quot;query&quot;:{ &quot;bool&quot;: { &quot;should&quot;: [ { &quot;wildcard&quot;: {  &quot;Content.ContentItem.DisplayText.Normalized&quot;: { &quot;value&quot;: &quot;orch*&quot;, &quot;boost&quot;: 2 } } },{ &quot;wildcard&quot;: { &quot;HtmlBodyPart&quot;: { &quot;value&quot;: &quot;orchar*&quot;, &quot;boost&quot;: 5 } } } ] } } }</span>
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r28 rd" class="r28 r">query</span> =
                    <span class="s">&quot;{ \&quot;from\&quot;: 0, \&quot;size\&quot;: 10, \&quot;query\&quot;:&quot;</span> +
                        <span class="s">&quot;{ \&quot;bool\&quot;: { \&quot;should\&quot;: [ &quot;</span> +
                            <span class="s">&quot;{ \&quot;wildcard\&quot;: {  \&quot;Content.ContentItem.DisplayText.Normalized\&quot;: { \&quot;value\&quot;: \&quot;orch*\&quot;, \&quot;boost\&quot;: 2 } } },&quot;</span> +
                            <span class="s">&quot;{ \&quot;wildcard\&quot;: { \&quot;HtmlBodyPart\&quot;: { \&quot;value\&quot;: \&quot;orchar*\&quot;, \&quot;boost\&quot;: 5 } } }&quot;</span> +
                        <span class="s">&quot;] } } }&quot;</span>;
 
                <b>var</b> <span id="r29 rd" class="r29 r">content</span> = <b>await</b> <span class="r26 r">context</span>.<a href="../Context/SiteContext.cs.html#f49a596e3567867c" class="i property">Client</a>.<span class="i method">GetAsync</span>(<span class="s">$&quot;</span><span class="s">api/lucene/content?indexName=</span>{<span class="r27 r">index</span>}<span class="s">&amp;query=</span>{<span class="r28 r">query</span>}<span class="s">&quot;</span>);
                <b>var</b> <span id="r30 rd" class="r30 r">queryResults</span> = <b>await</b> <span class="r29 r">content</span>.<span class="i property">Content</span>.<a href="../Context/Extensions/HttpContentExtensions.cs.html#233b0d84ea299825" class="i method">ReadAsAsync</a>&lt;<span class="i">LuceneQueryResults</span>&gt;();
                <b>var</b> <span id="r31 rd" class="r31 r">contentItems</span> = <span class="r30 r">queryResults</span>.<span class="i">Items</span>.<span class="i">Select</span>(<span id="r32 rd" class="r32 r">x</span> =&gt; ((<span class="i">JObject</span>)<span class="r32 r">x</span>).<span class="i">ToObject</span>&lt;<span class="i">ContentItem</span>&gt;());
 
                <span class="c">// Test</span>
                <span class="i">Assert</span>.<span class="i">NotEmpty</span>(<span class="r31 r">contentItems</span>);
                <span class="i">Assert</span>.<span class="i">True</span>(<span class="r31 r">contentItems</span>.<span class="i">Count</span>() &gt;= 4);
 
                <span class="i">Assert</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <span class="r31 r">contentItems</span>.<span class="i">ElementAt</span>(0).<span class="i">As</span>&lt;<span class="i">HtmlBodyPart</span>&gt;().<span class="i">Html</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>);
                <span class="i">Assert</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <span class="r31 r">contentItems</span>.<span class="i">ElementAt</span>(1).<span class="i">As</span>&lt;<span class="i">HtmlBodyPart</span>&gt;().<span class="i">Html</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>);
                <span class="i">Assert</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <span class="r31 r">contentItems</span>.<span class="i">ElementAt</span>(2).<span class="i">DisplayText</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>);
                <span class="i">Assert</span>.<span class="i">Contains</span>(<span class="s">&quot;Orchard&quot;</span>, <span class="r31 r">contentItems</span>.<span class="i">ElementAt</span>(3).<span class="i">DisplayText</span>, <a href="@1@System.Runtime/A.html#702797def97ecb7c" class="t t">StringComparison</a>.<a href="@1@System.Runtime/A.html#6c3139b940557bf9" class="i field">OrdinalIgnoreCase</a>);
            };
        }
    }
}
</pre></td></tr></table></div></body></html>
