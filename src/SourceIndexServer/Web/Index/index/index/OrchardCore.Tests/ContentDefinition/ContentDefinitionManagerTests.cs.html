<!DOCTYPE html>
<html><head><title>ContentDefinitionManagerTests.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(255);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Tests/ContentDefinition/ContentDefinitionManagerTests.cs" target="_top">ContentDefinition\ContentDefinitionManagerTests.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Tests" target="_top">test\OrchardCore.Tests\OrchardCore.Tests.csproj</a> (OrchardCore.Tests)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<span class="c">//using Microsoft.Extensions.DependencyInjection;</span>
<span class="c">//using Microsoft.Extensions.Logging;</span>
<span class="c">//using OrchardCore.ContentManagement.Metadata;</span>
<span class="c">//using OrchardCore.ContentManagement.Metadata;</span>
<span class="c">//using OrchardCore.ContentManagement.Metadata.Builders;</span>
<span class="c">//using System;</span>
<span class="c">//using System.Collections.Generic;</span>
<span class="c">//using System.Linq;</span>
<span class="c">//using System.Threading.Tasks;</span>
<span class="c">//using Xunit;</span>
<span class="c">//using YesSql;</span>
 
<span class="c">//namespace OrchardCore.Tests.ContentDefinition</span>
<span class="c">//{</span>
<span class="c">//    public class ContentDefinitionManagerTests</span>
<span class="c">//    {</span>
<span class="c">//        IServiceProvider _serviceProvider;</span>
<span class="c">//        ISession _session;</span>
<span class="c">//        IContentDefinitionManager _contentDefinitionManager;</span>
 
<span class="c">//        public ContentDefinitionManagerTests()</span>
<span class="c">//        {</span>
<span class="c">//            IServiceCollection serviceCollection = new ServiceCollection();</span>
 
<span class="c">//            serviceCollection.AddScoped&lt;ILoggerFactory, StubLoggerFactory&gt;();</span>
<span class="c">//            serviceCollection.AddScoped&lt;ISession, &gt;();</span>
 
<span class="c">//            serviceCollection.AddScoped&lt;IContentDefinitionManager, ContentDefinitionManager&gt;();</span>
 
<span class="c">//            _serviceProvider = serviceCollection.BuildServiceProvider();</span>
 
<span class="c">//            _session = _serviceProvider.GetService&lt;ISession&gt;();</span>
<span class="c">//            _contentDefinitionManager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//        }</span>
 
<span class="c">//        [Fact]</span>
<span class="c">//        public void NoTypesAreAvailableByDefault()</span>
<span class="c">//        {</span>
<span class="c">//            var types = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;().ListTypeDefinitions();</span>
<span class="c">//            Assert.Equal(0, types.Count());</span>
<span class="c">//        }</span>
 
<span class="c">//        [Fact]</span>
<span class="c">//        public void ContentTypesWithSettingsCanBeCreatedAndModified()</span>
<span class="c">//        {</span>
<span class="c">//            var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//            manager.StoreTypeDefinition(new ContentTypeDefinitionBuilder()</span>
<span class="c">//                                  .Named(&quot;alpha&quot;)</span>
<span class="c">//                                  .WithSetting(&quot;a&quot;, &quot;1&quot;)</span>
<span class="c">//                                  .WithSetting(&quot;b&quot;, &quot;2&quot;)</span>
<span class="c">//                                  .Build());</span>
 
<span class="c">//            manager.StoreTypeDefinition(new ContentTypeDefinitionBuilder()</span>
<span class="c">//                                  .Named(&quot;beta&quot;)</span>
<span class="c">//                                  .WithSetting(&quot;c&quot;, &quot;3&quot;)</span>
<span class="c">//                                  .WithSetting(&quot;d&quot;, &quot;4&quot;)</span>
<span class="c">//                                  .Build());</span>
 
<span class="c">//            var types1 = manager.ListTypeDefinitions();</span>
<span class="c">//            Assert.Equal(2, types1.Count());</span>
<span class="c">//            var alpha1 = types1.Single(t =&gt; t.Name == &quot;alpha&quot;);</span>
<span class="c">//            Assert.Equal(&quot;1&quot;, alpha1.Settings[&quot;a&quot;]);</span>
<span class="c">//            manager.StoreTypeDefinition(new ContentTypeDefinitionBuilder(alpha1).WithSetting(&quot;a&quot;, &quot;5&quot;).Build());</span>
 
<span class="c">//            var types2 = manager.ListTypeDefinitions();</span>
<span class="c">//            Assert.Equal(2, types2.Count());</span>
<span class="c">//            var alpha2 = types2.Single(t =&gt; t.Name == &quot;alpha&quot;);</span>
<span class="c">//            Assert.Equal(&quot;5&quot;, alpha2.Settings[&quot;a&quot;]);</span>
<span class="c">//        }</span>
 
<span class="c">//        [Fact]</span>
<span class="c">//        public void StubPartDefinitionsAreCreatedWhenContentTypesAreStored()</span>
<span class="c">//        {</span>
<span class="c">//            var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//            manager.StoreTypeDefinition(new ContentTypeDefinitionBuilder()</span>
<span class="c">//                                  .Named(&quot;alpha&quot;)</span>
<span class="c">//                                  .WithPart(&quot;foo&quot;, pb =&gt; { })</span>
<span class="c">//                                  .Build());</span>
 
<span class="c">//            var foo = manager.GetPartDefinition(&quot;foo&quot;);</span>
<span class="c">//            Assert.NotNull(foo);</span>
<span class="c">//            Assert.Equal(&quot;foo&quot;, foo.Name);</span>
 
<span class="c">//            var alpha = manager.GetTypeDefinition(&quot;alpha&quot;);</span>
<span class="c">//            Assert.NotNull(alpha);</span>
<span class="c">//            Assert.Equal(1, alpha.Parts.Count());</span>
<span class="c">//            Assert.Equal(&quot;foo&quot;, alpha.Parts.Single().PartDefinition.Name);</span>
<span class="c">//        }</span>
 
<span class="c">//        [Fact]</span>
<span class="c">//        public void GettingDefinitionsByNameCanReturnNullAndWillAcceptNullEmptyOrInvalidNames()</span>
<span class="c">//        {</span>
<span class="c">//            var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//            Assert.Null(manager.GetTypeDefinition(&quot;no such name&quot;));</span>
<span class="c">//            Assert.Null(manager.GetTypeDefinition(string.Empty));</span>
<span class="c">//            Assert.Null(manager.GetTypeDefinition(null));</span>
<span class="c">//            Assert.Null(manager.GetPartDefinition(&quot;no such name&quot;));</span>
<span class="c">//            Assert.Null(manager.GetPartDefinition(string.Empty));</span>
<span class="c">//            Assert.Null(manager.GetPartDefinition(null));</span>
<span class="c">//        }</span>
 
<span class="c">//        //[Fact]</span>
<span class="c">//        //public void PartsAreRemovedWhenNotReferencedButPartDefinitionRemains()</span>
<span class="c">//        //{</span>
<span class="c">//        //    var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//        //    manager.StoreTypeDefinition(</span>
<span class="c">//        //        new ContentTypeDefinitionBuilder()</span>
<span class="c">//        //            .Named(&quot;alpha&quot;)</span>
<span class="c">//        //            .WithPart(&quot;foo&quot;, pb =&gt; { })</span>
<span class="c">//        //            .WithPart(&quot;bar&quot;, pb =&gt; { })</span>
<span class="c">//        //            .Build());</span>
 
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;foo&quot;, &quot;bar&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(2));</span>
<span class="c">//        //    ResetSession();</span>
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;foo&quot;, &quot;bar&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(2));</span>
 
<span class="c">//        //    manager.StoreTypeDefinition(</span>
<span class="c">//        //        new ContentTypeDefinitionBuilder(manager.GetTypeDefinition(&quot;alpha&quot;))</span>
<span class="c">//        //            .WithPart(&quot;frap&quot;, pb =&gt; { })</span>
<span class="c">//        //            .RemovePart(&quot;bar&quot;)</span>
<span class="c">//        //            .Build());</span>
 
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;foo&quot;, &quot;frap&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(3));</span>
<span class="c">//        //    ResetSession();</span>
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;foo&quot;, &quot;frap&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(3));</span>
<span class="c">//        //}</span>
 
<span class="c">//        //[Fact]</span>
<span class="c">//        //public void PartsCanBeDeleted()</span>
<span class="c">//        //{</span>
<span class="c">//        //    var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//        //    manager.StoreTypeDefinition(</span>
<span class="c">//        //        new ContentTypeDefinitionBuilder()</span>
<span class="c">//        //            .Named(&quot;alpha&quot;)</span>
<span class="c">//        //            .WithPart(&quot;foo&quot;, pb =&gt; { })</span>
<span class="c">//        //            .WithPart(&quot;bar&quot;, pb =&gt; { })</span>
<span class="c">//        //            .Build());</span>
 
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;foo&quot;, &quot;bar&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(2));</span>
 
<span class="c">//        //    manager.DeletePartDefinition(&quot;foo&quot;);</span>
<span class="c">//        //    ResetSession();</span>
 
<span class="c">//        //    AssertThatTypeHasParts(&quot;alpha&quot;, &quot;bar&quot;);</span>
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(1));</span>
<span class="c">//        //}</span>
 
<span class="c">//        //[Fact]</span>
<span class="c">//        //public void ContentTypesCanBeDeleted()</span>
<span class="c">//        //{</span>
<span class="c">//        //    var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//        //    manager.StoreTypeDefinition(</span>
<span class="c">//        //        new ContentTypeDefinitionBuilder()</span>
<span class="c">//        //            .Named(&quot;alpha&quot;)</span>
<span class="c">//        //            .WithPart(&quot;foo&quot;, pb =&gt; { })</span>
<span class="c">//        //            .WithPart(&quot;bar&quot;, pb =&gt; { })</span>
<span class="c">//        //            .Build());</span>
 
<span class="c">//        //    Assert.That(manager.GetTypeDefinition(&quot;alpha&quot;), Is.Not.Null);</span>
<span class="c">//        //    manager.DeleteTypeDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    ResetSession();</span>
 
<span class="c">//        //    Assert.That(manager.GetTypeDefinition(&quot;alpha&quot;), Is.Null);</span>
<span class="c">//        //}</span>
 
<span class="c">//        //[Fact]</span>
<span class="c">//        //public void MultipleFieldsCanBeAddedToImplicitParts()</span>
<span class="c">//        //{</span>
<span class="c">//        //    var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
<span class="c">//        //    manager.StorePartDefinition(</span>
<span class="c">//        //        new ContentPartDefinitionBuilder()</span>
<span class="c">//        //            .Named(&quot;alpha&quot;)</span>
<span class="c">//        //            .WithField(&quot;field1&quot;, f =&gt; f.OfType(&quot;TextField&quot;))</span>
<span class="c">//        //            .WithField(&quot;field2&quot;, f =&gt; f.OfType(&quot;TextField&quot;))</span>
<span class="c">//        //            .Build()</span>
<span class="c">//        //        );</span>
 
<span class="c">//        //    manager.StoreTypeDefinition(</span>
<span class="c">//        //        new ContentTypeDefinitionBuilder()</span>
<span class="c">//        //            .Named(&quot;alpha&quot;)</span>
<span class="c">//        //            .WithPart(&quot;foo&quot;)</span>
<span class="c">//        //            .Build()</span>
<span class="c">//        //        );</span>
 
<span class="c">//        //    ResetSession();</span>
 
<span class="c">//        //    var types = manager.ListTypeDefinitions();</span>
<span class="c">//        //    Assert.That(types.Count(), Is.EqualTo(1));</span>
<span class="c">//        //    var parts = manager.ListPartDefinitions();</span>
<span class="c">//        //    Assert.That(parts.Count(), Is.EqualTo(2));</span>
<span class="c">//        //    var fields = manager.ListFieldDefinitions();</span>
<span class="c">//        //    Assert.That(fields.Count(), Is.EqualTo(1));</span>
 
<span class="c">//        //    var alpha = manager.GetTypeDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    Assert.That(alpha.Parts.Count(), Is.EqualTo(1));</span>
 
<span class="c">//        //    var part = manager.GetPartDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    Assert.That(part.Fields.Count(), Is.EqualTo(2));</span>
 
<span class="c">//        //    manager.AlterPartDefinition(&quot;alpha&quot;, p =&gt; p</span>
<span class="c">//        //            .WithField(&quot;field3&quot;, f =&gt; f.OfType(&quot;TextField&quot;))</span>
<span class="c">//        //            .WithField(&quot;field4&quot;, f =&gt; f.OfType(&quot;TextField&quot;))</span>
<span class="c">//        //        );</span>
 
<span class="c">//        //    ResetSession();</span>
 
<span class="c">//        //    part = manager.GetPartDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    Assert.That(part.Fields.Count(), Is.EqualTo(4));</span>
 
<span class="c">//        //    alpha = manager.GetTypeDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    Assert.That(alpha.Parts.Count(), Is.EqualTo(1));</span>
<span class="c">//        //}</span>
 
<span class="c">//        //[Fact]</span>
<span class="c">//        //public void DontCreateMultiplePartsWhenAddingMultipleFields()</span>
<span class="c">//        //{</span>
<span class="c">//        //    var manager = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;();</span>
 
<span class="c">//        //    manager.AlterPartDefinition(&quot;alpha&quot;,</span>
<span class="c">//        //            part =&gt; part</span>
<span class="c">//        //                .WithField(&quot;StartDate&quot;, cfg =&gt; cfg</span>
<span class="c">//        //                    .WithDisplayName(&quot;Start Date&quot;)</span>
<span class="c">//        //                    .OfType(&quot;DateTimeField&quot;)</span>
<span class="c">//        //                    .WithSetting(&quot;DateTimeFieldSettings.Display&quot;, &quot;DateAndTime&quot;))</span>
<span class="c">//        //                .WithField(&quot;EndDate&quot;, cfg =&gt; cfg</span>
<span class="c">//        //                    .WithDisplayName(&quot;End Date&quot;)</span>
<span class="c">//        //                    .OfType(&quot;DateTimeField&quot;)</span>
<span class="c">//        //                    .WithSetting(&quot;DateTimeFieldSettings.Display&quot;, &quot;DateAndTime&quot;))</span>
<span class="c">//        //        );</span>
 
<span class="c">//        //    Assert.That(manager.ListPartDefinitions().Count(), Is.EqualTo(1));</span>
 
<span class="c">//        //    var p = manager.GetPartDefinition(&quot;alpha&quot;);</span>
<span class="c">//        //    Assert.That(p.Fields.Count(), Is.EqualTo(2));</span>
<span class="c">//        //}</span>
 
<span class="c">//        //private void AssertThatTypeHasParts(string typeName, params string[] partNames)</span>
<span class="c">//        //{</span>
<span class="c">//        //    var type = _serviceProvider.GetService&lt;IContentDefinitionManager&gt;().GetTypeDefinition(typeName);</span>
<span class="c">//        //    Assert.That(type, Is.Not.Null);</span>
<span class="c">//        //    Assert.That(type.Parts.Count(), Is.EqualTo(partNames.Count()));</span>
<span class="c">//        //    foreach (var partName in partNames)</span>
<span class="c">//        //    {</span>
<span class="c">//        //        Assert.That(type.Parts.Select(p =&gt; p.PartDefinition.Name), Has.Some.EqualTo(partName));</span>
<span class="c">//        //    }</span>
<span class="c">//        //}</span>
 
<span class="c">//    }</span>
<span class="c">//}</span>
</pre></td></tr></table></div></body></html>
