<!DOCTYPE html>
<html><head><title>Migrations.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(178);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Taxonomies/Migrations.cs" target="_top">Migrations.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Taxonomies" target="_top">src\OrchardCore.Modules\OrchardCore.Taxonomies\OrchardCore.Taxonomies.csproj</a> (OrchardCore.Taxonomies)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Metadata</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Metadata</span>.<span class="i n">Settings</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Records</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Data</span>.<span class="i n">Migration</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Taxonomies</span>.<span class="i n">Fields</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Taxonomies</span>.<span class="i n">Indexing</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Taxonomies</span>.<span class="i n">Settings</span>;
<b>using</b> <span class="i">YesSql</span>.<span class="i">Sql</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Taxonomies</span>
{
    <b>public class</b> <a id="7009db858ceba649" href="R/7009db858ceba649.html" target="n" data-glyph="0,0" class="t t">Migrations</a> : <span class="i">DataMigration</span>
    {
        <b>private</b> <a href="/OrchardCore.ContentManagement.Abstractions/A.html#d83ce13dd2923822" class="t t">IContentDefinitionManager</a> <a id="79d8fb053936f857" href="R/79d8fb053936f857.html" target="n" data-glyph="46,1" class="i field">_contentDefinitionManager</a>;
 
        <b>public</b> <a id="058470cacf487380" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">Migrations</a>(<a href="/OrchardCore.ContentManagement.Abstractions/A.html#d83ce13dd2923822" class="t t">IContentDefinitionManager</a> <span id="r0 rd" class="r0 r">contentDefinitionManager</span>)
        {
            <a href="#79d8fb053936f857" class="i field">_contentDefinitionManager</a> = <span class="r0 r">contentDefinitionManager</span>;
        }
 
        <b>public int</b> <a id="70c7414feafca825" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Create</a>()
        {
            <a href="#79d8fb053936f857" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#2855c688da7a4dda" class="i method">AlterTypeDefinition</a>(<span class="s">&quot;Taxonomy&quot;</span>, <span id="r1 rd" class="r1 r">taxonomy</span> =&gt; <span class="r1 r">taxonomy</span>
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#29168d2f9d578a9c" class="i method">Draftable</a>()
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#13d289f11dc675ab" class="i method">Versionable</a>()
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#cd04ee098db76f3c" class="i method">Creatable</a>()
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#e3aede6f3e829869" class="i method">Listable</a>()
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;TitlePart&quot;</span>, <span id="r2 rd" class="r2 r">part</span> =&gt; <span class="r2 r">part</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;1&quot;</span>))
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;AliasPart&quot;</span>, <span id="r3 rd" class="r3 r">part</span> =&gt; <span class="r3 r">part</span>
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;2&quot;</span>)
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#311e1b56676aab30" class="i method">WithSettings</a>(<b>new</b> <a href="#31cf96dbe226a655" class="t constructor">AliasPartSettings</a>
                    {
                        <a href="#8a53a988589ff449" class="i property">Pattern</a> = <span class="s">&quot;{{ Model.ContentItem | display_text | slugify }}&quot;</span>
                    }))
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;AutoroutePart&quot;</span>, <span id="r4 rd" class="r4 r">part</span> =&gt; <span class="r4 r">part</span>
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;3&quot;</span>)
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#311e1b56676aab30" class="i method">WithSettings</a>(<b>new</b> <a href="#09f5197c366f170e" class="t constructor">AutoroutePartSettings</a>
                    {
                        <a href="#551d8b94e9e9357f" class="i property">Pattern</a> = <span class="s">&quot;{{ Model.ContentItem | display_text | slugify }}&quot;</span>,
                        <a href="#711fa5aae5a4bb08" class="i property">AllowRouteContainedItems</a> = <b>true</b>
                    }))
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;TaxonomyPart&quot;</span>, <span id="r5 rd" class="r5 r">part</span> =&gt; <span class="r5 r">part</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;4&quot;</span>))
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r6 rd" class="r6 r">table</span> =&gt; <span class="r6 r">table</span>
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;TaxonomyContentItemId&quot;</span>, <span id="r7 rd" class="r7 r">c</span> =&gt; <span class="r7 r">c</span>.<span class="i">WithLength</span>(26))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ContentItemId&quot;</span>, <span id="r8 rd" class="r8 r">c</span> =&gt; <span class="r8 r">c</span>.<span class="i">WithLength</span>(26))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ContentType&quot;</span>, <span id="r9 rd" class="r9 r">column</span> =&gt; <span class="r9 r">column</span>.<span class="i">WithLength</span>(<a href="/OrchardCore.ContentManagement/A.html#6661bef7de8cf3d4" class="t t">ContentItemIndex</a>.<a href="/OrchardCore.ContentManagement/A.html#5d7e9bd5bf48039c" class="i field">MaxContentTypeSize</a>))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ContentPart&quot;</span>, <span id="r10 rd" class="r10 r">column</span> =&gt; <span class="r10 r">column</span>.<span class="i">WithLength</span>(<a href="/OrchardCore.ContentManagement/A.html#6661bef7de8cf3d4" class="t t">ContentItemIndex</a>.<a href="/OrchardCore.ContentManagement/A.html#aecc711a95eb427e" class="i field">MaxContentPartSize</a>))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ContentField&quot;</span>, <span id="r11 rd" class="r11 r">column</span> =&gt; <span class="r11 r">column</span>.<span class="i">WithLength</span>(<a href="/OrchardCore.ContentManagement/A.html#6661bef7de8cf3d4" class="t t">ContentItemIndex</a>.<a href="/OrchardCore.ContentManagement/A.html#b47efa2f640e6cb2" class="i field">MaxContentFieldSize</a>))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;TermContentItemId&quot;</span>, <span id="r12 rd" class="r12 r">column</span> =&gt; <span class="r12 r">column</span>.<span class="i">WithLength</span>(26))
                .<span class="i">Column</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Published&quot;</span>, <span id="r13 rd" class="r13 r">c</span> =&gt; <span class="r13 r">c</span>.<span class="i">WithDefault</span>(<b>true</b>))
                .<span class="i">Column</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Latest&quot;</span>, <span id="r14 rd" class="r14 r">c</span> =&gt; <span class="r14 r">c</span>.<span class="i">WithDefault</span>(<b>false</b>))
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r15 rd" class="r15 r">table</span> =&gt; <span class="r15 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_TaxonomyIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;TaxonomyContentItemId&quot;</span>,
                    <span class="s">&quot;ContentItemId&quot;</span>,
                    <span class="s">&quot;TermContentItemId&quot;</span>,
                    <span class="s">&quot;Published&quot;</span>,
                    <span class="s">&quot;Latest&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r16 rd" class="r16 r">table</span> =&gt; <span class="r16 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_TaxonomyIndex_DocumentId_ContentType&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;ContentType&quot;</span>,
                    <span class="s">&quot;ContentPart&quot;</span>,
                    <span class="s">&quot;ContentField&quot;</span>,
                    <span class="s">&quot;Published&quot;</span>,
                    <span class="s">&quot;Latest&quot;</span>)
            );
 
            <span class="c">// Shortcut other migration steps on new content definition schemas.</span>
            <b>return</b> 5;
        }
 
        <span class="c">// Migrate FieldSettings. This only needs to run on old content definition schemas.</span>
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="ea28ca32bf525e7e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom1</a>()
        {
            <a href="#79d8fb053936f857" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#86395f0575731085" class="i method">MigrateFieldSettings</a>&lt;<a href="Fields/TaxonomyField.cs.html#9facaea9e47d8f0c" class="t t">TaxonomyField</a>, <a href="Settings/TaxonomyFieldSettings.cs.html#523060e0b9d64f4f" class="t t">TaxonomyFieldSettings</a>&gt;();
            <b>return</b> 2;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="039f11724c49ca61" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom2</a>()
        {
            <a href="#79d8fb053936f857" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#2855c688da7a4dda" class="i method">AlterTypeDefinition</a>(<span class="s">&quot;Taxonomy&quot;</span>, <span id="r17 rd" class="r17 r">taxonomy</span> =&gt; <span class="r17 r">taxonomy</span>
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;AutoroutePart&quot;</span>, <span id="r18 rd" class="r18 r">part</span> =&gt; <span class="r18 r">part</span>
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;3&quot;</span>)
                    .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#311e1b56676aab30" class="i method">WithSettings</a>(<b>new</b> <a href="#09f5197c366f170e" class="t constructor">AutoroutePartSettings</a>
                    {
                        <a href="#551d8b94e9e9357f" class="i property">Pattern</a> = <span class="s">&quot;{{ Model.ContentItem | display_text | slugify }}&quot;</span>,
                        <a href="#711fa5aae5a4bb08" class="i property">AllowRouteContainedItems</a> = <b>true</b>
                    }))
                .<a href="/OrchardCore.ContentManagement.Abstractions/A.html#40c0e856416c12d2" class="i method">WithPart</a>(<span class="s">&quot;TaxonomyPart&quot;</span>, <span id="r19 rd" class="r19 r">part</span> =&gt; <span class="r19 r">part</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#7cf5e24d7c6f34e6" class="i method">WithPosition</a>(<span class="s">&quot;4&quot;</span>))
            );
 
            <b>return</b> 3;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="fa08601e155b506d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom3</a>()
        {
            <span class="c">// This step has been updated to also add these new columns.</span>
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r20 rd" class="r20 r">table</span> =&gt; <span class="r20 r">table</span>
                .<span class="i">AddColumn</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Published&quot;</span>, <span id="r21 rd" class="r21 r">c</span> =&gt; <span class="r21 r">c</span>.<span class="i">WithDefault</span>(<b>true</b>))
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r22 rd" class="r22 r">table</span> =&gt; <span class="r22 r">table</span>
                .<span class="i">AddColumn</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Latest&quot;</span>, <span id="r23 rd" class="r23 r">c</span> =&gt; <span class="r23 r">c</span>.<span class="i">WithDefault</span>(<b>false</b>))
            );
 
            <span class="c">// So that the new indexes can be fully created.</span>
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r24 rd" class="r24 r">table</span> =&gt; <span class="r24 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_TaxonomyIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;TaxonomyContentItemId&quot;</span>,
                    <span class="s">&quot;ContentItemId&quot;</span>,
                    <span class="s">&quot;TermContentItemId&quot;</span>,
                    <span class="s">&quot;Published&quot;</span>,
                    <span class="s">&quot;Latest&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r25 rd" class="r25 r">table</span> =&gt; <span class="r25 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_TaxonomyIndex_DocumentId_ContentType&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;ContentType&quot;</span>,
                    <span class="s">&quot;ContentPart&quot;</span>,
                    <span class="s">&quot;ContentField&quot;</span>,
                    <span class="s">&quot;Published&quot;</span>,
                    <span class="s">&quot;Latest&quot;</span>)
            );
 
            <span class="c">// We then shortcut the next migration step.</span>
            <b>return</b> 5;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="7e3a95a98adf6614" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom4</a>()
        {
            <span class="c">// This step run only if the previous one was executed before</span>
            <span class="c">// it was updated, so here we also add the following columns.</span>
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r26 rd" class="r26 r">table</span> =&gt; <span class="r26 r">table</span>
                .<span class="i">AddColumn</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Published&quot;</span>, <span id="r27 rd" class="r27 r">c</span> =&gt; <span class="r27 r">c</span>.<span class="i">WithDefault</span>(<b>true</b>))
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r28 rd" class="r28 r">table</span> =&gt; <span class="r28 r">table</span>
                .<span class="i">AddColumn</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;Latest&quot;</span>, <span id="r29 rd" class="r29 r">c</span> =&gt; <span class="r29 r">c</span>.<span class="i">WithDefault</span>(<b>false</b>))
            );
 
            <span class="c">// But we create a separate index for these new columns.</span>
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="Indexing/TaxonomyIndex.cs.html#c8aa09bdfb1d694d" class="t t">TaxonomyIndex</a>&gt;(<span id="r30 rd" class="r30 r">table</span> =&gt; <span class="r30 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_TaxonomyIndex_DocumentId_Published&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;Published&quot;</span>,
                    <span class="s">&quot;Latest&quot;</span>)
            );
 
            <b>return</b> 5;
        }
    }
 
    <b>internal class</b> <a id="31cf96dbe226a655" href="R/31cf96dbe226a655.html" target="n" data-glyph="2,0" class="t t"><span id="3bf4136f23d34070">AliasPartSettings</span></a>
    {
        <b>public string</b> <a id="8a53a988589ff449" href="R/8a53a988589ff449.html" target="n" data-glyph="102,1" class="i property">Pattern</a> { <b>get</b>; <b>set</b>; }
    }
 
    <b>internal class</b> <a id="09f5197c366f170e" href="R/09f5197c366f170e.html" target="n" data-glyph="2,0" class="t t"><span id="30316167de97e132">AutoroutePartSettings</span></a>
    {
        <b>public string</b> <a id="551d8b94e9e9357f" href="R/551d8b94e9e9357f.html" target="n" data-glyph="102,1" class="i property">Pattern</a> { <b>get</b>; <b>set</b>; }
        <b>public bool</b> <a id="711fa5aae5a4bb08" href="R/711fa5aae5a4bb08.html" target="n" data-glyph="102,1" class="i property">AllowRouteContainedItems</a> { <b>get</b>; <b>set</b>; }
    }
}
</pre></td></tr></table></div></body></html>
