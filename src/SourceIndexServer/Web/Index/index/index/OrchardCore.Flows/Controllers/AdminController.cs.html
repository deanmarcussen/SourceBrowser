<!DOCTYPE html>
<html><head><title>AdminController.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(121);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Flows/Controllers/AdminController.cs" target="_top">Controllers\AdminController.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Flows" target="_top">src\OrchardCore.Modules\OrchardCore.Flows\OrchardCore.Flows.csproj</a> (OrchardCore.Flows)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Display</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Metadata</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Metadata</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">ContentManagement</span>.<span class="i n">Metadata</span>.<span class="i n">Settings</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">DisplayManagement</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">DisplayManagement</span>.<span class="i">ModelBinding</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Flows</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Flows</span>.<span class="i n">ViewModels</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Flows</span>.<span class="i n">Controllers</span>
{
    <b>public class</b> <a id="3256099ca6301454" href="../R/3256099ca6301454.html" target="n" data-glyph="0,0" class="t t">AdminController</a> : <span class="t t">Controller</span>
    {
        <b>private readonly</b> <a href="/OrchardCore.ContentManagement.Abstractions/A.html#6ca840219d8dc4cd" class="t t">IContentManager</a> <a id="9819611c5c6997c2" href="../R/9819611c5c6997c2.html" target="n" data-glyph="46,1" class="i field">_contentManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.ContentManagement.Abstractions/A.html#d83ce13dd2923822" class="t t">IContentDefinitionManager</a> <a id="10f1c8f3d8677c21" href="../R/10f1c8f3d8677c21.html" target="n" data-glyph="46,1" class="i field">_contentDefinitionManager</a>;
        <b>private readonly</b> <a href="/OrchardCore.ContentManagement.Display/A.html#ccb0f2621bf941ec" class="t t">IContentItemDisplayManager</a> <a id="91666377ec57f456" href="../R/91666377ec57f456.html" target="n" data-glyph="46,1" class="i field">_contentItemDisplayManager</a>;
        <b>private readonly</b> <span class="i">IShapeFactory</span> <a id="3cd98db7c83cc1ec" href="../R/3cd98db7c83cc1ec.html" target="n" data-glyph="46,1" class="i field">_shapeFactory</a>;
        <b>private readonly</b> <span class="i">IUpdateModelAccessor</span> <a id="8757b640185aaadb" href="../R/8757b640185aaadb.html" target="n" data-glyph="46,1" class="i field">_updateModelAccessor</a>;
 
        <b>public</b> <a id="ece3ec0a77e95c85" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">AdminController</a>(
            <a href="/OrchardCore.ContentManagement.Abstractions/A.html#6ca840219d8dc4cd" class="t t">IContentManager</a> <span id="r0 rd" class="r0 r">contentManager</span>,
            <a href="/OrchardCore.ContentManagement.Abstractions/A.html#d83ce13dd2923822" class="t t">IContentDefinitionManager</a> <span id="r1 rd" class="r1 r">contentDefinitionManager</span>,
            <a href="/OrchardCore.ContentManagement.Display/A.html#ccb0f2621bf941ec" class="t t">IContentItemDisplayManager</a> <span id="r2 rd" class="r2 r">contentItemDisplayManager</span>,
            <span class="i">IShapeFactory</span> <span id="r3 rd" class="r3 r">shapeFactory</span>,
            <span class="i">IUpdateModelAccessor</span> <span id="r4 rd" class="r4 r">updateModelAccessor</span>)
        {
            <a href="#9819611c5c6997c2" class="i field">_contentManager</a> = <span class="r0 r">contentManager</span>;
            <a href="#10f1c8f3d8677c21" class="i field">_contentDefinitionManager</a> = <span class="r1 r">contentDefinitionManager</span>;
            <a href="#91666377ec57f456" class="i field">_contentItemDisplayManager</a> = <span class="r2 r">contentItemDisplayManager</span>;
            <a href="#3cd98db7c83cc1ec" class="i field">_shapeFactory</a> = <span class="r3 r">shapeFactory</span>;
            <a href="#8757b640185aaadb" class="i field">_updateModelAccessor</a> = <span class="r4 r">updateModelAccessor</span>;
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<span class="t t">IActionResult</span>&gt; <a id="966a70cedc047bb8" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">BuildEditor</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r5 rd" class="r5 r">id</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r6 rd" class="r6 r">prefix</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r7 rd" class="r7 r">prefixesName</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r8 rd" class="r8 r">contentTypesName</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">targetId</span>, <b>bool</b> <span id="r10 rd" class="r10 r">flowmetadata</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r11 rd" class="r11 r">parentContentType</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r12 rd" class="r12 r">partName</span>)
        {
            <b>if</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#55e241b6143365ef" class="i method">IsNullOrWhiteSpace</a>(<span class="r5 r">id</span>))
            {
                <b>return</b> <span class="i method">NotFound</span>();
            }
 
            <a href="/OrchardCore.ContentManagement.Abstractions/A.html#1099e5a609a8b2e4" class="k">var</a> <span id="r13 rd" class="r13 r">contentItem</span> = <b>await</b> <a href="#9819611c5c6997c2" class="i field">_contentManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#9f72e0fd5ee4423f" class="i method">NewAsync</a>(<span class="r5 r">id</span>);
 
            <span class="c">// Does this editor need the flow metadata editor?</span>
            <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">cardCollectionType</span> = <b>null</b>;
            <b>int</b> <span id="r15 rd" class="r15 r">colSize</span> = 12;
            <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/OrchardCore.ContentManagement.Abstractions/A.html#a614f837ada54c1e" class="t t">ContentTypeDefinition</a>&gt; <span id="r16 rd" class="r16 r">containedContentTypes</span> = <b>null</b>;
 
            <b>if</b> (<span class="r10 r">flowmetadata</span>)
            {
                <a href="../Models/FlowMetadata.cs.html#2f87d643be881ee9" class="k">var</a> <span id="r17 rd" class="r17 r">metadata</span> = <b>new</b> <a href="../Models/FlowMetadata.cs.html#2f87d643be881ee9" class="t constructor">FlowMetadata</a>();
                <span class="r13 r">contentItem</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#61a102b0e5f5d7ab" class="i method">Weld</a>(<span class="r17 r">metadata</span>);
                <span class="r15 r">colSize</span> = (<b>int</b>)<a href="@1@System.Runtime/A.html#a4407e67b9a5afad" class="t t">Math</a>.<a href="@1@System.Runtime/A.html#cd022f3da68060cf" class="i method">Round</a>((<b>double</b>)<span class="r17 r">metadata</span>.<a href="../Models/FlowMetadata.cs.html#64dd8f125465fb6f" class="i property">Size</a> / 100.0 * 12);
                <span class="r16 r">containedContentTypes</span> = <a href="#e636d44541b2ffcd" class="i method">GetContainedContentTypes</a>(<span class="r11 r">parentContentType</span>, <span class="r12 r">partName</span>);
 
                <span class="r14 r">cardCollectionType</span> = <b>nameof</b>(<a href="../Models/FlowPart.cs.html#b90416a7b475aefd" class="t t">FlowPart</a>);
            }
            <b>else</b>
            {
                <span class="r14 r">cardCollectionType</span> = <b>nameof</b>(<a href="../Models/BagPart.cs.html#7ced65269ff78e0e" class="t t">BagPart</a>);
            }
 
            <span class="c">//Create a Card Shape</span>
            <b>dynamic</b> <span id="r18 rd" class="r18 r">contentCard</span> = <b>await</b> <a href="#3cd98db7c83cc1ec" class="i field">_shapeFactory</a>.<span class="i">New</span>.<span class="i">ContentCard</span>(
                <span class="c">//Updater is the controller for AJAX Requests</span>
                <span class="i">Updater</span>: <a href="#8757b640185aaadb" class="i field">_updateModelAccessor</a>.<span class="i">ModelUpdater</span>,
                <span class="c">//Shape Specific</span>
                <span class="i">CollectionShapeType</span>: <span class="r14 r">cardCollectionType</span>,
                <span class="i">ContentItem</span>: <span class="r13 r">contentItem</span>,
                <span class="i">BuildEditor</span>: <b>true</b>,
                <span class="i">ParentContentType</span>: <span class="r11 r">parentContentType</span>,
                <span class="i">CollectionPartName</span>: <span class="r12 r">partName</span>,
                <span class="i">ContainedContentTypes</span>: <span class="r16 r">containedContentTypes</span>,
                <span class="c">//Card Specific Properties</span>
                <span class="i">TargetId</span>: <span class="r9 r">targetId</span>,
                <span class="i">Inline</span>: <b>true</b>,
                <span class="i">CanMove</span>: <b>true</b>,
                <span class="i">CanDelete</span>: <b>true</b>,
                <span class="c">//Input hidden</span>
                <span class="c">//Prefixes</span>
                <span class="i">HtmlFieldPrefix</span>: <span class="r6 r">prefix</span>,
                <span class="i">PrefixesId</span>: <span class="r7 r">prefixesName</span>.<a href="@1@System.Runtime/A.html#987da5dfb39f1927" class="i method">Replace</a>(<span class="s">&#39;.&#39;</span>, <span class="s">&#39;_&#39;</span>),
                <span class="i">PrefixesName</span>: <span class="r7 r">prefixesName</span>,
                <span class="c">//ContentTypes</span>
                <span class="i">ContentTypesId</span>: <span class="r8 r">contentTypesName</span>.<a href="@1@System.Runtime/A.html#987da5dfb39f1927" class="i method">Replace</a>(<span class="s">&#39;.&#39;</span>, <span class="s">&#39;_&#39;</span>),
                <span class="i">ContentTypesName</span>: <span class="r8 r">contentTypesName</span>
            );
            <span class="c">//Only Add ColumnSize Property if Part has FlowMetadata</span>
            <b>if</b> (<span class="r10 r">flowmetadata</span>)
            {
                <span class="r18 r">contentCard</span>.<span class="i">ColumnSize</span> = <span class="r15 r">colSize</span>;
            }
 
            <a href="../ViewModels/BuildEditorViewModel.cs.html#d9e1b36ef5083ca1" class="k">var</a> <span id="r19 rd" class="r19 r">model</span> = <b>new</b> <a href="../ViewModels/BuildEditorViewModel.cs.html#d9e1b36ef5083ca1" class="t constructor">BuildEditorViewModel</a>
            {
                <a href="../ViewModels/BuildEditorViewModel.cs.html#8d3308dab960cabe" class="i property">EditorShape</a> = <span class="r18 r">contentCard</span>
            };
            <b>return</b> <span class="i method">View</span>(<span class="s">&quot;Display&quot;</span>, <span class="r19 r">model</span>);
        }
 
        <b>private</b> <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/OrchardCore.ContentManagement.Abstractions/A.html#a614f837ada54c1e" class="t t">ContentTypeDefinition</a>&gt; <a id="e636d44541b2ffcd" href="../R/e636d44541b2ffcd.html" target="n" data-glyph="76,1" class="i method">GetContainedContentTypes</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r20 rd" class="r20 r">contentType</span>, <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r21 rd" class="r21 r">partName</span>)
        {
            <a href="../Models/FlowPartSettings.cs.html#a0c307d2169ad62f" class="k">var</a> <span id="r22 rd" class="r22 r">settings</span> = <a href="#10f1c8f3d8677c21" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#48d139d3c9980ba3" class="i method">GetTypeDefinition</a>(<span class="r20 r">contentType</span>)?.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#9f1142b2825bb808" class="i property">Parts</a>.<span class="i method">SingleOrDefault</span>(<span id="r23 rd" class="r23 r">x</span> =&gt; <span class="r23 r">x</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#4ba68ae6a1800f30" class="i property">Name</a> == <span class="r21 r">partName</span>)?.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#b5d8b49354c46ec7" class="i method">GetSettings</a>&lt;<a href="../Models/FlowPartSettings.cs.html#a0c307d2169ad62f" class="t t">FlowPartSettings</a>&gt;();
 
            <b>if</b> (<span class="r22 r">settings</span> == <b>null</b> || <span class="r22 r">settings</span>.<a href="../Models/FlowPartSettings.cs.html#7305c7f4aa84417d" class="i property">ContainedContentTypes</a> == <b>null</b> || !<span class="r22 r">settings</span>.<a href="../Models/FlowPartSettings.cs.html#7305c7f4aa84417d" class="i property">ContainedContentTypes</a>.<span class="i method">Any</span>())
            {
                <b>return</b> <a href="#10f1c8f3d8677c21" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#0f21bc30e5015995" class="i method">ListTypeDefinitions</a>().<span class="i method">Where</span>(<span id="r24 rd" class="r24 r">t</span> =&gt; <span class="r24 r">t</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#b5d8b49354c46ec7" class="i method">GetSettings</a>&lt;<a href="/OrchardCore.ContentManagement.Abstractions/A.html#69adbe63539fed6f" class="t t">ContentTypeSettings</a>&gt;().<a href="/OrchardCore.ContentManagement.Abstractions/A.html#51306a656d4fca2d" class="i property">Stereotype</a> == <span class="s">&quot;Widget&quot;</span>);
            }
 
            <b>return</b> <span class="r22 r">settings</span>.<a href="../Models/FlowPartSettings.cs.html#7305c7f4aa84417d" class="i property">ContainedContentTypes</a>
                .<span class="i method">Select</span>(<span id="r25 rd" class="r25 r">contentType</span> =&gt; <a href="#10f1c8f3d8677c21" class="i field">_contentDefinitionManager</a>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#48d139d3c9980ba3" class="i method">GetTypeDefinition</a>(<span class="r25 r">contentType</span>))
                .<span class="i method">Where</span>(<span id="r26 rd" class="r26 r">t</span> =&gt; <span class="r26 r">t</span> != <b>null</b> &amp;&amp; <span class="r26 r">t</span>.<a href="/OrchardCore.ContentManagement.Abstractions/A.html#b5d8b49354c46ec7" class="i method">GetSettings</a>&lt;<a href="/OrchardCore.ContentManagement.Abstractions/A.html#69adbe63539fed6f" class="t t">ContentTypeSettings</a>&gt;().<a href="/OrchardCore.ContentManagement.Abstractions/A.html#51306a656d4fca2d" class="i property">Stereotype</a> == <span class="s">&quot;Widget&quot;</span>);
        }
    }
}
</pre></td></tr></table></div></body></html>
