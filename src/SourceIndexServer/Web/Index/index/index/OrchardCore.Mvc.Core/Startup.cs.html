<!DOCTYPE html>
<html><head><title>Startup.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(151);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Mvc.Core/Startup.cs" target="_top">Startup.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Mvc.Core" target="_top">src\OrchardCore\OrchardCore.Mvc.Core\OrchardCore.Mvc.Core.csproj</a> (OrchardCore.Mvc.Core)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Builder</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">ApplicationModels</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">ApplicationParts</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Controllers</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Infrastructure</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Razor</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Razor</span>.<span class="i n">Compilation</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">Razor</span>.<span class="i">RuntimeCompilation</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Mvc</span>.<span class="i n">ViewFeatures</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">AspNetCore</span>.<span class="i n">Routing</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">DependencyInjection</span>.<span class="i n">Extensions</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Hosting</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Options</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Modules</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Mvc</span>.<span class="i n">LocationExpander</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Mvc</span>.<span class="i n">ModelBinding</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Mvc</span>.<span class="i n">RazorPages</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Mvc</span>.<span class="i n">Routing</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Routing</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Mvc</span>
{
    <b>public class</b> <a id="f507344645fa069b" href="R/f507344645fa069b.html" target="n" data-glyph="0,0" class="t t">Startup</a> : <a href="/OrchardCore.Abstractions/A.html#978e5576aa0f2ef2" class="t t">StartupBase</a>
    {
        <b>public override int</b> <a id="4b6c13a95fb17ea1" href="R/4b6c13a95fb17ea1.html" target="n" data-glyph="102,1" class="i property">Order</a> =&gt; -1000;
        <b>public override int</b> <a id="01012a7d5345980c" href="R/01012a7d5345980c.html" target="n" data-glyph="102,1" class="i property">ConfigureOrder</a> =&gt; 1000;
 
        <b>private readonly</b> <span class="t t">IHostEnvironment</span> <a id="ffe2166547e27af1" href="R/ffe2166547e27af1.html" target="n" data-glyph="46,1" class="i field">_hostingEnvironment</a>;
        <b>private readonly</b> <span class="t t">IServiceProvider</span> <a id="248fca756d6a9a2d" href="R/248fca756d6a9a2d.html" target="n" data-glyph="46,1" class="i field">_serviceProvider</a>;
 
        <b>public</b> <a id="18b5d0933e15184e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">Startup</a>(<span class="t t">IHostEnvironment</span> <span id="r0 rd" class="r0 r">hostingEnvironment</span>, <span class="t t">IServiceProvider</span> <span id="r1 rd" class="r1 r">serviceProvider</span>)
        {
            <a href="#ffe2166547e27af1" class="i field">_hostingEnvironment</a> = <span class="r0 r">hostingEnvironment</span>;
            <a href="#248fca756d6a9a2d" class="i field">_serviceProvider</a> = <span class="r1 r">serviceProvider</span>;
        }
 
        <b>public override void</b> <a id="bf6e5d45949c1b16" href="R/bf6e5d45949c1b16.html" target="n" data-glyph="72,1" class="i method">Configure</a>(<span class="t t">IApplicationBuilder</span> <span id="r2 rd" class="r2 r">app</span>, <span class="t t">IEndpointRouteBuilder</span> <span id="r3 rd" class="r3 r">routes</span>, <span class="t t">IServiceProvider</span> <span id="r4 rd" class="r4 r">serviceProvider</span>)
        {
            <b>var</b> <span id="r5 rd" class="r5 r">descriptors</span> = <span class="r4 r">serviceProvider</span>.<span class="i method">GetRequiredService</span>&lt;<span class="t t">IActionDescriptorCollectionProvider</span>&gt;()
                .<span class="i property">ActionDescriptors</span>.<span class="i property">Items</span>
                .<span class="i method">OfType</span>&lt;<span class="t t">ControllerActionDescriptor</span>&gt;()
                .<span class="i method">ToArray</span>()
                ;
 
            <b>var</b> <span id="r6 rd" class="r6 r">mappers</span> = <span class="r4 r">serviceProvider</span>.<span class="i method">GetServices</span>&lt;<a href="Routing/IAreaControllerRouteMapper.cs.html#ed0ca826a76da6af" class="t t">IAreaControllerRouteMapper</a>&gt;().<span class="i method">OrderBy</span>(<span id="r7 rd" class="r7 r">x</span> =&gt; <span class="r7 r">x</span>.<a href="Routing/IAreaControllerRouteMapper.cs.html#88b0f7ee6cd6ee8e" class="i property">Order</a>);
 
            <b>foreach</b> (<b>var</b> <span id="r8 rd" class="r8 r">descriptor</span> <b>in</b> <span class="r5 r">descriptors</span>)
            {
                <b>if</b> (!<span class="r8 r">descriptor</span>.<span class="i property">RouteValues</span>.<a href="@1@System.Runtime/A.html#6105ae1e7c0835eb" class="i method">ContainsKey</a>(<span class="s">&quot;area&quot;</span>))
                {
                    <b>continue</b>;
                }
 
                <b>foreach</b> (<a href="Routing/IAreaControllerRouteMapper.cs.html#ed0ca826a76da6af" class="k">var</a> <span id="r9 rd" class="r9 r">mapper</span> <b>in</b> <span class="r6 r">mappers</span>)
                {
                    <b>if</b> (<span class="r9 r">mapper</span>.<a href="Routing/IAreaControllerRouteMapper.cs.html#e761a12c675c9e04" class="i method">TryMapAreaControllerRoute</a>(<span class="r3 r">routes</span>, <span class="r8 r">descriptor</span>))
                    {
                        <b>break</b>;
                    }
                }
            }
 
            <span class="r3 r">routes</span>.<span class="i method">MapRazorPages</span>();
        }
 
        <b>public override void</b> <a id="8cc18fc331ebd31a" href="R/8cc18fc331ebd31a.html" target="n" data-glyph="72,1" class="i method">ConfigureServices</a>(<span class="t t">IServiceCollection</span> <span id="r10 rd" class="r10 r">services</span>)
        {
            <span class="c">// Register an isolated tenant part manager.</span>
            <span class="r10 r">services</span>.<span class="i method">AddSingleton</span>(<b>new</b> <span class="t constructor">ApplicationPartManager</span>());
 
            <b>var</b> <span id="r11 rd" class="r11 r">builder</span> = <span class="r10 r">services</span>.<span class="i method">AddMvc</span>(<span id="r12 rd" class="r12 r">options</span> =&gt;
            {
                <span class="c">// Forcing AntiForgery Token Validation on by default, it&#39;s only in Razor Pages by default</span>
                <span class="c">// Load this filter after the MediaSizeFilterLimitAttribute, but before the</span>
                <span class="c">// IgnoreAntiforgeryTokenAttribute. refer : https://github.com/aspnet/AspNetCore/issues/10384</span>
                <span class="r12 r">options</span>.<span class="i property">Filters</span>.<span class="i method">Add</span>(<b>typeof</b>(<span class="t t">AutoValidateAntiforgeryTokenAttribute</span>), 999);
 
                <span class="c">// Custom model binder to testing purpose</span>
                <span class="r12 r">options</span>.<span class="i property">ModelBinderProviders</span>.<a href="@1@System.Runtime/A.html#11453faf8022b027" class="i method">Insert</a>(0, <b>new</b> <a href="ModelBinding/CheckMarkModelBinderProvider.cs.html#c86e11eb1a70016d" class="t constructor">CheckMarkModelBinderProvider</a>());
            });
 
            <span class="c">// Add a route endpoint selector policy.</span>
            <span class="r10 r">services</span>.<span class="i method">AddSingleton</span>&lt;<span class="t t">MatcherPolicy</span>, <a href="/OrchardCore.Abstractions/A.html#bc559dde60248f45" class="t t">FormValueRequiredMatcherPolicy</a>&gt;();
 
            <span class="c">// There are some issues when using the default formatters based on</span>
            <span class="c">// System.Text.Json. Here, we manually add JSON.NET based formatters.</span>
            <span class="r11 r">builder</span>.<span class="i">AddNewtonsoftJson</span>();
 
<span class="k preprocess">#</span><span class="k preprocess">if</span> !<span class="i">NET6_0_OR_GREATER</span>
            <span class="r11 r">builder</span>.<span class="i method">SetCompatibilityVersion</span>(<span class="t t">CompatibilityVersion</span>.<span class="i field">Latest</span>);
<span class="k preprocess">#</span><span class="k preprocess">endif</span>
            <span class="r10 r">services</span>.<a href="RazorPages/ModularPageMvcCoreBuilderExtensions.cs.html#0b747a2e10c037cb" class="i method">AddModularRazorPages</a>();
 
            <a href="#554a51e9ebb77e44" class="i method">AddModularFrameworkParts</a>(<a href="#248fca756d6a9a2d" class="i field">_serviceProvider</a>, <span class="r11 r">builder</span>.<span class="i property">PartManager</span>);
 
            <span class="c">// Adding localization</span>
            <span class="r11 r">builder</span>.<span class="i method">AddViewLocalization</span>();
            <span class="r11 r">builder</span>.<span class="i method">AddDataAnnotationsLocalization</span>();
 
            <span class="r10 r">services</span>.<span class="i method">TryAddEnumerable</span>(
                <span class="t t">ServiceDescriptor</span>.<span class="i method">Transient</span>&lt;<span class="t t">IConfigureOptions</span>&lt;<span class="t t">RazorViewEngineOptions</span>&gt;, <a href="ModularRazorViewEngineOptionsSetup.cs.html#8c447c69dd7afbfe" class="t t">ModularRazorViewEngineOptionsSetup</a>&gt;());
 
            <span class="c">// Support razor runtime compilation only if in dev mode and if the &#39;refs&#39; folder exists.</span>
            <a href="@1@System.Runtime/A.html#f1b135ff6c380b37" class="k">var</a> <span id="r13 rd" class="r13 r">refsFolderExists</span> = <span class="t t">Directory</span>.<span class="i method">Exists</span>(<a href="@1@System.Runtime/A.html#090eca8621a248ee" class="t t">Path</a>.<a href="@1@System.Runtime/A.html#2d7263f86a526264" class="i method">Combine</a>(<a href="@1@System.Runtime/A.html#2e9e7922eace2be8" class="t t">AppDomain</a>.<a href="@1@System.Runtime/A.html#0f1cf66beffbb219" class="i property">CurrentDomain</a>.<a href="@1@System.Runtime/A.html#694882fc5fb59a81" class="i property">BaseDirectory</a>, <span class="s">&quot;refs&quot;</span>));
 
            <b>if</b> (<a href="#ffe2166547e27af1" class="i field">_hostingEnvironment</a>.<span class="i method">IsDevelopment</span>() &amp;&amp; <span class="r13 r">refsFolderExists</span>)
            {
                <span class="r11 r">builder</span>.<span class="i">AddRazorRuntimeCompilation</span>();
 
                <span class="c">// Shares across tenants the same compiler and its &#39;IMemoryCache&#39; instance.</span>
                <span class="r10 r">services</span>.<span class="i method">AddSingleton</span>&lt;<span class="t t">IViewCompilerProvider</span>, <a href="SharedViewCompilerProvider.cs.html#fc67d42085649e9d" class="t t">SharedViewCompilerProvider</a>&gt;();
            }
 
            <span class="r10 r">services</span>.<span class="i method">TryAddEnumerable</span>(
                <span class="t t">ServiceDescriptor</span>.<span class="i method">Transient</span>&lt;<span class="t t">IConfigureOptions</span>&lt;<span class="i">MvcRazorRuntimeCompilationOptions</span>&gt;, <a href="RazorCompilationOptionsSetup.cs.html#ce57ce464273c238" class="t t">RazorCompilationOptionsSetup</a>&gt;());
 
            <span class="r10 r">services</span>.<span class="i method">AddSingleton</span>&lt;<a href="RazorCompilationFileProviderAccessor.cs.html#f4cb58f505b3bb37" class="t t">RazorCompilationFileProviderAccessor</a>&gt;();
 
            <span class="r10 r">services</span>.<span class="i method">TryAddSingleton</span>&lt;<span class="t t">IActionContextAccessor</span>, <span class="t t">ActionContextAccessor</span>&gt;();
 
            <span class="c">// Use a custom &#39;IFileVersionProvider&#39; that also lookup all tenant level &#39;IStaticFileProvider&#39;.</span>
            <span class="r10 r">services</span>.<span class="i method">Replace</span>(<span class="t t">ServiceDescriptor</span>.<span class="i method">Singleton</span>&lt;<span class="t t">IFileVersionProvider</span>, <a href="ShellFileVersionProvider.cs.html#e0e4e10ffc229ffb" class="t t">ShellFileVersionProvider</a>&gt;());
 
            <span class="c">// Register a DefaultAreaControllerRouteMapper that will run last.</span>
            <span class="r10 r">services</span>.<span class="i method">AddTransient</span>&lt;<a href="Routing/IAreaControllerRouteMapper.cs.html#ed0ca826a76da6af" class="t t">IAreaControllerRouteMapper</a>, <a href="Routing/DefaultAreaControllerRouteMapper.cs.html#5ec08c1d51346e65" class="t t">DefaultAreaControllerRouteMapper</a>&gt;();
 
            <a href="#4d4e9aa4618d54c6" class="i method">AddMvcModuleCoreServices</a>(<span class="r10 r">services</span>);
        }
 
        <b>internal static void</b> <a id="554a51e9ebb77e44" href="R/554a51e9ebb77e44.html" target="n" data-glyph="74,1" class="i method">AddModularFrameworkParts</a>(<span class="t t">IServiceProvider</span> <span id="r14 rd" class="r14 r">services</span>, <span class="t t">ApplicationPartManager</span> <span id="r15 rd" class="r15 r">manager</span>)
        {
            <span class="r15 r">manager</span>.<span class="i property">ApplicationParts</span>.<a href="@1@System.Runtime/A.html#11453faf8022b027" class="i method">Insert</a>(0, <b>new</b> <a href="ShellFeatureApplicationPart.cs.html#f26f1c6d850081ea" class="t constructor">ShellFeatureApplicationPart</a>());
            <span class="r15 r">manager</span>.<span class="i property">FeatureProviders</span>.<a href="@1@System.Runtime/A.html#a9319db8c62ae453" class="i method">Add</a>(<b>new</b> <a href="ShellViewFeatureProvider.cs.html#a1adab3e97919101" class="t constructor">ShellViewFeatureProvider</a>(<span class="r14 r">services</span>));
        }
 
        <b>internal static void</b> <a id="4d4e9aa4618d54c6" href="R/4d4e9aa4618d54c6.html" target="n" data-glyph="74,1" class="i method">AddMvcModuleCoreServices</a>(<span class="t t">IServiceCollection</span> <span id="r16 rd" class="r16 r">services</span>)
        {
            <span class="r16 r">services</span>.<span class="i method">AddScoped</span>&lt;<a href="LocationExpander/IViewLocationExpanderProvider.cs.html#b13c00f1ee9a8a59" class="t t">IViewLocationExpanderProvider</a>, <a href="LocationExpander/ComponentViewLocationExpanderProvider.cs.html#4f6474de15c84483" class="t t">ComponentViewLocationExpanderProvider</a>&gt;();
            <span class="r16 r">services</span>.<span class="i method">AddScoped</span>&lt;<a href="LocationExpander/IViewLocationExpanderProvider.cs.html#b13c00f1ee9a8a59" class="t t">IViewLocationExpanderProvider</a>, <a href="LocationExpander/SharedViewLocationExpanderProvider.cs.html#f6b4ce4d647c79f0" class="t t">SharedViewLocationExpanderProvider</a>&gt;();
 
            <span class="r16 r">services</span>.<span class="i method">TryAddEnumerable</span>(
                <span class="t t">ServiceDescriptor</span>.<span class="i method">Singleton</span>&lt;<span class="t t">IApplicationModelProvider</span>, <a href="ModularApplicationModelProvider.cs.html#26faf9823e1e26ed" class="t t">ModularApplicationModelProvider</a>&gt;());
        }
    }
}
</pre></td></tr></table></div></body></html>
