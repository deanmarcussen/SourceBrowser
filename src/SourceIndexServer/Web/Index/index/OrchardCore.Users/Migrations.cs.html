<!DOCTYPE html>
<html><head><title>Migrations.cs</title><link rel="stylesheet" href="../styles.css"><script src="../scripts.js"></script></head>
<body class="cB" onload="i(194);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Users/Migrations.cs" target="_top">Migrations.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Users" target="_top">src\OrchardCore.Modules\OrchardCore.Users\OrchardCore.Users.csproj</a> (OrchardCore.Users)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Data</span>.<span class="i n">Migration</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Users</span>.<span class="i n">Indexes</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Users</span>.<span class="i n">Models</span>;
<b>using</b> <span class="i">YesSql</span>;
<b>using</b> <span class="i">YesSql</span>.<span class="i">Sql</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Users</span>
{
    <b>public class</b> <a id="e2a041267a1f72cf" href="R/e2a041267a1f72cf.html" target="n" data-glyph="0,0" class="t t">Migrations</a> : <span class="i">DataMigration</span>
    {
        <b>private readonly</b> <span class="i">ISession</span> <a id="f79cb55dbd1f60c1" href="R/f79cb55dbd1f60c1.html" target="n" data-glyph="46,1" class="i field">_session</a>;
 
        <b>public</b> <a id="0f8f826a62dc8f60" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">Migrations</a>(<span class="i">ISession</span> <span id="r0 rd" class="r0 r">session</span>)
        {
            <a href="#f79cb55dbd1f60c1" class="i field">_session</a> = <span class="r0 r">session</span>;
        }
 
        <span class="c">// This is a sequenced migration. On a new schemas this is complete after UpdateFrom2.</span>
        <b>public int</b> <a id="93031719de00e89e" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Create</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r1 rd" class="r1 r">table</span> =&gt; <span class="r1 r">table</span>
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;NormalizedUserName&quot;</span>) <span class="c">// TODO These should have defaults. on SQL Server they will fall at 255. Exceptions are currently thrown if you go over that.</span>
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;NormalizedEmail&quot;</span>)
                .<span class="i">Column</span>&lt;<b>bool</b>&gt;(<span class="s">&quot;IsEnabled&quot;</span>, <span id="r2 rd" class="r2 r">c</span> =&gt; <span class="r2 r">c</span>.<span class="i">NotNull</span>().<span class="i">WithDefault</span>(<b>true</b>))
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;UserId&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r3 rd" class="r3 r">table</span> =&gt; <span class="r3 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;UserId&quot;</span>,
                    <span class="s">&quot;NormalizedUserName&quot;</span>,
                    <span class="s">&quot;NormalizedEmail&quot;</span>,
                    <span class="s">&quot;IsEnabled&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">CreateReduceIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#6a27897cbb2125ab" class="t t">UserByRoleNameIndex</a>&gt;(<span id="r4 rd" class="r4 r">table</span> =&gt; <span class="r4 r">table</span>
               .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;RoleName&quot;</span>)
               .<span class="i">Column</span>&lt;<b>int</b>&gt;(<span class="s">&quot;Count&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#6a27897cbb2125ab" class="t t">UserByRoleNameIndex</a>&gt;(<span id="r5 rd" class="r5 r">table</span> =&gt; <span class="r5 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByRoleNameIndex_RoleName&quot;</span>,
                    <span class="s">&quot;RoleName&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#f0339df1342eb938" class="t t">UserByLoginInfoIndex</a>&gt;(<span id="r6 rd" class="r6 r">table</span> =&gt; <span class="r6 r">table</span>
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;LoginProvider&quot;</span>)
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ProviderKey&quot;</span>));
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#f0339df1342eb938" class="t t">UserByLoginInfoIndex</a>&gt;(<span id="r7 rd" class="r7 r">table</span> =&gt; <span class="r7 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByLoginInfoIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;LoginProvider&quot;</span>,
                    <span class="s">&quot;ProviderKey&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>&gt;(<span id="r8 rd" class="r8 r">table</span> =&gt; <span class="r8 r">table</span>
               .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#02873c3580a415a3" class="i property">ClaimType</a>))
               .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#313732ff1c72538c" class="i property">ClaimValue</a>)),
                <b>null</b>);
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>&gt;(<span id="r9 rd" class="r9 r">table</span> =&gt; <span class="r9 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByClaimIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#02873c3580a415a3" class="i property">ClaimType</a>),
                    <b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#313732ff1c72538c" class="i property">ClaimValue</a>))
            );
 
            <span class="c">// Shortcut other migration steps on new content definition schemas.</span>
            <b>return</b> 10;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="2badeda914390d40" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom1</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#f0339df1342eb938" class="t t">UserByLoginInfoIndex</a>&gt;(<span id="r10 rd" class="r10 r">table</span> =&gt; <span class="r10 r">table</span>
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;LoginProvider&quot;</span>)
                .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;ProviderKey&quot;</span>));
 
            <b>return</b> 2;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="f72dc43b32a4363c" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom2</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">CreateMapIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>&gt;(<span id="r11 rd" class="r11 r">table</span> =&gt; <span class="r11 r">table</span>
               .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#02873c3580a415a3" class="i property">ClaimType</a>))
               .<span class="i">Column</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#313732ff1c72538c" class="i property">ClaimValue</a>)),
                <b>null</b>);
 
            <b>return</b> 3;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="8f7e401778494818" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom3</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r12 rd" class="r12 r">table</span> =&gt; <span class="r12 r">table</span>
                .<span class="i">AddColumn</span>&lt;<b>bool</b>&gt;(<b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>.<a href="/OrchardCore.Users.Core/A.html#b9ed3e3cbe21687e" class="i property">IsEnabled</a>), <span id="r13 rd" class="r13 r">c</span> =&gt; <span class="r13 r">c</span>.<span class="i">NotNull</span>().<span class="i">WithDefault</span>(<b>true</b>)));
 
            <b>return</b> 4;
        }
 
        <span class="c">// UserId database migration.</span>
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="41d8e76f0b0c9fb0" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom4</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r14 rd" class="r14 r">table</span> =&gt; <span class="r14 r">table</span>
                .<span class="i">AddColumn</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt;(<span class="s">&quot;UserId&quot;</span>));
 
            <b>return</b> 5;
        }
 
        <span class="c">// UserId column is added. This initializes the UserId property to the UserName for existing users.</span>
        <span class="c">// The UserName property rather than the NormalizedUserName is used as the ContentItem.Owner property matches the UserName.</span>
        <span class="c">// New users will be created with a generated Id.</span>
        <span class="c">// This code can be removed in a later version.</span>
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="977489f2b8a603e2" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom5Async</a>()
        {
            <b>var</b> <span id="r15 rd" class="r15 r">users</span> = <b>await</b> <a href="#f79cb55dbd1f60c1" class="i field">_session</a>.<span class="i">Query</span>&lt;<a href="/OrchardCore.Users.Core/A.html#63066ddf792dff6e" class="t t">User</a>&gt;().<span class="i">ListAsync</span>();
            <b>foreach</b> (<b>var</b> <span id="r16 rd" class="r16 r">user</span> <b>in</b> <span class="r15 r">users</span>)
            {
                <span class="r16 r">user</span>.<span class="i">UserId</span> = <span class="r16 r">user</span>.<span class="i">UserName</span>;
                <a href="#f79cb55dbd1f60c1" class="i field">_session</a>.<span class="i">Save</span>(<span class="r16 r">user</span>);
            }
 
            <b>return</b> 6;
        }
 
        <span class="c">// This buggy migration has been removed.</span>
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="44c4013f827c861d" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom6</a>()
        {
            <b>return</b> 7;
        }
 
        <span class="c">// Migrate any user names replacing &#39;@&#39; with &#39;+&#39; as user names can no longer be an email address.</span>
        <span class="c">// This code can be removed in a later version.</span>
        <b>public async</b> <a href="@1@System.Runtime/A.html#5ca7b77f3df89fc6" class="t t">Task</a>&lt;<b>int</b>&gt; <a id="d299ee86decf855f" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom7Async</a>()
        {
            <b>var</b> <span id="r17 rd" class="r17 r">users</span> = <b>await</b> <a href="#f79cb55dbd1f60c1" class="i field">_session</a>.<span class="i">Query</span>&lt;<a href="/OrchardCore.Users.Core/A.html#63066ddf792dff6e" class="t t">User</a>, <a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r18 rd" class="r18 r">u</span> =&gt; <span class="r18 r">u</span>.<span class="i">NormalizedUserName</span>.<span class="i">Contains</span>(<span class="s">&quot;@&quot;</span>)).<span class="i">ListAsync</span>();
            <b>foreach</b> (<b>var</b> <span id="r19 rd" class="r19 r">user</span> <b>in</b> <span class="r17 r">users</span>)
            {
                <span class="r19 r">user</span>.<span class="i">UserName</span> = <span class="r19 r">user</span>.<span class="i">UserName</span>.<span class="i">Replace</span>(<span class="s">&#39;@&#39;</span>, <span class="s">&#39;+&#39;</span>);
                <span class="r19 r">user</span>.<span class="i">NormalizedUserName</span> = <span class="r19 r">user</span>.<span class="i">NormalizedUserName</span>.<span class="i">Replace</span>(<span class="s">&#39;@&#39;</span>, <span class="s">&#39;+&#39;</span>);
                <a href="#f79cb55dbd1f60c1" class="i field">_session</a>.<span class="i">Save</span>(<span class="r19 r">user</span>);
            }
 
            <b>return</b> 8;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="8931c90062178e80" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom8</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#c095c28c73aca951" class="t t">UserIndex</a>&gt;(<span id="r20 rd" class="r20 r">table</span> =&gt; <span class="r20 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;UserId&quot;</span>,
                    <span class="s">&quot;NormalizedUserName&quot;</span>,
                    <span class="s">&quot;NormalizedEmail&quot;</span>,
                    <span class="s">&quot;IsEnabled&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#f0339df1342eb938" class="t t">UserByLoginInfoIndex</a>&gt;(<span id="r21 rd" class="r21 r">table</span> =&gt; <span class="r21 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByLoginInfoIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <span class="s">&quot;LoginProvider&quot;</span>,
                    <span class="s">&quot;ProviderKey&quot;</span>)
            );
 
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>&gt;(<span id="r22 rd" class="r22 r">table</span> =&gt; <span class="r22 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByClaimIndex_DocumentId&quot;</span>,
                    <span class="s">&quot;DocumentId&quot;</span>,
                    <b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#02873c3580a415a3" class="i property">ClaimType</a>),
                    <b>nameof</b>(<a href="/OrchardCore.Users.Core/A.html#807501dae693a852" class="t t">UserByClaimIndex</a>.<a href="/OrchardCore.Users.Core/A.html#313732ff1c72538c" class="i property">ClaimValue</a>))
            );
 
            <b>return</b> 9;
        }
 
        <span class="c">// This code can be removed in a later version.</span>
        <b>public int</b> <a id="f235741075c67c14" href="R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">UpdateFrom9</a>()
        {
            <span class="i">SchemaBuilder</span>.<span class="i">AlterIndexTable</span>&lt;<a href="/OrchardCore.Users.Core/A.html#6a27897cbb2125ab" class="t t">UserByRoleNameIndex</a>&gt;(<span id="r23 rd" class="r23 r">table</span> =&gt; <span class="r23 r">table</span>
                .<span class="i">CreateIndex</span>(<span class="s">&quot;IDX_UserByRoleNameIndex_RoleName&quot;</span>,
                    <span class="s">&quot;RoleName&quot;</span>)
            );
 
            <b>return</b> 10;
        }
    }
}
</pre></td></tr></table></div></body></html>
