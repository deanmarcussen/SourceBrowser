<!DOCTYPE html>
<html><head><title>LuceneIndexManager.cs</title><link rel="stylesheet" href="../../styles.css"><script src="../../scripts.js"></script></head>
<body class="cB" onload="i(531);"><div class="dH">
<table style="width: 100%">
<tr><td>File: <a id="filePath" class="blueLink" href="/#OrchardCore.Lucene/Services/LuceneIndexManager.cs" target="_top">Services\LuceneIndexManager.cs</a><br/></td><td></td></tr>
<tr><td>Project: <a id="projectPath" class="blueLink" href="/#OrchardCore.Lucene" target="_top">src\OrchardCore.Modules\OrchardCore.Lucene\OrchardCore.Lucene.csproj</a> (OrchardCore.Lucene)</td><td></td></tr>
</table>
</div>
<div class="cz"><table class="tb" cellpadding="0" cellspacing="0"><tr><td valign="top" align="right"><pre id="ln"></pre></td><td valign="top" align="left"><pre id="code">
<b>using</b> <span class="i n">System</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Concurrent</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">Generic</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Collections</span>.<span class="i n">ObjectModel</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">IO</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Linq</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>;
<b>using</b> <span class="i n">System</span>.<span class="i n">Threading</span>.<span class="i n">Tasks</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Documents</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Index</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Search</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Spatial</span>.<span class="i">Prefix</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Spatial</span>.<span class="i">Prefix</span>.<span class="i">Tree</span>;
<b>using</b> <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Store</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Logging</span>;
<b>using</b> <span class="i n">Microsoft</span>.<span class="i n">Extensions</span>.<span class="i n">Options</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Environment</span>.<span class="i">Shell</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Indexing</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Lucene</span>.<span class="i n">Model</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i n">Lucene</span>.<span class="i n">Services</span>;
<b>using</b> <span class="i n">OrchardCore</span>.<span class="i">Modules</span>;
<b>using</b> <span class="i">Spatial4n</span>.<span class="i">Core</span>.<span class="i">Context</span>;
<b>using</b> <span class="t">Directory</span> = <span class="i n">System</span>.<span class="i n">IO</span>.<span class="t t">Directory</span>;
<b>using</b> <span class="i">LDirectory</span> = <span class="i">Lucene</span>.<span class="i">Net</span>.<span class="i">Store</span>.<span class="i">Directory</span>;
 
<b>namespace</b> <span class="i n">OrchardCore</span>.<span class="i n">Lucene</span>
{
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
    <span class="c">///</span><span class="c"> Provides methods to manage physical Lucene indices.</span>
    <span class="c">///</span><span class="c"> This class is provided as a singleton to that the index searcher can be reused across requests.</span>
    <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
    <b>public class</b> <a id="8e92d0a8267c60a3" href="../R/8e92d0a8267c60a3.html" target="n" data-glyph="0,0" class="t t">LuceneIndexManager</a> : <a href="@1@System.Runtime/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>private readonly</b> <span class="i">IClock</span> <a id="648d9ad1e11f9300" href="../R/648d9ad1e11f9300.html" target="n" data-glyph="46,1" class="i field">_clock</a>;
        <b>private readonly</b> <span class="t t">ILogger</span> <a id="e6dd6ed87d4cdcd2" href="../R/e6dd6ed87d4cdcd2.html" target="n" data-glyph="46,1" class="i field">_logger</a>;
        <b>private readonly string</b> <a id="618d05ef36962a79" href="../R/618d05ef36962a79.html" target="n" data-glyph="46,1" class="i field">_rootPath</a>;
        <b>private bool</b> <a id="25d090a2e8dba250" href="../R/25d090a2e8dba250.html" target="n" data-glyph="46,1" class="i field">_disposing</a>;
        <b>private readonly</b> <span class="t t">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#54a99b8e65fff028" class="t t">IndexReaderPool</a>&gt; <a id="1a7281b2277fcae4" href="../R/1a7281b2277fcae4.html" target="n" data-glyph="46,1" class="i field">_indexPools</a> = <b>new</b> <span class="t constructor">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#54a99b8e65fff028" class="t t">IndexReaderPool</a>&gt;(<a href="@1@System.Runtime/A.html#a1c3d85bbf4ae20e" class="t t">StringComparer</a>.<a href="@1@System.Runtime/A.html#59b9c33842417944" class="i property">OrdinalIgnoreCase</a>);
        <b>private readonly</b> <span class="t t">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#632bcf09af487f3d" class="t t">IndexWriterWrapper</a>&gt; <a id="668fe18c1279461a" href="../R/668fe18c1279461a.html" target="n" data-glyph="46,1" class="i field">_writers</a> = <b>new</b> <span class="t constructor">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="#632bcf09af487f3d" class="t t">IndexWriterWrapper</a>&gt;(<a href="@1@System.Runtime/A.html#a1c3d85bbf4ae20e" class="t t">StringComparer</a>.<a href="@1@System.Runtime/A.html#59b9c33842417944" class="i property">OrdinalIgnoreCase</a>);
        <b>private readonly</b> <span class="t t">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#df6b1eba7461813b" class="t t">DateTime</a>&gt; <a id="8b600fe65ef43eb1" href="../R/8b600fe65ef43eb1.html" target="n" data-glyph="46,1" class="i field">_timestamps</a> = <b>new</b> <span class="t constructor">ConcurrentDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#df6b1eba7461813b" class="t t">DateTime</a>&gt;(<a href="@1@System.Runtime/A.html#a1c3d85bbf4ae20e" class="t t">StringComparer</a>.<a href="@1@System.Runtime/A.html#59b9c33842417944" class="i property">OrdinalIgnoreCase</a>);
        <b>private readonly</b> <a href="LuceneAnalyzerManager.cs.html#c9d43f02df73f256" class="t t">LuceneAnalyzerManager</a> <a id="c937ab9f5c2d796a" href="../R/c937ab9f5c2d796a.html" target="n" data-glyph="46,1" class="i field">_luceneAnalyzerManager</a>;
        <b>private readonly</b> <a href="LuceneIndexSettingsService.cs.html#bf05dbd481185a70" class="t t">LuceneIndexSettingsService</a> <a id="c0fcc9e86cb46652" href="../R/c0fcc9e86cb46652.html" target="n" data-glyph="46,1" class="i field">_luceneIndexSettingsService</a>;
        <b>private readonly</b> <span class="i">SpatialContext</span> <a id="851fba53acc95f12" href="../R/851fba53acc95f12.html" target="n" data-glyph="46,1" class="i field">_ctx</a>;
        <b>private readonly</b> <span class="i">GeohashPrefixTree</span> <a id="6609762d659e347f" href="../R/6609762d659e347f.html" target="n" data-glyph="46,1" class="i field">_grid</a>;
        <b>private readonly static object</b> <a id="908557af9744ce5b" href="../R/908557af9744ce5b.html" target="n" data-glyph="46,1" class="i field">_synLock</a> = <b>new</b> <b>object</b>();
 
        <b>public</b> <a id="e2bf5ab3c3dbe2af" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">LuceneIndexManager</a>(
            <span class="i">IClock</span> <span id="r0 rd" class="r0 r">clock</span>,
            <span class="t t">IOptions</span>&lt;<span class="i">ShellOptions</span>&gt; <span id="r1 rd" class="r1 r">shellOptions</span>,
            <span class="i">ShellSettings</span> <span id="r2 rd" class="r2 r">shellSettings</span>,
            <span class="t t">ILogger</span>&lt;<a href="#8e92d0a8267c60a3" class="t t">LuceneIndexManager</a>&gt; <span id="r3 rd" class="r3 r">logger</span>,
            <a href="LuceneAnalyzerManager.cs.html#c9d43f02df73f256" class="t t">LuceneAnalyzerManager</a> <span id="r4 rd" class="r4 r">luceneAnalyzerManager</span>,
            <a href="LuceneIndexSettingsService.cs.html#bf05dbd481185a70" class="t t">LuceneIndexSettingsService</a> <span id="r5 rd" class="r5 r">luceneIndexSettingsService</span>
            )
        {
            <a href="#648d9ad1e11f9300" class="i field">_clock</a> = <span class="r0 r">clock</span>;
            <a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a> = <span class="r3 r">logger</span>;
            <a href="#618d05ef36962a79" class="i field">_rootPath</a> = <span class="i">PathExtensions</span>.<span class="i">Combine</span>(
                <span class="r1 r">shellOptions</span>.<span class="i property">Value</span>.<span class="i">ShellsApplicationDataPath</span>,
                <span class="r1 r">shellOptions</span>.<span class="i property">Value</span>.<span class="i">ShellsContainerName</span>,
                <span class="r2 r">shellSettings</span>.<span class="i">Name</span>, <span class="s">&quot;Lucene&quot;</span>);
            <span class="t t">Directory</span>.<span class="i method">CreateDirectory</span>(<a href="#618d05ef36962a79" class="i field">_rootPath</a>);
            <a href="#c937ab9f5c2d796a" class="i field">_luceneAnalyzerManager</a> = <span class="r4 r">luceneAnalyzerManager</span>;
            <a href="#c0fcc9e86cb46652" class="i field">_luceneIndexSettingsService</a> = <span class="r5 r">luceneIndexSettingsService</span>;
 
            <span class="c">// Typical geospatial context</span>
            <span class="c">// These can also be constructed from SpatialContextFactory</span>
            <a href="#851fba53acc95f12" class="i field">_ctx</a> = <span class="i">SpatialContext</span>.<span class="i">GEO</span>;
 
            <a href="@1@System.Runtime/A.html#225942ed7b7a3252" class="k">var</a> <span id="r6 rd" class="r6 r">maxLevels</span> = 11; <span class="c">// Results in sub-meter precision for geohash</span>
 
            <span class="c">// TODO demo lookup by detail distance</span>
            <span class="c">// This can also be constructed from SpatialPrefixTreeFactory</span>
            <a href="#6609762d659e347f" class="i field">_grid</a> = <b>new</b> <span class="i">GeohashPrefixTree</span>(<a href="#851fba53acc95f12" class="i field">_ctx</a>, <span class="r6 r">maxLevels</span>);
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="60eae94f51af83fa" href="../R/60eae94f51af83fa.html" target="n" data-glyph="72,1" class="i method">CreateIndexAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r7 rd" class="r7 r">indexName</span>)
        {
            <b>await</b> <a href="#46950a1a9c7aeb41" class="i method">WriteAsync</a>(<span class="r7 r">indexName</span>, <span id="r8 rd" class="r8 r">_</span> =&gt; { }, <b>true</b>);
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="43644c5c2b926c26" href="../R/43644c5c2b926c26.html" target="n" data-glyph="72,1" class="i method">DeleteDocumentsAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r9 rd" class="r9 r">indexName</span>, <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>&gt; <span id="r10 rd" class="r10 r">contentItemIds</span>)
        {
            <b>await</b> <span class="i">WriteAsync</span>(<span class="r9 r">indexName</span>, <span id="r11 rd" class="r11 r">writer</span> =&gt;
            {
                <span class="r11 r">writer</span>.<span class="i">DeleteDocuments</span>(<span class="r10 r">contentItemIds</span>.<span class="i">Select</span>(<span id="r12 rd" class="r12 r">x</span> =&gt; <b>new</b> <span class="i">Term</span>(<span class="s">&quot;ContentItemId&quot;</span>, <span class="r12 r">x</span>)).<span class="i">ToArray</span>());
 
                <span class="r11 r">writer</span>.<span class="i">Commit</span>();
 
                <b>if</b> (<a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i method">TryRemove</span>(<span class="r9 r">indexName</span>, <b>out</b> <a href="#54a99b8e65fff028" class="k">var</a> <span id="r13 rd" class="r13 r">pool</span>))
                {
                    <span class="r13 r">pool</span>.<a href="#1055e70952eeecf1" class="i method">MakeDirty</a>();
                    <span class="r13 r">pool</span>.<a href="#5bd68657f61de1bb" class="i method">Release</a>();
                }
            });
        }
 
        <b>public void</b> <a id="f38298c8f64b8c31" href="../R/f38298c8f64b8c31.html" target="n" data-glyph="72,1" class="i method">DeleteIndex</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r14 rd" class="r14 r">indexName</span>)
        {
            <b>lock</b> (<a href="#8e92d0a8267c60a3" class="k">this</a>)
            {
                <b>if</b> (<a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryGetValue</span>(<span class="r14 r">indexName</span>, <b>out</b> <a href="#632bcf09af487f3d" class="k">var</a> <span id="r15 rd" class="r15 r">writer</span>))
                {
                    <span class="r15 r">writer</span>.<a href="#be99bc021721354b" class="i property">IsClosing</a> = <b>true</b>;
                    <span class="r15 r">writer</span>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i method">TryRemove</span>(<span class="r14 r">indexName</span>, <b>out</b> <a href="#54a99b8e65fff028" class="k">var</a> <span id="r16 rd" class="r16 r">reader</span>))
                {
                    <span class="r16 r">reader</span>.<a href="#682e441f17182e09" class="i method">Dispose</a>();
                }
 
                <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>.<span class="i method">TryRemove</span>(<span class="r14 r">indexName</span>, <b>out _</b>);
 
                <b>var</b> <span id="r17 rd" class="r17 r">indexFolder</span> = <span class="i">PathExtensions</span>.<span class="i">Combine</span>(<a href="#618d05ef36962a79" class="i field">_rootPath</a>, <span class="r14 r">indexName</span>);
 
                <b>if</b> (<span class="t t">Directory</span>.<span class="i">Exists</span>(<span class="r17 r">indexFolder</span>))
                {
                    <b>try</b>
                    {
                        <span class="t t">Directory</span>.<span class="i">Delete</span>(<span class="r17 r">indexFolder</span>, <b>true</b>);
                    }
                    <b>catch</b> { }
                }
 
                <a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryRemove</span>(<span class="r14 r">indexName</span>, <b>out _</b>);
            }
        }
 
        <b>public bool</b> <a id="33224a9601558859" href="../R/33224a9601558859.html" target="n" data-glyph="72,1" class="i method">Exists</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r18 rd" class="r18 r">indexName</span>)
        {
            <b>if</b> (<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#55e241b6143365ef" class="i method">IsNullOrWhiteSpace</a>(<span class="r18 r">indexName</span>))
            {
                <b>return</b> <b>false</b>;
            }
 
            <b>return</b> <span class="t t">Directory</span>.<span class="i">Exists</span>(<span class="i">PathExtensions</span>.<span class="i">Combine</span>(<a href="#618d05ef36962a79" class="i field">_rootPath</a>, <span class="r18 r">indexName</span>));
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="3b380cea2847e60f" href="../R/3b380cea2847e60f.html" target="n" data-glyph="72,1" class="i method">StoreDocumentsAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r19 rd" class="r19 r">indexName</span>, <a href="@1@System.Runtime/A.html#3acf01620172c7f0" class="t t">IEnumerable</a>&lt;<a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>&gt; <span id="r20 rd" class="r20 r">indexDocuments</span>)
        {
            <b>await</b> <a href="#46950a1a9c7aeb41" class="i method">WriteAsync</a>(<span class="r19 r">indexName</span>, <span id="r21 rd" class="r21 r">writer</span> =&gt;
            {
                <b>foreach</b> (<a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="k">var</a> <span id="r22 rd" class="r22 r">indexDocument</span> <b>in</b> <span class="r20 r">indexDocuments</span>)
                {
                    <span class="r21 r">writer</span>.<span class="i">AddDocument</span>(<a href="#b3e17b82ab581e2a" class="i method">CreateLuceneDocument</a>(<span class="r22 r">indexDocument</span>));
                }
 
                <span class="r21 r">writer</span>.<span class="i">Commit</span>();
 
                <b>if</b> (<a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i method">TryRemove</span>(<span class="r19 r">indexName</span>, <b>out</b> <a href="#54a99b8e65fff028" class="k">var</a> <span id="r23 rd" class="r23 r">pool</span>))
                {
                    <span class="r23 r">pool</span>.<a href="#1055e70952eeecf1" class="i method">MakeDirty</a>();
                    <span class="r23 r">pool</span>.<a href="#5bd68657f61de1bb" class="i method">Release</a>();
                }
            });
        }
 
        <b>public async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="d3f6363ae5d0af6e" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">SearchAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r24 rd" class="r24 r">indexName</span>, <a href="@1@System.Runtime/A.html#7a86aba051da82dd" class="t t">Func</a>&lt;<span class="i">IndexSearcher</span>, <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a>&gt; <span id="r25 rd" class="r25 r">searcher</span>)
        {
            <b>if</b> (<a href="#33224a9601558859" class="i method">Exists</a>(<span class="r24 r">indexName</span>))
            {
                <b>using</b> (<a href="#b634dab5d7d3a497" class="k">var</a> <span id="r26 rd" class="r26 r">reader</span> = <a href="#03d753c246259782" class="i method">GetReader</a>(<span class="r24 r">indexName</span>))
                {
                    <b>var</b> <span id="r27 rd" class="r27 r">indexSearcher</span> = <b>new</b> <span class="i">IndexSearcher</span>(<span class="r26 r">reader</span>.<a href="#b2526cd0c7de114c" class="i property">IndexReader</a>);
                    <b>await</b> <span class="r25 r">searcher</span>(<span class="r27 r">indexSearcher</span>);
                }
 
                <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>[<span class="r24 r">indexName</span>] = <a href="#648d9ad1e11f9300" class="i field">_clock</a>.<span class="i">UtcNow</span>;
            }
        }
 
        <b>public void</b> <a id="c9ce47e7dc572a5a" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">Read</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r28 rd" class="r28 r">indexName</span>, <a href="@1@System.Runtime/A.html#486d58da4553e12d" class="t t">Action</a>&lt;<span class="i">IndexReader</span>&gt; <span id="r29 rd" class="r29 r">reader</span>)
        {
            <b>if</b> (<a href="#33224a9601558859" class="i method">Exists</a>(<span class="r28 r">indexName</span>))
            {
                <b>using</b> (<a href="#b634dab5d7d3a497" class="k">var</a> <span id="r30 rd" class="r30 r">indexReader</span> = <a href="#03d753c246259782" class="i method">GetReader</a>(<span class="r28 r">indexName</span>))
                {
                    <span class="r29 r">reader</span>(<span class="r30 r">indexReader</span>.<a href="#b2526cd0c7de114c" class="i property">IndexReader</a>);
                }
 
                <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>[<span class="r28 r">indexName</span>] = <a href="#648d9ad1e11f9300" class="i field">_clock</a>.<span class="i">UtcNow</span>;
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Returns a list of open indices and the last time they were accessed.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public</b> <a href="@1@System.Runtime/A.html#f786bcc5e7b69c7d" class="t t">IReadOnlyDictionary</a>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#df6b1eba7461813b" class="t t">DateTime</a>&gt; <a id="ba19b7bbd490d070" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">GetTimestamps</a>()
        {
            <b>return</b> <b>new</b> <span class="t constructor">ReadOnlyDictionary</span>&lt;<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a>, <a href="@1@System.Runtime/A.html#df6b1eba7461813b" class="t t">DateTime</a>&gt;(<a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>);
        }
 
        <b>private</b> <span class="i">Document</span> <a id="b3e17b82ab581e2a" href="../R/b3e17b82ab581e2a.html" target="n" data-glyph="76,1" class="i method">CreateLuceneDocument</a>(<a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a> <span id="r31 rd" class="r31 r">documentIndex</span>)
        {
            <b>var</b> <span id="r32 rd" class="r32 r">doc</span> = <b>new</b> <span class="i">Document</span>
            {
                <span class="c">// Always store the content item id</span>
                <b>new</b> <span class="i">StringField</span>(<span class="s">&quot;ContentItemId&quot;</span>, <span class="r31 r">documentIndex</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#ba202ea75139db8b" class="i property">ContentItemId</a>.<a href="@1@System.Runtime/A.html#efa5e6c14683e022" class="i method">ToString</a>(), <span class="i">Field</span>.<span class="i">Store</span>.<span class="i">YES</span>)
            };
 
            <b>foreach</b> (<a href="/OrchardCore.Indexing.Abstractions/A.html#5c8a11f639ccca3b" class="k">var</a> <span id="r33 rd" class="r33 r">entry</span> <b>in</b> <span class="r31 r">documentIndex</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#5a0a2f728354d157" class="i property">Entries</a>)
            {
                <b>var</b> <span id="r34 rd" class="r34 r">store</span> = <span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#882beac176560783" class="i property">Options</a>.<a href="@1@System.Runtime/A.html#9cd73f33d2df3074" class="i method">HasFlag</a>(<a href="/OrchardCore.Indexing.Abstractions/A.html#e5789b7e7e078077" class="t t">DocumentIndexOptions</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#788561eec422f3c8" class="i field">Store</a>)
                            ? <span class="i">Field</span>.<span class="i">Store</span>.<span class="i">YES</span>
                            : <span class="i">Field</span>.<span class="i">Store</span>.<span class="i">NO</span>;
 
                <b>switch</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d272f7765d709e8d" class="i property">Type</a>)
                {
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c8a6d8c18320e455" class="i field">Boolean</a>:
                        <span class="c">// Store &quot;true&quot;/&quot;false&quot; for booleans</span>
                        <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <a href="@1@System.Runtime/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@1@System.Runtime/A.html#b62ec9ce54fac5c3" class="i method">ToString</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>).<a href="@1@System.Runtime/A.html#2d51c212cb09178e" class="i method">ToLowerInvariant</a>(), <span class="r34 r">store</span>));
                        <b>break</b>;
 
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#0e13358490cfa651" class="i field">DateTime</a>:
                        <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> != <b>null</b>)
                        {
                            <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> <b>is</b> <a href="@1@System.Runtime/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>)
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="i">DateTools</span>.<span class="i">DateToString</span>(((<a href="@1@System.Runtime/A.html#68b4bb83ce8d1c31" class="t t">DateTimeOffset</a>)<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>).<a href="@1@System.Runtime/A.html#ae3e62dcd82c2422" class="i property">UtcDateTime</a>, <span class="i">DateTools</span>.<span class="i">Resolution</span>.<span class="i">SECOND</span>), <span class="r34 r">store</span>));
                            }
                            <b>else</b>
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="i">DateTools</span>.<span class="i">DateToString</span>(((<a href="@1@System.Runtime/A.html#df6b1eba7461813b" class="t t">DateTime</a>)<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>).<a href="@1@System.Runtime/A.html#fddce8be2da82dfc" class="i method">ToUniversalTime</a>(), <span class="i">DateTools</span>.<span class="i">Resolution</span>.<span class="i">SECOND</span>), <span class="r34 r">store</span>));
                            }
                        }
                        <b>else</b>
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                        }
                        <b>break</b>;
 
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#2e1f8a670eed04f2" class="i field">Integer</a>:
                        <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> != <b>null</b> &amp;&amp; <a href="@1@System.Runtime/A.html#225942ed7b7a3252" class="t t">Int32</a>.<a href="@1@System.Runtime/A.html#325507e509229dbc" class="i method">TryParse</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>.<a href="@1@System.Runtime/A.html#ff31a6bf27c58f89" class="i method">ToString</a>(), <b>out</b> <a href="@1@System.Runtime/A.html#225942ed7b7a3252" class="k">var</a> <span id="r35 rd" class="r35 r">value</span>))
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">Int32Field</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="r35 r">value</span>, <span class="r34 r">store</span>));
                        }
                        <b>else</b>
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                        }
 
                        <b>break</b>;
 
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c7a839b26b07bab2" class="i field">Number</a>:
                        <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> != <b>null</b>)
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">DoubleField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <a href="@1@System.Runtime/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@1@System.Runtime/A.html#7d707859ba5fa685" class="i method">ToDouble</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>), <span class="r34 r">store</span>));
                        }
                        <b>else</b>
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                        }
                        <b>break</b>;
 
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#5cbc07f133536426" class="i field">Text</a>:
                        <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> != <b>null</b> &amp;&amp; !<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="t t">String</a>.<a href="@1@System.Runtime/A.html#23a8597f842071f4" class="i method">IsNullOrEmpty</a>(<a href="@1@System.Runtime/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@1@System.Runtime/A.html#b62ec9ce54fac5c3" class="i method">ToString</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>)))
                        {
                            <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#882beac176560783" class="i property">Options</a>.<a href="@1@System.Runtime/A.html#9cd73f33d2df3074" class="i method">HasFlag</a>(<a href="/OrchardCore.Indexing.Abstractions/A.html#e5789b7e7e078077" class="t t">DocumentIndexOptions</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#533b5020a8ab2317" class="i field">Analyze</a>))
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">TextField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <a href="@1@System.Runtime/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@1@System.Runtime/A.html#b62ec9ce54fac5c3" class="i method">ToString</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>), <span class="r34 r">store</span>));
                            }
                            <b>else</b>
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <a href="@1@System.Runtime/A.html#fc990bd1275d43d6" class="t t">Convert</a>.<a href="@1@System.Runtime/A.html#b62ec9ce54fac5c3" class="i method">ToString</a>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a>), <span class="r34 r">store</span>));
                            }
                        }
                        <b>else</b>
                        {
                            <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#882beac176560783" class="i property">Options</a>.<a href="@1@System.Runtime/A.html#9cd73f33d2df3074" class="i method">HasFlag</a>(<a href="/OrchardCore.Indexing.Abstractions/A.html#e5789b7e7e078077" class="t t">DocumentIndexOptions</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#533b5020a8ab2317" class="i field">Analyze</a>))
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">TextField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                            }
                            <b>else</b>
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                            }
                        }
                        <b>break</b>;
 
                    <b>case</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#e50017e301ae5e3f" class="t t">Types</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#66ed4745e4a1498f" class="i field">GeoPoint</a>:
                        <b>var</b> <span id="r36 rd" class="r36 r">strategy</span> = <b>new</b> <span class="i">RecursivePrefixTreeStrategy</span>(<a href="#6609762d659e347f" class="i field">_grid</a>, <span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#c6197183de32776a" class="i property">Name</a>);
                        <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> != <b>null</b> &amp;&amp; <span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#d554987bb617733e" class="i property">Value</a> <b>is</b> <a href="/OrchardCore.Indexing.Abstractions/A.html#0cbc5b91325ef982" class="t t">DocumentIndex</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#67ea3a7fa0af3968" class="t t">GeoPoint</a> <span id="r37 rd" class="r37 r">point</span>)
                        {
                            <b>var</b> <span id="r38 rd" class="r38 r">geoPoint</span> = <a href="#851fba53acc95f12" class="i field">_ctx</a>.<span class="i">MakePoint</span>((<b>double</b>)<span class="r37 r">point</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#4e064a71940a2868" class="i field">Longitude</a>, (<b>double</b>)<span class="r37 r">point</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#08b54a8c41984369" class="i field">Latitude</a>);
                            <b>foreach</b> (<b>var</b> <span id="r39 rd" class="r39 r">field</span> <b>in</b> <span class="r36 r">strategy</span>.<span class="i">CreateIndexableFields</span>(<span class="r38 r">geoPoint</span>))
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<span class="r39 r">field</span>);
                            }
 
                            <b>if</b> (<span class="r33 r">entry</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#882beac176560783" class="i property">Options</a>.<a href="@1@System.Runtime/A.html#9cd73f33d2df3074" class="i method">HasFlag</a>(<a href="/OrchardCore.Indexing.Abstractions/A.html#e5789b7e7e078077" class="t t">DocumentIndexOptions</a>.<a href="/OrchardCore.Indexing.Abstractions/A.html#788561eec422f3c8" class="i field">Store</a>))
                            {
                                <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StoredField</span>(<span class="r36 r">strategy</span>.<span class="i">FieldName</span>, <span class="s">$&quot;</span>{<span class="r37 r">point</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#08b54a8c41984369" class="i field">Latitude</a>}<span class="s">,</span>{<span class="r37 r">point</span>.<a href="/OrchardCore.Indexing.Abstractions/A.html#4e064a71940a2868" class="i field">Longitude</a>}<span class="s">&quot;</span>));
                            }
                        }
                        <b>else</b>
                        {
                            <span class="r32 r">doc</span>.<span class="i">Add</span>(<b>new</b> <span class="i">StringField</span>(<span class="r36 r">strategy</span>.<span class="i">FieldName</span>, <span class="s">&quot;NULL&quot;</span>, <span class="r34 r">store</span>));
                        }
                        <b>break</b>;
                }
            }
 
            <b>return</b> <span class="r32 r">doc</span>;
        }
 
        <b>private</b> <span class="i">BaseDirectory</span> <a id="641ec86bf1626fa3" href="../R/641ec86bf1626fa3.html" target="n" data-glyph="76,1" class="i method">CreateDirectory</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r40 rd" class="r40 r">indexName</span>)
        {
            <b>lock</b> (<a href="#8e92d0a8267c60a3" class="k">this</a>)
            {
                <b>var</b> <span id="r41 rd" class="r41 r">path</span> = <b>new</b> <span class="t">DirectoryInfo</span>(<span class="i">PathExtensions</span>.<span class="i">Combine</span>(<a href="#618d05ef36962a79" class="i field">_rootPath</a>, <span class="r40 r">indexName</span>));
 
                <b>if</b> (!<span class="r41 r">path</span>.<span class="i property">Exists</span>)
                {
                    <span class="r41 r">path</span>.<span class="i method">Create</span>();
                }
 
                <span class="c">// Lucene is not thread safe on this call</span>
                <b>lock</b> (<a href="#908557af9744ce5b" class="i field">_synLock</a>)
                {
                    <b>return</b> <span class="i">FSDirectory</span>.<span class="i">Open</span>(<span class="r41 r">path</span>);
                }
            }
        }
 
        <b>private async</b> <a href="@1@System.Runtime/A.html#045a746eb48cbaa9" class="t t">Task</a> <a id="46950a1a9c7aeb41" href="../R/46950a1a9c7aeb41.html" target="n" data-glyph="76,1" class="i method">WriteAsync</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r42 rd" class="r42 r">indexName</span>, <a href="@1@System.Runtime/A.html#486d58da4553e12d" class="t t">Action</a>&lt;<span class="i">IndexWriter</span>&gt; <span id="r43 rd" class="r43 r">action</span>, <b>bool</b> <span id="r44 rd" class="r44 r">close</span> = <b>false</b>)
        {
            <b>if</b> (!<a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryGetValue</span>(<span class="r42 r">indexName</span>, <b>out</b> <a href="#632bcf09af487f3d" class="k">var</a> <span id="r45 rd" class="r45 r">writer</span>))
            {
                <a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">var</a> <span id="r46 rd" class="r46 r">indexAnalyzer</span> = <b>await</b> <a href="#c0fcc9e86cb46652" class="i field">_luceneIndexSettingsService</a>.<a href="LuceneIndexSettingsService.cs.html#8ac92214e16b9770" class="i method">LoadIndexAnalyzerAsync</a>(<span class="r42 r">indexName</span>);
                <b>lock</b> (<a href="#8e92d0a8267c60a3" class="k">this</a>)
                {
                    <b>if</b> (!<a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryGetValue</span>(<span class="r42 r">indexName</span>, <b>out</b> <span class="r45 r">writer</span>))
                    {
                        <b>var</b> <span id="r47 rd" class="r47 r">directory</span> = <a href="#641ec86bf1626fa3" class="i method">CreateDirectory</a>(<span class="r42 r">indexName</span>);
                        <b>var</b> <span id="r48 rd" class="r48 r">analyzer</span> = <a href="#c937ab9f5c2d796a" class="i field">_luceneAnalyzerManager</a>.<a href="LuceneAnalyzerManager.cs.html#8cf6eba5f6c703ca" class="i method">CreateAnalyzer</a>(<span class="r46 r">indexAnalyzer</span>);
                        <b>var</b> <span id="r49 rd" class="r49 r">config</span> = <b>new</b> <span class="i">IndexWriterConfig</span>(<a href="../Model/LuceneSettings.cs.html#47a5dc531ba41774" class="t t">LuceneSettings</a>.<a href="../Model/LuceneSettings.cs.html#c9b5330dfed002de" class="i field">DefaultVersion</a>, <span class="r48 r">analyzer</span>)
                        {
                            <span class="i">OpenMode</span> = <span class="i">OpenMode</span>.<span class="i">CREATE_OR_APPEND</span>,
                            <span class="i">WriteLockTimeout</span> = <span class="i">Lock</span>.<span class="i">LOCK_POLL_INTERVAL</span> * 3
                        };
 
                        <span class="r45 r">writer</span> = <b>new</b> <span class="t">IndexWriterWrapper</span>(<span class="r47 r">directory</span>, <span class="r49 r">config</span>);
 
                        <b>if</b> (<span class="r44 r">close</span>)
                        {
                            <span class="r43 r">action</span>?.<span class="i">Invoke</span>(<span class="r45 r">writer</span>);
                            <span class="r45 r">writer</span>.<span class="i">Dispose</span>();
                            <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>[<span class="r42 r">indexName</span>] = <a href="#648d9ad1e11f9300" class="i field">_clock</a>.<span class="i">UtcNow</span>;
                            <b>return</b>;
                        }
 
                        <a href="#668fe18c1279461a" class="i field">_writers</a>[<span class="r42 r">indexName</span>] = <span class="r45 r">writer</span>;
                    }
                }
            }
 
            <b>if</b> (<span class="r45 r">writer</span>.<a href="#be99bc021721354b" class="i property">IsClosing</a>)
            {
                <b>return</b>;
            }
 
            <span class="r43 r">action</span>?.<span class="i">Invoke</span>(<span class="r45 r">writer</span>);
 
            <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>[<span class="r42 r">indexName</span>] = <a href="#648d9ad1e11f9300" class="i field">_clock</a>.<span class="i">UtcNow</span>;
        }
 
        <b>private</b> <a href="#54a99b8e65fff028" class="t t">IndexReaderPool</a>.<a href="#b634dab5d7d3a497" class="t t">IndexReaderLease</a> <a id="03d753c246259782" href="../R/03d753c246259782.html" target="n" data-glyph="76,1" class="i method">GetReader</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r50 rd" class="r50 r">indexName</span>)
        {
            <a href="#54a99b8e65fff028" class="k">var</a> <span id="r51 rd" class="r51 r">pool</span> = <a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i">GetOrAdd</span>(<span class="r50 r">indexName</span>, <span id="r52 rd" class="r52 r">n</span> =&gt;
            {
                <b>var</b> <span id="r53 rd" class="r53 r">path</span> = <b>new</b> <span class="t">DirectoryInfo</span>(<span class="i">PathExtensions</span>.<span class="i">Combine</span>(<a href="#618d05ef36962a79" class="i field">_rootPath</a>, <span class="r50 r">indexName</span>));
                <b>var</b> <span id="r54 rd" class="r54 r">reader</span> = <span class="i">DirectoryReader</span>.<span class="i">Open</span>(<span class="i">FSDirectory</span>.<span class="i">Open</span>(<span class="r53 r">path</span>));
                <b>return</b> <b>new</b> <span class="t">IndexReaderPool</span>(<span class="r54 r">reader</span>);
            });
 
            <b>return</b> <span class="r51 r">pool</span>.<a href="#bb69cea1b54989e7" class="i method">Acquire</a>();
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases all readers and writers. This can be used after some time of innactivity to free resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="24722827ab0901a3" href="../R/24722827ab0901a3.html" target="n" data-glyph="72,1" class="i method">FreeReaderWriter</a>()
        {
            <b>lock</b> (<a href="#8e92d0a8267c60a3" class="k">this</a>)
            {
                <b>foreach</b> (<a href="@1@System.Runtime/A.html#8585965bb176a426" class="k">var</a> <span id="r55 rd" class="r55 r">writer</span> <b>in</b> <a href="#668fe18c1279461a" class="i field">_writers</a>)
                {
                    <b>if</b> (<a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">IsEnabled</span>(<span class="t t">LogLevel</span>.<span class="i field">Information</span>))
                    {
                        <a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">LogInformation</span>(<span class="s">&quot;Freeing writer for: &quot;</span> + <span class="r55 r">writer</span>.<a href="@1@System.Runtime/A.html#f9d1c04feb1af032" class="i property">Key</a>);
                    }
 
                    <span class="r55 r">writer</span>.<a href="@1@System.Runtime/A.html#38c0e86cc4b30170" class="i property">Value</a>.<a href="#be99bc021721354b" class="i property">IsClosing</a> = <b>true</b>;
                    <span class="r55 r">writer</span>.<a href="@1@System.Runtime/A.html#38c0e86cc4b30170" class="i property">Value</a>.<span class="i">Dispose</span>();
                }
 
                <b>foreach</b> (<a href="@1@System.Runtime/A.html#8585965bb176a426" class="k">var</a> <span id="r56 rd" class="r56 r">reader</span> <b>in</b> <a href="#1a7281b2277fcae4" class="i field">_indexPools</a>)
                {
                    <b>if</b> (<a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">IsEnabled</span>(<span class="t t">LogLevel</span>.<span class="i field">Information</span>))
                    {
                        <a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">LogInformation</span>(<span class="s">&quot;Freeing reader for: &quot;</span> + <span class="r56 r">reader</span>.<a href="@1@System.Runtime/A.html#f9d1c04feb1af032" class="i property">Key</a>);
                    }
 
                    <span class="r56 r">reader</span>.<a href="@1@System.Runtime/A.html#38c0e86cc4b30170" class="i property">Value</a>.<a href="#682e441f17182e09" class="i method">Dispose</a>();
                }
 
                <a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">Clear</span>();
                <a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i method">Clear</span>();
                <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>.<span class="i method">Clear</span>();
            }
        }
 
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;</span><span class="c">summary</span><span class="c">&gt;</span>
        <span class="c">///</span><span class="c"> Releases all readers and writers. This can be used after some time of innactivity to free resources.</span>
        <span class="c">///</span><span class="c"> </span><span class="c">&lt;/</span><span class="c">summary</span><span class="c">&gt;</span>
        <b>public void</b> <a id="3d92d4bc7cc9b83d" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="i method">FreeReaderWriter</a>(<a href="@1@System.Runtime/A.html#8281103e6f23cb5c" class="k">string</a> <span id="r57 rd" class="r57 r">indexName</span>)
        {
            <b>lock</b> (<a href="#8e92d0a8267c60a3" class="k">this</a>)
            {
                <b>if</b> (<a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryGetValue</span>(<span class="r57 r">indexName</span>, <b>out</b> <a href="#632bcf09af487f3d" class="k">var</a> <span id="r58 rd" class="r58 r">writer</span>))
                {
                    <b>if</b> (<a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">IsEnabled</span>(<span class="t t">LogLevel</span>.<span class="i field">Information</span>))
                    {
                        <a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">LogInformation</span>(<span class="s">&quot;Freeing writer for: &quot;</span> + <span class="r57 r">indexName</span>);
                    }
 
                    <span class="r58 r">writer</span>.<a href="#be99bc021721354b" class="i property">IsClosing</a> = <b>true</b>;
                    <span class="r58 r">writer</span>.<span class="i">Dispose</span>();
                }
 
                <b>if</b> (<a href="#1a7281b2277fcae4" class="i field">_indexPools</a>.<span class="i method">TryGetValue</span>(<span class="r57 r">indexName</span>, <b>out</b> <a href="#54a99b8e65fff028" class="k">var</a> <span id="r59 rd" class="r59 r">reader</span>))
                {
                    <b>if</b> (<a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">IsEnabled</span>(<span class="t t">LogLevel</span>.<span class="i field">Information</span>))
                    {
                        <a href="#e6dd6ed87d4cdcd2" class="i field">_logger</a>.<span class="i method">LogInformation</span>(<span class="s">&quot;Freeing reader for: &quot;</span> + <span class="r57 r">indexName</span>);
                    }
 
                    <span class="r59 r">reader</span>.<a href="#682e441f17182e09" class="i method">Dispose</a>();
                }
 
                <a href="#8b600fe65ef43eb1" class="i field">_timestamps</a>.<span class="i method">TryRemove</span>(<span class="r57 r">indexName</span>, <b>out _</b>);
 
                <a href="#668fe18c1279461a" class="i field">_writers</a>.<span class="i method">TryRemove</span>(<span class="r57 r">indexName</span>, <b>out _</b>);
            }
        }
 
        <b>public void</b> <a id="c1df12bf243f8051" href="../R/c1df12bf243f8051.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <b>if</b> (<a href="#25d090a2e8dba250" class="i field">_disposing</a>)
            {
                <b>return</b>;
            }
 
            <a href="#25d090a2e8dba250" class="i field">_disposing</a> = <b>true</b>;
 
            <a href="#24722827ab0901a3" class="i method">FreeReaderWriter</a>();
        }
 
        ~<a id="0fba55a4cf6965a4" href="../R/../../0000000000.html" target="n" data-glyph="75,1" class="t method">LuceneIndexManager</a>()
        {
            <a href="#c1df12bf243f8051" class="i method">Dispose</a>();
        }
    }
 
    <b>internal class</b> <a id="632bcf09af487f3d" href="../R/632bcf09af487f3d.html" target="n" data-glyph="2,0" class="t t">IndexWriterWrapper</a> : <span class="i">IndexWriter</span>
    {
        <b>public</b> <a id="e2f0d29166f23d12" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">IndexWriterWrapper</a>(<span class="i">LDirectory</span> <span id="r60 rd" class="r60 r">directory</span>, <span class="i">IndexWriterConfig</span> <span id="r61 rd" class="r61 r">config</span>) : <b>base</b>(<span class="r60 r">directory</span>, <span class="r61 r">config</span>)
        {
            <a href="#be99bc021721354b" class="i property">IsClosing</a> = <b>false</b>;
        }
 
        <b>public bool</b> <a id="be99bc021721354b" href="../R/be99bc021721354b.html" target="n" data-glyph="102,1" class="i property">IsClosing</a> { <b>get</b>; <b>set</b>; }
    }
 
    <b>internal class</b> <a id="54a99b8e65fff028" href="../R/54a99b8e65fff028.html" target="n" data-glyph="2,0" class="t t">IndexReaderPool</a> : <a href="@1@System.Runtime/A.html#1f55292c3174123d" class="t t">IDisposable</a>
    {
        <b>private bool</b> <a id="404d6f862ce31ce0" href="../R/404d6f862ce31ce0.html" target="n" data-glyph="46,1" class="i field">_dirty</a>;
        <b>private int</b> <a id="250521f631dfbe9e" href="../R/250521f631dfbe9e.html" target="n" data-glyph="46,1" class="i field">_count</a>;
        <b>private readonly</b> <span class="i">IndexReader</span> <a id="ce82a2cb5a8c1a26" href="../R/ce82a2cb5a8c1a26.html" target="n" data-glyph="46,1" class="i field">_reader</a>;
 
        <b>public</b> <a id="4468f5be77b1477a" href="../R/../../0000000000.html" target="n" data-glyph="72,1" class="t constructor">IndexReaderPool</a>(<span class="i">IndexReader</span> <span id="r62 rd" class="r62 r">reader</span>)
        {
            <a href="#ce82a2cb5a8c1a26" class="i field">_reader</a> = <span class="r62 r">reader</span>;
        }
 
        <b>public void</b> <a id="1055e70952eeecf1" href="../R/1055e70952eeecf1.html" target="n" data-glyph="72,1" class="i method">MakeDirty</a>()
        {
            <a href="#404d6f862ce31ce0" class="i field">_dirty</a> = <b>true</b>;
        }
 
        <b>public</b> <a href="#b634dab5d7d3a497" class="t t">IndexReaderLease</a> <a id="bb69cea1b54989e7" href="../R/bb69cea1b54989e7.html" target="n" data-glyph="72,1" class="i method">Acquire</a>()
        {
            <b>return</b> <b>new</b> <a href="#b100e0464c8f1ec7" class="t constructor">IndexReaderLease</a>(<a href="#54a99b8e65fff028" class="k">this</a>, <a href="#ce82a2cb5a8c1a26" class="i field">_reader</a>);
        }
 
        <b>public void</b> <a id="5bd68657f61de1bb" href="../R/5bd68657f61de1bb.html" target="n" data-glyph="72,1" class="i method">Release</a>()
        {
            <b>if</b> (<a href="#404d6f862ce31ce0" class="i field">_dirty</a> &amp;&amp; <a href="#250521f631dfbe9e" class="i field">_count</a> == 0)
            {
                <a href="#ce82a2cb5a8c1a26" class="i field">_reader</a>.<span class="i">Dispose</span>();
            }
        }
 
        <b>public void</b> <a id="682e441f17182e09" href="../R/682e441f17182e09.html" target="n" data-glyph="72,1" class="i method">Dispose</a>()
        {
            <a href="#ce82a2cb5a8c1a26" class="i field">_reader</a>.<span class="i">Dispose</span>();
        }
 
        <b>public struct</b> <a id="b634dab5d7d3a497" href="../R/b634dab5d7d3a497.html" target="n" data-glyph="108,1" class="t t"><span id="03c46ec5aea4d3c4">IndexReaderLease</span></a> : <a href="@1@System.Runtime/A.html#1f55292c3174123d" class="t t">IDisposable</a>
        {
            <b>private readonly</b> <a href="#54a99b8e65fff028" class="t t">IndexReaderPool</a> <a id="902e019dbf2d2d78" href="../R/902e019dbf2d2d78.html" target="n" data-glyph="46,2" class="i field">_pool</a>;
 
            <b>public</b> <a id="b100e0464c8f1ec7" href="../R/b100e0464c8f1ec7.html" target="n" data-glyph="72,2" class="t constructor">IndexReaderLease</a>(<a href="#54a99b8e65fff028" class="t t">IndexReaderPool</a> <span id="r63 rd" class="r63 r">pool</span>, <span class="i">IndexReader</span> <span id="r64 rd" class="r64 r">reader</span>)
            {
                <a href="#902e019dbf2d2d78" class="i field">_pool</a> = <span class="r63 r">pool</span>;
                <span class="t t">Interlocked</span>.<span class="i method">Increment</span>(<b>ref</b> <a href="#902e019dbf2d2d78" class="i field">_pool</a>.<a href="#250521f631dfbe9e" class="i field">_count</a>);
                <a href="#b2526cd0c7de114c" class="i property">IndexReader</a> = <span class="r64 r">reader</span>;
            }
 
            <b>public</b> <span class="i">IndexReader</span> <a id="b2526cd0c7de114c" href="../R/b2526cd0c7de114c.html" target="n" data-glyph="102,2" class="i property">IndexReader</a> { <b>get</b>; }
 
            <b>public void</b> <a id="31b0148c5d38ecb4" href="../R/31b0148c5d38ecb4.html" target="n" data-glyph="72,2" class="i method">Dispose</a>()
            {
                <span class="t t">Interlocked</span>.<span class="i method">Decrement</span>(<b>ref</b> <a href="#902e019dbf2d2d78" class="i field">_pool</a>.<a href="#250521f631dfbe9e" class="i field">_count</a>);
                <a href="#902e019dbf2d2d78" class="i field">_pool</a>.<a href="#5bd68657f61de1bb" class="i method">Release</a>();
            }
        }
    }
}
</pre></td></tr></table></div></body></html>
